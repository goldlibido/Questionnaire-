<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verified Profile – Le Libido</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #e1bf78;
      --white: #ffffff;
      --black: #000000;
    }

    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      color: var(--white);
      padding: 20px;
      background-color: #0d0d0d;
    }

    body.blue { background-color: #064D95; }
    body.green { background-color: #06954E; }
    body.red { background-color: #950606; }

    .header-banner {
      background-color: var(--gold);
      color: var(--black);
      font-weight: bold;
      font-size: 0.9rem;
      text-transform: uppercase;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
    }

    .progress-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.8rem;
      color: var(--white);
      font-weight: bold;
      background: conic-gradient(var(--gold) 0% 0%, rgba(255,255,255,0.15) 0% 100%);
    }

    .logo {
      max-width: 140px;
      margin: 20px auto;
      display: block;
    }

    .section-label {
      font-weight: bold;
      font-size: 1.2rem;
      margin: 30px 0 10px;
      padding-bottom: 6px;
      color: var(--gold);
    }

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .photo-upload {
      width: 100%;
      aspect-ratio: 1;
      background-color: rgba(255,255,255,0.1);
      border: 2px dashed var(--gold);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--gold);
      font-size: 0.8rem;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .photo-upload input { display: none; }
    .photo-upload .plus { font-size: 1.5rem; margin-bottom: 4px; }

    .photo-upload.required::after {
      content: "Required";
      font-size: 0.7rem;
      position: absolute;
      top: 6px;
      right: 6px;
      background-color: var(--gold);
      color: var(--black);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    .field {
      margin: 12px auto;
      font-size: 1rem;
      max-width: 500px;
      width: 100%;
    }

    .field label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }

    .field input, .field select {
      max-width: 100%;
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      color: var(--white);
      background-color: rgba(255,255,255,0.1);
    }

    .field select { appearance: none; }

    .divider {
      border-top: 1px solid rgba(255,255,255,0.15);
      margin: 30px 0 10px;
    }

    .locked { opacity: 0.5; pointer-events: none; }

    @media (min-width: 768px) {
      .photo-grid, .field {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
    }
  </style>
</head>
<body id="profileBody">

  <div class="header-banner">
    <div>Verified Mode</div>
    <div class="progress-circle" id="progressCircle">0%</div>
  </div>

  <img src="https://raw.githubusercontent.com/goldlibido/Questionnaire-/refs/heads/main/golden-le-libido-logo.png" alt="Le Libido Logo" class="logo"/>

  <div class="field" style="text-align: center;">
    <label for="bio">Flirty First Impression</label>
    <input type="text" id="bio" placeholder="e.g. Catch me before I change my mind…" />
  </div>

  <div class="section-label">Upload Photos</div>
  <div class="photo-grid" id="photoGrid">
    <label class="photo-upload required">
      <span class="plus">+</span>
      <span>Profile Pic</span>
      <input type="file" accept="image/*" onchange="handlePhotoUpload(event, 0)">
    </label>
    <label class="photo-upload"><span class="plus">+</span><input type="file" accept="image/*" onchange="handlePhotoUpload(event, 1)"></label>
    <label class="photo-upload"><span class="plus">+</span><input type="file" accept="image/*" onchange="handlePhotoUpload(event, 2)"></label>
    <label class="photo-upload"><span class="plus">+</span><input type="file" accept="image/*" onchange="handlePhotoUpload(event, 3)"></label>
    <label class="photo-upload"><span class="plus">+</span><input type="file" accept="image/*" onchange="handlePhotoUpload(event, 4)"></label>
    <label class="photo-upload"><span class="plus">+</span><input type="file" accept="image/*" onchange="handlePhotoUpload(event, 5)"></label>
  </div>

  <div class="section-label">Basic Info</div>

  <div class="field"><label for="name">Name</label><input type="text" id="name" placeholder="First & Last Name" /></div>
  <div class="field"><label for="age">Age</label><select id="age"><option disabled selected>Select your age</option></select></div>
  <div class="field"><label for="height">Height</label><select id="height"><option disabled selected>Select your height</option></select></div>
  <div class="field">
    <label for="orientation">Sexual Orientation</label>
    <select id="orientation">
      <option value="" disabled selected>Select your preference</option>
      <option value="Straight men">Man into Women</option>
      <option value="Straight women">Women into Men </option>
      <option value="Gay man">Man into men</option>
      <option value="Gay woman">Women into women</option>
      <option value="Bisexual man">Man into all</option>
      <option value="Bisexual woman">Women into all</option>
    </select>
  </div>

  <div class="divider"></div>
  <div class="section-label">Sexual Profile</div>

  <div class="field locked">
    <label>Your Sexual Archetype</label>
    <div id="archetypeName" style="font-weight: bold;">Mood Multiplier</div>
  </div>

  <div class="field" style="margin-top: 8px; text-align: center;">
    <a id="blueprintLink"
       target="_blank"
       style="display: inline-block; margin-top: 6px; color: var(--gold); font-weight: bold; text-decoration: underline;">
      → View Your Full Sexual Profile
    </a>
  </div>

  <div class="field">
    <label>Love Language</label>
    <select id="loveLanguage">
      <option value="" disabled selected>Select your preference</option>
      <option value="words">Words of affirmation</option>
      <option value="touch">Physical touch</option>
      <option value="time">Quality time</option>
      <option value="gifts">Gifts</option>
      <option value="acts">Acts of service</option>
    </select>
  </div>

  <div class="field">
    <label>Turn-On Vocabulary</label>
    <select id="turnOnVocab">
      <option value="" disabled selected>Select your preference</option>
      <option value="prefer">Prefer not to say</option>
      <option value="babe">Babe</option>
      <option value="baby">Baby</option>
      <option value="sexy">Sexy</option>
      <option value="fucker">Fucker</option>
      <option value="brat">Brat</option>
      <option value="good boy">Good boy</option>
      <option value="good girl">Good Girl</option>
      <option value="Goddess">Goddess</option>
      <option value="master">Master</option>
    </select>
  </div>

  <div class="field">
    <label>My Type (Looks)</label>
    <select id="tyle">
      <option value="" disabled selected>Select your preference</option>
      <option value="prefer">Prefer not to say</option>
      <option value="tall">Tall</option>
      <option value="short">Short</option>
      <option value="Thin">Thin & lean</option>
      <option value="curvy">Curvy & voluptuous</option>
      <option value="muscular">Muscular</option>
      <option value="tan">Tan</option>
      <option value="pale">Pale</option>
      <option value="brunette">Brunette</option>
      <option value="blonde">Blonde</option>
      <option value="latin">Latin</option>
      <option value="asian">Asian</option>
      <option value="black">Black</option>
      <option value="jewish">Jewish</option>
      <option value="indian">Indian</option>
      <option value="middle">Middle Eastern</option>
    </select>
  </div>

  <div class="field">
    <label>My Type (Personality)</label>
    <select id="tylePersonality">
      <option value="" disabled selected>Select your preference</option>
      <option value="prefer">Prefer not to say</option>
      <option value="confident">Confident & powerful</option>
      <option value="funny">Funny and witty</option>
      <option value="smart">Smart & sophisticated</option>
      <option value="flirty">Flirty & provocative</option>
      <option value="extroverted">Extroverted & friendly</option>
      <option value="introverted">Introverted & thoughtful</option>
      <option value="athletic">Athletic & sporty </option>
      <option value="organize">Organized & orderly</option>
      <option value="silly">Silly & goofy</option>
    </select>
  </div>
      
  <div class="field">
    <label>Fantasies</label>
    <select id="fantasies">
      <option value="" disabled selected>Select your preference</option>
      <option value="prefer">Prefer not to say</option>
      <option value="beach">Sex on the beach </option>
      <option value="bath">Candlelit bath with a partner</option>
      <option value="massage">Erotic massage</option>
      <option value="mile">Joining the Mile High Club</option>
      <option value="dipping">Skinny dipping </option>
      <option value="role-play">Role-play</option>
      <option value="bondage">Light bondage or restraints</option>
      <option value="sensory">Sensory play</option>
      <option value="impact">Impact play</option>
      <option value="hypnosis">Erotic hypnosis</option>
    </select>
  </div>

  <div class="field">
    <label>Looking For</label>
    <select id="lookingFor">
      <option value="" disabled selected>Select your preference</option>
      <option value="love">Love / Long-Term</option>
      <option value="good_time">Good Time / Casual</option>
      <option value="let_it_evolve">Let it evolve</option>
    </select>
  </div>
  <div class="field">
    <label>Open to Sugar Dynamic?</label>
    <select id="sugarDynamic">
      <option value="" disabled selected>Select your preference</option>
      <option value="yes">Yes</option>
      <option value="maybe">Maybe</option>
      <option value="no">No</option>
    </select>
  </div>

  <div class="field">
    <label>Open to Threesome?</label>
    <select id="threesome">
      <option value="" disabled selected>Select your preference</option>
      <option value="hell_yes">Hell yes, the more the merrier</option>
      <option value="maybe">Maybe, depends on the lighting and if anyone brought snacks</option>
      <option value="no">No thank you</option>
    </select>
  </div>

  <div class="divider"></div>
  <div class="section-label">Lifestyle</div>

  <div class="field"><label>Do you drink alcohol?</label><select id="drinks"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="field"><label>Do you smoke cigarettes/vape?</label><select id="smokes"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="field"><label>Do you smoke weed?</label><select id="weed"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="field"><label>Do you use drugs?</label><select id="drugs"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>

  <div class="divider"></div>
  <div class="section-label">Beliefs & Values</div>

  <div class="field"><label>Do you have children?</label><select id="hasKids"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="field"><label>Would you like to have children?</label><select id="wantsKids"><option value="" disabled selected>Select your preference</option><option value="yes">Yes</option><option value="no">No</option></select></div>
  <div class="field"><label for="job">Job Title</label><input type="text" id="job" placeholder="Enter job title" /></div>
  <div class="field"><label for="education">Education</label><input type="text" id="education" placeholder="School name" /></div>
  <div class="field">
    <label>Religion</label>
    <select id="religion">
      <option value="" disabled selected>Select your preference</option>
      <option value="atheist">Atheist</option>
      <option value="catholic">Catholic</option>
      <option value="christian">Christian</option>
      <option value="hindu">Hindu</option>
      <option value="islam">Islam</option>
      <option value="jewish">Jewish</option>
      <option value="other">Other</option>
    </select>
  </div>
  <div class="field">
    <label>Only show my religion to others with same religion?</label>
    <select id="showReligionMatchOnly">
      <option value="" disabled selected>Select your preference</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>
  </div>
  <div class="field">
    <label>Political Views</label>
    <select id="politics">
      <option value="" disabled selected>Select your preference</option>
      <option value="conservative">Conservative</option>
      <option value="liberal">Liberal</option>
      <option value="moderate">Moderate</option>
      <option value="not_political">Not political</option>
      <option value="prefer_not_to_say">Prefer not to say</option>
      <option value="other">Other</option>
    </select>
  </div>

  <div class="divider"></div>
  <div class="section-label">Notifications & Visibility</div>

  <div class="field">
    <label>Get notified when someone wants you?</label>
    <select id="notifyWantsYou">
      <option value="yes" selected>Yes</option>
      <option value="no">No</option>
    </select>
  </div>
  <div class="field">
    <label>Get notified when someone checks you out?</label>
    <select id="notifyChecksYouOut">
      <option value="yes" selected>Yes</option>
      <option value="no">No</option>
    </select>
  </div>
  <div class="field">
    <label>Allow messages from:</label>
    <select id="allowMessagesFrom">
      <option value="verified" selected>Verified Only</option>
      <option value="anonymous">Anonymous Only</option>
      <option value="both">Both</option>
    </select>
  </div>
  <div class="field">
    <label>Show profile to:</label>
    <select id="visibility">
      <option value="verified" selected>Verified Only</option>
      <option value="anonymous">Anonymous Only</option>
      <option value="both">Both</option>
    </select>
  </div>

  <div style="margin-top: 40px;">
    <button onclick="saveProfile()" style="
      background-color: #e1bf78;
      color: #000;
      font-size: 1.2rem;
      font-weight: bold;
      padding: 14px 32px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
    ">Save Profile</button>
  </div>

  <!-- Load backend FIRST so window.LibidoBackend is ready -->
  <script type="module" src="./le-libido-backend.js"></script>

  <!-- Main logic -->
  <script type="module">
    import { auth, storage } from './firebase-config.js';
    import { signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

    // 1) Lightweight session (anonymous auth) so rules allow writes
    signInAnonymously(auth).catch((e)=>console.error("Anonymous sign-in failed:", e));
    onAuthStateChanged(auth, (user)=>{ if (user) localStorage.setItem("uid", user.uid); });

    // 2) Archetype mapping + initial UI
    const slugToTitle = {
      "devoted_darling": "Devoted Darling",
      "mood_multiplier": "Mood Multiplier",
      "tender_protector": "Tender Protector",
      "heatwave": "Heatwave",
      "promiscuous_plaything": "Promiscuous Plaything",
      "generous_giver": "Generous Giver",
      "bedroom_adventurer": "Bedroom Adventurer",
      "charmer_in_charge": "Charmer in Charge",
      "punish_me": "Punish Me",
      "provoker": "Provoker",
      "dungeon_master": "Dungeon Master",
      "claimed_and_trained": "Claimed & Trained"
    };
    const formatSlug = (name) =>
      name === "Claimed & Trained" ? "claimed_and_trained" : name.toLowerCase().replace(/[^a-z0-9]+/g, "_");

    const roomMap = {
      "Tender Protector": "blue",
      "Devoted Darling": "blue",
      "Mood Multiplier": "blue",
      "Heatwave": "blue",
      "Promiscuous Plaything": "green",
      "Generous Giver": "green",
      "Bedroom Adventurer": "green",
      "Charmer in Charge": "green",
      "Dungeon Master": "red",
      "Provoker": "red",
      "Punish Me": "red",
      "Claimed & Trained": "red"
    };

    document.addEventListener("DOMContentLoaded", () => {
      const stored = (localStorage.getItem("archetype") || "mood_multiplier");
      const title = slugToTitle[stored] || stored;
      const color = roomMap[title] || window.LibidoBackend.archetypeToColor(title) || "blue";

      // Background color by archetype
      document.body.classList.add(color);

      // Title text
      const nameDiv = document.getElementById("archetypeName");
      if (nameDiv) nameDiv.textContent = title;

      // Blueprint link
      const blueprintLink = document.getElementById("blueprintLink");
      if (blueprintLink) blueprintLink.href = `/premium/erotic-blueprint_${formatSlug(title)}.html`;

      // Populate selects
      const ageSelect = document.getElementById("age");
      if (ageSelect && ageSelect.options.length === 1) {
        for (let i = 18; i <= 80; i++) {
          const opt = document.createElement("option");
          opt.value = i; opt.textContent = i; ageSelect.appendChild(opt);
        }
      }
      const heightSelect = document.getElementById("height");
      if (heightSelect && heightSelect.options.length === 1) {
        for (let ft = 4; ft <= 7; ft++) {
          for (let inch = 0; inch < 12; inch++) {
            if (ft === 7 && inch > 0) continue;
            const label = `${ft}'${inch}"`;
            const opt = document.createElement("option");
            opt.value = label; opt.textContent = label; heightSelect.appendChild(opt);
          }
        }
      }

      // Progress listeners
      attachProgressListeners();
      updateProgress();
    });

    // 3) Photo uploads (with progress)
    window.profilePhotoURLs = Array(6).fill(null);
    window.profilePhotoPaths = Array(6).fill(null);

    window.handlePhotoUpload = async function (event, index) {
      const file = event.target.files?.[0];
      if (!file) return;

      const tile = event.target.closest(".photo-upload");
      if (!tile) return;

      const objectURL = URL.createObjectURL(file);
      // Preview + progress bar
      tile.innerHTML = `
        <div style="position:relative;width:100%;height:100%;">
          <img src="${objectURL}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />
          <div class="upload-preview" style="position:absolute;left:0;right:0;bottom:0;height:10px;background:rgba(255,255,255,0.25);">
            <div id="bar-${index}" style="width:0%;height:100%;background:#e1bf78;"></div>
          </div>
        </div>
      `;

      try {
        const uid = localStorage.getItem("uid");
        const extRaw = (file.name.split('.').pop() || 'jpg').toLowerCase().replace(/[^a-z0-9]/g,'') || 'jpg';
        const safeExt = ['jpg','jpeg','png','webp','gif','heic','heif','bmp','tif','tiff'].includes(extRaw) ? extRaw : 'jpg';
        const path = `users/${uid}/photos/verified/${String(index)}.${safeExt}`;
        const ref = storageRef(storage, path);
        const task = uploadBytesResumable(ref, file, { contentType: file.type || `image/${safeExt}` });

        task.on('state_changed', (snap) => {
          const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
          const bar = document.getElementById(`bar-${index}`);
          if (bar) bar.style.width = pct + '%';
        });

        await new Promise((resolve, reject) => task.on('state_changed', null, reject, resolve));
        const url = await getDownloadURL(ref);

        window.profilePhotoURLs[index] = url;
        window.profilePhotoPaths[index] = path;

        tile.innerHTML = `
          <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />
          <button type="button" aria-label="Remove" title="Remove photo" style="position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,0.7);color:#fff;font-size:16px;cursor:pointer;">×</button>
        `;
        tile.style.position = "relative";

        const del = tile.querySelector('button');
        del.addEventListener('click', async (e) => {
          e.preventDefault();
          try { await deleteObject(storageRef(storage, window.profilePhotoPaths[index])); } catch(e){}
          window.profilePhotoURLs[index] = null;
          window.profilePhotoPaths[index] = null;
          tile.innerHTML = `
            <span class="plus">+</span>
            ${index === 0 ? "<span>Profile Pic</span>" : ""}
            <input type="file" accept="image/*" onchange="handlePhotoUpload(event, ${index})">
          `;
          if (index === 0) tile.classList.add("required");
          updateProgress();
        });

        if (index === 0) tile.classList.remove("required");
        updateProgress();
      } catch (err) {
        console.error("Upload failed:", err);
        alert("Upload failed. Please try another image.");
        tile.innerHTML = `
          <span class="plus">+</span>
          ${index === 0 ? "<span>Profile Pic</span>" : ""}
          <input type="file" accept="image/*" onchange="handlePhotoUpload(event, ${index})">
        `;
        if (index === 0) tile.classList.add("required");
      } finally {
        URL.revokeObjectURL(objectURL);
      }
    };

    // 4) Progress circle
    function attachProgressListeners(){
      const ids = [
        "bio","name","age","height","orientation","loveLanguage","turnOnVocab",
        "tyle","tylePersonality","fantasies","lookingFor","sugarDynamic","threesome",
        "drinks","smokes","weed","drugs","hasKids","wantsKids","job","education",
        "religion","showReligionMatchOnly","politics","notifyWantsYou","notifyChecksYouOut",
        "allowMessagesFrom","visibility"
      ];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.addEventListener("change", updateProgress);
        el.addEventListener("input", updateProgress);
      });
    }

    function isFilled(el){
      if (!el) return false;
      if (el.tagName === "SELECT") return !!el.value && el.value !== "";
      return !!el.value && el.value.trim() !== "";
    }

    function updateProgress(){
      const checklist = [
        isFilled(document.getElementById("bio")),
        !!(window.profilePhotoURLs && window.profilePhotoURLs[0]), // main photo
        isFilled(document.getElementById("name")),
        isFilled(document.getElementById("age")),
        isFilled(document.getElementById("height")),
        isFilled(document.getElementById("orientation")),
        isFilled(document.getElementById("loveLanguage")),
        isFilled(document.getElementById("turnOnVocab")),
        isFilled(document.getElementById("tyle")),
        isFilled(document.getElementById("tylePersonality")),
        isFilled(document.getElementById("fantasies")),
        isFilled(document.getElementById("lookingFor")),
        isFilled(document.getElementById("sugarDynamic")),
        isFilled(document.getElementById("threesome")),
        isFilled(document.getElementById("drinks")),
        isFilled(document.getElementById("smokes")),
        isFilled(document.getElementById("weed")),
        isFilled(document.getElementById("drugs")),
        isFilled(document.getElementById("hasKids")),
        isFilled(document.getElementById("wantsKids")),
        isFilled(document.getElementById("job")),
        isFilled(document.getElementById("education")),
        isFilled(document.getElementById("religion")),
        isFilled(document.getElementById("showReligionMatchOnly")),
        isFilled(document.getElementById("politics")),
        isFilled(document.getElementById("notifyWantsYou")),
        isFilled(document.getElementById("notifyChecksYouOut")),
        isFilled(document.getElementById("allowMessagesFrom")),
        isFilled(document.getElementById("visibility"))
      ];
      const total = checklist.length;
      const done = checklist.filter(Boolean).length;
      const pct = Math.round((done / total) * 100);

      const circle = document.getElementById("progressCircle");
      if (circle){
        circle.textContent = `${pct}%`;
        circle.style.background = `conic-gradient(var(--gold) 0% ${pct}%, rgba(255,255,255,0.15) ${pct}% 100%)`;
      }
    }

    // 5) Save profile → Firestore (/profiles/{uid}) & redirect
    window.saveProfile = async function () {
      try {
        const stored = (localStorage.getItem("archetype") || "mood_multiplier");
        const title  = slugToTitle[stored] || stored;
        const color  = window.LibidoBackend.archetypeToColor(title) || "blue";

        localStorage.setItem("profileMode", "verified");
        localStorage.setItem("archetypeColor", color);

        const data = {
          archetypeTitle: title,
          archetypeSlug: window.LibidoBackend.toSlug(title),
          archetypeColor: color,

          bio: document.getElementById("bio")?.value || "",
          name: document.getElementById("name")?.value || "",
          age: document.getElementById("age")?.value || "",
          height: document.getElementById("height")?.value || "",
          orientation: document.getElementById("orientation")?.value || "",
          loveLanguage: document.getElementById("loveLanguage")?.value || "",
          turnOnVocab: document.getElementById("turnOnVocab")?.value || "",
          typeLooks: document.getElementById("tyle")?.value || "",
          typePersonality: document.getElementById("tylePersonality")?.value || "",
          fantasies: document.getElementById("fantasies")?.value || "",
          lookingFor: document.getElementById("lookingFor")?.value || "",
          sugarDynamic: document.getElementById("sugarDynamic")?.value || "",
          threesome: document.getElementById("threesome")?.value || "",
          drinks: document.getElementById("drinks")?.value || "",
          smokes: document.getElementById("smokes")?.value || "",
          weed: document.getElementById("weed")?.value || "",
          drugs: document.getElementById("drugs")?.value || "",
          hasKids: document.getElementById("hasKids")?.value || "",
          wantsKids: document.getElementById("wantsKids")?.value || "",
          job: document.getElementById("job")?.value || "",
          education: document.getElementById("education")?.value || "",
          religion: document.getElementById("religion")?.value || "",
          showReligionMatchOnly: document.getElementById("showReligionMatchOnly")?.value || "",
          politics: document.getElementById("politics")?.value || "",
          notifyWantsYou: document.getElementById("notifyWantsYou")?.value || "yes",
          notifyChecksYouOut: document.getElementById("notifyChecksYouOut")?.value || "yes",
          allowMessagesFrom: document.getElementById("allowMessagesFrom")?.value || "verified",
          visibility: document.getElementById("visibility")?.value || "verified",

          photoURLs: (window.profilePhotoURLs || []).filter(Boolean),
          createdAt: Date.now()
        };

        await window.LibidoBackend.saveProfileToFirestore("verified", data);

        alert("Profile saved! Click Close to start dating!");
        window.location.href = '/secret-invite.html';
      } catch (e) {
        console.error(e);
        alert("Failed to save profile. Please try again.");
      }
    };
  </script>
  <!-- Backend first (must be a pure JS module file named le-libido-backend.js) -->
<script type="module" src="./le-libido-backend.js"></script>

<!-- Minimal DB + Storage wiring (keeps your UI/behavior intact) -->
<script type="module">
  import { auth, storage } from './firebase-config.js';
  import { signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { ref as storageRef, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js';

  // Give this browser a UID so your Firestore/Storage rules allow writes
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, (user) => { if (user) localStorage.setItem('uid', user.uid); });

  // -------------- PHOTOS → Firebase Storage --------------
  // Drop-in replacement for your existing handlePhotoUpload (same UI behavior)
  window.profilePhotoURLs = Array(6).fill(null);
  window.profilePhotoPaths = Array(6).fill(null);

  window.handlePhotoUpload = async function handlePhotoUpload(event, index) {
    const file = event.target.files?.[0];
    if (!file) return;

    const tile = event.target.closest(".photo-upload");
    if (!tile) return;

    const objectURL = URL.createObjectURL(file);
    // Show quick preview + simple progress bar
    tile.innerHTML = `
      <div style="position:relative;width:100%;height:100%;">
        <img src="${objectURL}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />
        <div style="position:absolute;left:0;right:0;bottom:0;height:8px;background:rgba(255,255,255,0.25);">
          <div id="bar-${index}" style="width:0%;height:100%;background:#e1bf78;"></div>
        </div>
      </div>
    `;

    try {
      const uid = localStorage.getItem("uid");
      if (!uid) throw new Error("No UID yet (auth not ready). Try again in a second.");

      const extRaw = (file.name.split('.').pop() || 'jpg').toLowerCase().replace(/[^a-z0-9]/g,'') || 'jpg';
      const safeExt = ['jpg','jpeg','png','webp','gif','heic','heif','bmp','tif','tiff'].includes(extRaw) ? extRaw : 'jpg';
      const path = `users/${uid}/photos/verified/${String(index)}.${safeExt}`;

      const ref = storageRef(storage, path);
      const task = uploadBytesResumable(ref, file, { contentType: file.type || `image/${safeExt}` });

      task.on('state_changed', (snap) => {
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        const bar = document.getElementById(`bar-${index}`);
        if (bar) bar.style.width = pct + '%';
      });

      await new Promise((resolve, reject) => task.on('state_changed', null, reject, resolve));
      const url = await getDownloadURL(ref);

      window.profilePhotoURLs[index] = url;
      window.profilePhotoPaths[index] = path;

      // Replace with uploaded image + delete button (same UX you had)
      tile.innerHTML = `
        <img src="${url}" style="width:100%;height:100%;object-fit:cover;border-radius:6px;" />
        <button type="button" aria-label="Remove" title="Remove photo" style="position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,0.7);color:#fff;font-size:16px;cursor:pointer;">×</button>
      `;
      tile.style.position = "relative";
      if (index === 0) tile.classList.remove("required");

      const del = tile.querySelector('button');
      del.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await deleteObject(storageRef(storage, window.profilePhotoPaths[index])); } catch(e){}
        window.profilePhotoURLs[index] = null;
        window.profilePhotoPaths[index] = null;
        tile.innerHTML = `
          <span class="plus">+</span>
          ${index === 0 ? "<span>Profile Pic</span>" : ""}
          <input type="file" accept="image/*" onchange="handlePhotoUpload(event, ${index})">
        `;
        if (index === 0) tile.classList.add("required");
      });

    } catch (err) {
      console.error(err);
      alert("Upload failed. Please try again.");
      tile.innerHTML = `
        <span class="plus">+</span>
        ${index === 0 ? "<span>Profile Pic</span>" : ""}
        <input type="file" accept="image/*" onchange="handlePhotoUpload(event, ${index})">
      `;
      if (index === 0) tile.classList.add("required");
    } finally {
      URL.revokeObjectURL(objectURL);
    }
  };

  // -------------- SAVE → Firestore (/profiles/{uid}) --------------
  // Minimal saver that keeps your page flow and only adds DB write + redirect.
  window.saveProfile = async function saveProfile() {
    try {
      // Read archetype as displayed on page to avoid slug/title confusion
      const archetypeTitle = (document.getElementById("archetypeName")?.textContent || "").trim();
      // Derive color via backend helper (falls back to "blue")
      const archetypeColor = (window.LibidoBackend?.archetypeToColor(archetypeTitle)) || "blue";

      // Persist for secret-invite doors
      localStorage.setItem("profileMode", "verified");
      localStorage.setItem("archetypeColor", archetypeColor);

      const data = {
        archetypeTitle,
        archetypeSlug: window.LibidoBackend?.toSlug(archetypeTitle) || "",
        archetypeColor,

        bio: document.getElementById("bio")?.value || "",
        name: document.getElementById("name")?.value || "",
        age: document.getElementById("age")?.value || "",
        height: document.getElementById("height")?.value || "",
        orientation: document.getElementById("orientation")?.value || "",
        loveLanguage: document.getElementById("loveLanguage")?.value || "",
        turnOnVocab: document.getElementById("turnOnVocab")?.value || "",
        typeLooks: document.getElementById("tyle")?.value || "",
        typePersonality: document.getElementById("tylePersonality")?.value || "",
        fantasies: document.getElementById("fantasies")?.value || "",
        lookingFor: document.getElementById("lookingFor")?.value || "",
        sugarDynamic: document.getElementById("sugarDynamic")?.value || "",
        threesome: document.getElementById("threesome")?.value || "",
        drinks: document.getElementById("drinks")?.value || "",
        smokes: document.getElementById("smokes")?.value || "",
        weed: document.getElementById("weed")?.value || "",
        drugs: document.getElementById("drugs")?.value || "",
        hasKids: document.getElementById("hasKids")?.value || "",
        wantsKids: document.getElementById("wantsKids")?.value || "",
        job: document.getElementById("job")?.value || "",
        education: document.getElementById("education")?.value || "",
        religion: document.getElementById("religion")?.value || "",
        showReligionMatchOnly: document.getElementById("showReligionMatchOnly")?.value || "",
        politics: document.getElementById("politics")?.value || "",
        notifyWantsYou: document.getElementById("notifyWantsYou")?.value || "yes",
        notifyChecksYouOut: document.getElementById("notifyChecksYouOut")?.value || "yes",
        allowMessagesFrom: document.getElementById("allowMessagesFrom")?.value || "verified",
        visibility: document.getElementById("visibility")?.value || "verified",

        photoURLs: (window.profilePhotoURLs || []).filter(Boolean),
        createdAt: Date.now()
      };

      // Save through your backend module (lifetime profiles)
      await window.LibidoBackend.saveProfileToFirestore("verified", data);

      alert("Profile saved! Click Close to start dating!");
      // Your requested redirect:
      window.location.href = '/secret-invite.html';
    } catch (e) {
      console.error(e);
      alert("Failed to save profile. Please try again.");
    }
  };
</script>
</body>
</html>
