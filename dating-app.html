<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Le Libido ‚Äì Dating Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --gold: #e1bf78;
      --red: #950606;
      --blue: #064D95;
      --green: #06954E;
      --black: #0d0d0d;
    }

    body {
      margin: 0;
      padding: 30px 20px;
      background-color: var(--black);
      color: white;
      font-family: 'Montserrat', sans-serif;
    }

    h1 {
      color: var(--gold);
      font-size: 2rem;
      text-align: center;
      margin-bottom: 30px;
    }

    .venue-card {
      background-color: #111;
      border-bottom: 1px solid var(--gold);
      padding: 16px;
      margin-bottom: 10px;
    }

    .venue-thumbnail {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 10px;
    }

    .venue-info {
      display: flex;
      align-items: center;
    }

    button {
      background-color: var(--gold);
      color: black;
      font-weight: bold;
      border: none;
      padding: 10px 20px;
      margin-top: 8px;
      border-radius: 8px;
      cursor: pointer;
    }

    .dater-container {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .dater-container {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <h1>Who's Out Tonight?</h1>

  <label for="venueTypeFilter" style="color: var(--gold); font-weight: bold;">Filter by Venue Type:</label>
  <select id="venueTypeFilter" onchange="filterVenues()" style="padding: 10px; margin-bottom: 20px;">
    <option value="all">All</option>
    <option value="restaurant">üç¥ Restaurants</option>
    <option value="bar">üç∏ Bars</option>
    <option value="cafe">‚òï Caf√©s</option>
    <option value="ice_cream">üç¶ Ice Cream</option>
  </select>

  <div id="venueList"></div>
    <!-- Firebase & Google Maps API Initialization -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAA9haAkwA4_LvJ9qpuG9Q_YsO7S_o_4Hs&libraries=places,geometry"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBN0wDQhL2xZbFwq1gxw8VXeddVG2Gwh34",
      authDomain: "le-libido-mvp.firebaseapp.com",
      projectId: "le-libido-mvp",
      storageBucket: "le-libido-mvp.appspot.com",
      messagingSenderId: "131616941592",
      appId: "1:131616941592:web:e8773a0951f7b86c1a056d",
      measurementId: "G-8C9DXQ4M6T"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    const venueList = document.getElementById('venueList');
    let lastCheckIn = null;

    window.onload = function () {
      navigator.geolocation.getCurrentPosition((position) => {
        const userLocation = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        fetchNearbyVenues(userLocation);
      });
    };

    function fetchNearbyVenues(location) {
      const service = new google.maps.places.PlacesService(document.createElement('div'));
      const request = {
        location: new google.maps.LatLng(location.lat, location.lng),
        radius: 500,
        type: ['restaurant', 'bar', 'ice_cream']
      };

      service.nearbySearch(request, async (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          results.sort((a, b) =>
            google.maps.geometry.spherical.computeDistanceBetween(
              new google.maps.LatLng(location.lat, location.lng), a.geometry.location
            ) -
            google.maps.geometry.spherical.computeDistanceBetween(
              new google.maps.LatLng(location.lat, location.lng), b.geometry.location
            )
          );

          venueList.innerHTML = '';

          for (const venue of results) {
            const distance = google.maps.geometry.spherical.computeDistanceBetween(
              new google.maps.LatLng(location.lat, location.lng), venue.geometry.location
            );

            const isWithinRadius = distance <= 23;
            const emoji = venue.types.includes("restaurant") ? "üç¥"
                        : venue.types.includes("bar") ? "üç∏"
                        : venue.types.includes("ice_cream") ? "üç¶"
                        : "üìç";

            const thumbnail = venue.photos && venue.photos.length
              ? venue.photos[0].getUrl({ maxWidth: 100, maxHeight: 100 })
              : "https://via.placeholder.com/100";

            const card = document.createElement('div');
            card.classList.add("venue-card");
            card.dataset.venuetype = venue.types[0];
            card.innerHTML = `
              <div class="venue-header">
                <img src="${thumbnail}" alt="${venue.name}" />
                <div class="venue-name">${emoji} ${venue.name}</div>
              </div>
              <p>Distance: ${Math.round(distance)}m</p>
              <button class="checkin-btn" onclick="checkIn('${venue.place_id}', ${isWithinRadius})">
                ${isWithinRadius ? "‚úÖ You are here" : "Check In"}
              </button>
              <div id="users-${venue.place_id}" class="dater-container"></div>
            `;

            venueList.appendChild(card);
          }
        }
      });
    }
        function checkIn(placeId, isWithinRadius) {
      const now = new Date().getTime();

      if (!isWithinRadius) {
        alert("üìç You must physically be at the venue to check in.");
        return;
      }

      if (lastCheckIn && now - lastCheckIn < 10 * 60 * 1000) {
        alert("‚è≥ You can only check in once every 10 minutes.");
        return;
      }

      lastCheckIn = now;

      const user = auth.currentUser;
      if (!user) {
        alert("üîí Please sign in to check in.");
        return;
      }

      db.collection("checkins").add({
        userId: user.uid,
        venueId: placeId,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      alert("‚úÖ Checked in!");
    }

    function filterVenuesByType() {
      const filter = document.getElementById("venueFilter").value;
      const allVenues = document.querySelectorAll(".venue-card");

      allVenues.forEach(card => {
        const type = card.dataset.venuetype;
        if (filter === "all" || type === filter) {
          card.style.display = "block";
        } else {
          card.style.display = "none";
        }
      });
    }

    async function loadDatersForVenue(venueId, containerId) {
      const snapshot = await db.collection("checkins")
        .where("venueId", "==", venueId)
        .orderBy("timestamp", "desc")
        .limit(20)
        .get();

      const users = [];
      for (const doc of snapshot.docs) {
        const checkin = doc.data();
        const userDoc = await db.collection("users").doc(checkin.userId).get();
        if (userDoc.exists) {
          users.push(userDoc.data());
        }
      }

      const container = document.getElementById(containerId);
      container.innerHTML = "";

      users.forEach((user, index) => {
        const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : "";
        const color = getColorForArchetype(user.archetype);
        const card = document.createElement("div");
        card.style.background = color;
        card.style.padding = "10px";
        card.style.borderRadius = "10px";
        card.style.marginTop = "10px";
        card.style.cursor = "pointer";
        card.style.color = "white";

        card.innerHTML = `
          <img src="${user.photoURL || 'https://via.placeholder.com/80'}" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px;" />
          <div><strong>${medal} ${user.name || "Anonymous"}, ${user.age || "--"}</strong></div>
          <div>${user.archetype || "Mystery Type"}</div>
          <div style="font-style: italic; font-size: 0.9rem;">"${user.firstImpression || 'No intro yet.'}"</div>
        `;

        card.onclick = () => {
          alert(`Open full profile for ${user.name || "this user"}`);
        };

        container.appendChild(card);
      });
    }

    function getColorForArchetype(archetype) {
      const map = {
        "Tender Protector": "#064D95",
        "Mood Multiplier": "#064D95",
        "Heatwave": "#064D95",
        "Promiscuous Plaything": "#06954E",
        "Generous Giver": "#06954E",
        "Bedroom Adventurer": "#06954E",
        "Charmer in Charge": "#950606",
        "Punish Me": "#950606",
        "Provoker": "#950606",
        "Dungeon Master": "#950606",
        "Claimed & Trained": "#950606",
        "Devoted Darling": "#064D95"
      };
      return map[archetype] || "#222";
    }

    const observer = new MutationObserver(() => {
      document.querySelectorAll('[id^="users-"]').forEach(el => {
        const venueId = el.id.replace("users-", "");
        loadDatersForVenue(venueId, el.id);
      });
    });

    observer.observe(document.getElementById('venueList'), { childList: true });
  </script>
    <style>
    #venueList {
      display: flex;
      flex-direction: column;
      gap: 30px;
      margin-top: 30px;
    }

    .venue-card {
      background-color: #0d0d0d;
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 16px;
    }

    .venue-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 10px;
    }

    .venue-header img {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
    }

    .venue-name {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--gold);
    }

    .checkin-btn {
      margin-top: 8px;
      padding: 10px 20px;
      background-color: var(--gold);
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .checkin-btn:hover {
      transform: scale(1.05);
    }

    .dater-container {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    @media (min-width: 768px) {
      .dater-container {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }

    #controls {
      margin-top: 20px;
      text-align: center;
    }

    #venueTypeFilter {
      padding: 8px;
      border-radius: 6px;
      font-family: Montserrat;
    }
  </style>

  <div id="controls">
    <label for="venueTypeFilter" style="color: var(--gold); font-weight: 600;">Filter by Venue Type:</label>
    <select id="venueTypeFilter" onchange="filterVenues()">
      <option value="all">All</option>
      <option value="restaurant">üç¥ Restaurants</option>
      <option value="bar">üç∏ Bars</option>
      <option value="cafe">‚òï Caf√©s</option>
      <option value="icecream">üç¶ Ice Cream</option>
    </select>
  </div>
</body>
</html>

<script>
  // VENUE TYPE FILTER
  function filterVenues() {
    const selected = document.getElementById("venueTypeFilter").value;
    const allVenues = document.querySelectorAll(".venue-card");
    allVenues.forEach(card => {
      const type = card.dataset.venuetype;
      if (selected === "all" || selected === type) {
        card.style.display = "block";
      } else {
        card.style.display = "none";
      }
    });
  }

  // COOLDOWN CHECK (10 MIN)
  function canCheckIn() {
    const lastCheckIn = localStorage.getItem("lastCheckInTime");
    const now = Date.now();
    if (!lastCheckIn || now - parseInt(lastCheckIn) > 10 * 60 * 1000) {
      localStorage.setItem("lastCheckInTime", now.toString());
      return true;
    }
    return false;
  }

  // FULL PROFILE MODAL LOGIC
  function openProfileModal(profileHTML) {
    document.getElementById("fullProfileInner").innerHTML = profileHTML;
    document.getElementById("profileModal").style.display = "flex";
  }
  function closeModal() {
    document.getElementById("profileModal").style.display = "none";
  }

  // VISIBILITY CHECK
  function shouldShowToViewer(viewerPrefs, targetPrefs) {
    // Simplified example: show everyone for now
    return true;
  }

  // ARCHETYPE COLOR
  function getArchetypeColor(archetype) {
    const lower = archetype.toLowerCase();
    if (lower.includes("protector") || lower.includes("darling")) return "archetype-blue";
    if (lower.includes("giver") || lower.includes("adventurer")) return "archetype-green";
    if (lower.includes("master") || lower.includes("punish")) return "archetype-red";
    return "archetype-blue";
  }

  // RENDER FULL PROFILE VIEW
  function renderFullProfile(dater) {
    const medal = getMedalIcon(dater.compatibilityRank);
    const chocolate = dater.sugarDynamic ? "üç´" : "";
    const permit = dater.prefersToBeApproached ? "Permit to Approach" : "Approach";

    return `
      <h2>${dater.name}, ${dater.age} ${medal}</h2>
      <p><strong>Sexual Archetype:</strong> ${dater.archetype}</p>
      <p><strong>Flirty First Impression:</strong> ${dater.firstImpression}</p>
      <p><strong>Looking For:</strong> ${dater.lookingFor}</p>
      <p><strong>Enjoys:</strong> ${dater.enjoys}</p>
      <p><strong>Dirty Talk Style:</strong> ${dater.dirtyTalk}</p>
      <p><strong>Sugar Dynamic:</strong> ${chocolate}</p>
      <button onclick="alert('${permit} sent!')" style="margin-top:15px; padding:8px 14px; font-weight:bold;">${permit}</button>
    `;
  }

  // MEDAL SYSTEM FOR TOP MATCHES
  function getMedalIcon(rank) {
    if (rank === 1) return "ü•á";
    if (rank === 2) return "ü•à";
    if (rank === 3) return "ü•â";
    return "";
  }
</script>

.archetype-red { border-left: 6px solid #950606; }
.archetype-green { border-left: 6px solid #06954E; }
.archetype-blue { border-left: 6px solid #064D95; }

#profileModal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0, 0, 0, 0.85);
  z-index: 9999;
  justify-content: center;
  align-items: center;
  padding: 40px;
}
#profileContent {
  background: black;
  padding: 30px;
  border: 4px solid var(--gold);
  border-radius: 12px;
  max-width: 600px;
  width: 90%;
  color: white;
}

<div id="profileModal">
  <div id="profileContent">
    <button onclick="closeModal()" style="float:right; font-weight:bold; font-size:18px; background:none; color:white; border:none;">‚úï</button>
    <div id="fullProfileInner"></div>
  </div>
</div>

<style>
  .archetype-red { border-left: 6px solid #950606; }
  .archetype-green { border-left: 6px solid #06954E; }
  .archetype-blue { border-left: 6px solid #064D95; }

  #profileModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }

  #profileContent {
    background: black;
    padding: 30px;
    border: 4px solid var(--gold);
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    color: white;
    position: relative;
  }

  #profileContent button.close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    color: white;
    border: none;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
  }
</style>

<div id="profileModal">
  <div id="profileContent">
    <button class="close-btn" onclick="closeModal()">‚úï</button>
    <div id="fullProfileInner"></div>
  </div>
</div>
<style>
  .archetype-red { border-left: 6px solid #950606; }
  .archetype-green { border-left: 6px solid #06954E; }
  .archetype-blue { border-left: 6px solid #064D95; }

  #profileModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    padding: 40px;
  }

  #profileContent {
    background: black;
    padding: 30px;
    border: 4px solid var(--gold);
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    color: white;
    position: relative;
  }

  #profileContent button.close {
    position: absolute;
    top: 12px;
    right: 12px;
    background: none;
    color: white;
    font-size: 22px;
    border: none;
    cursor: pointer;
  }
</style>

<div id="profileModal">
  <div id="profileContent">
    <button class="close" onclick="closeModal()">‚úï</button>
    <div id="fullProfileInner"></div>
  </div>
</div>

<script>
  // VENUE FILTER
  function filterVenues() {
    const selected = document.getElementById("venueTypeFilter").value;
    const allVenues = document.querySelectorAll(".venue-card");
    allVenues.forEach(card => {
      const type = card.dataset.venuetype;
      card.style.display = (selected === "all" || selected === type) ? "block" : "none";
    });
  }

  // CHECK-IN COOLDOWN
  function canCheckIn() {
    const lastCheckIn = localStorage.getItem("lastCheckInTime");
    const now = Date.now();
    if (!lastCheckIn || now - parseInt(lastCheckIn) > 10 * 60 * 1000) {
      localStorage.setItem("lastCheckInTime", now.toString());
      return true;
    }
    return false;
  }

  // FULL PROFILE MODAL
  function openProfileModal(profileHTML) {
    document.getElementById("fullProfileInner").innerHTML = profileHTML;
    document.getElementById("profileModal").style.display = "flex";
  }

  function closeModal() {
    document.getElementById("profileModal").style.display = "none";
  }

  // RENDER FULL PROFILE
  function renderFullProfile(dater) {
    const medal = getMedalIcon(dater.compatibilityRank);
    const chocolate = dater.sugarDynamic ? "üç´" : "";
    const permit = dater.prefersToBeApproached ? "Permit to Approach" : "Approach";

    return `
      <h2>${dater.name}, ${dater.age} ${medal}</h2>
      <p><strong>Sexual Archetype:</strong> ${dater.archetype}</p>
      <p><strong>Flirty First Impression:</strong> ${dater.firstImpression}</p>
      <p><strong>Looking For:</strong> ${dater.lookingFor}</p>
      <p><strong>Enjoys:</strong> ${dater.enjoys}</p>
      <p><strong>Dirty Talk Style:</strong> ${dater.dirtyTalk}</p>
      <p><strong>Sugar Dynamic:</strong> ${chocolate}</p>
      <button onclick="alert('${permit} sent!')" style="margin-top:15px; padding:8px 14px; font-weight:bold;">${permit}</button>
    `;
  }

  // MEDAL LOGIC
  function getMedalIcon(rank) {
    if (rank === 1) return "ü•á";
    if (rank === 2) return "ü•à";
    if (rank === 3) return "ü•â";
    return "";
  }
</script>
