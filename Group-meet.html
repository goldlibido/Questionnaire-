<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Le Libido — Group Meet Tonight</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#e1bf78; --blue:#064D95; --green:#06954E; --red:#950606; --bg:#0d0d0d;
    --edge:#1f2024; --muted:#b9b9b9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:#fff;font-family:Montserrat,system-ui,sans-serif;display:flex;align-items:center;justify-content:center}
  .card{
    width:min(720px,92vw); padding:20px; border:1px solid var(--edge); border-radius:18px;
    background:linear-gradient(180deg,#111214,#0b0c0e); box-shadow:0 24px 60px rgba(0,0,0,.55)
  }
  header{display:flex;gap:12px;align-items:center;margin-bottom:14px}
  .logo{width:48px;height:48px;border-radius:12px;background:radial-gradient(circle at 30% 30%,var(--gold),#4f3d16 60%);}
  h1{margin:0;font-size:22px;font-weight:800;letter-spacing:.2px;text-shadow:0 0 8px rgba(225,191,120,.12)}
  .sub{color:var(--muted);font-size:13px;margin-top:2px}
  .cta{display:flex;gap:10px;align-items:center;margin:14px 0 10px;flex-wrap:wrap}
  button{
    border:none;border-radius:12px;padding:14px 16px;font-weight:800;cursor:pointer;letter-spacing:.3px;
    box-shadow:0 8px 24px rgba(0,0,0,.35);transition:transform .06s ease, box-shadow .2s ease, background .2s ease
  }
  button:hover{transform:translateY(-1px)}
  .primary{background:var(--gold);color:#000}
  .ghost{background:transparent;border:1px solid #2a2c31;color:#cfd0d2}
  .danger{background:#241416;border:1px solid #3a1d22}
  .status{margin-top:6px;font-size:12px;color:#cfd0d2}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}
  .red{background:var(--red)} .blue{background:var(--blue)} .green{background:var(--green)} .gold{background:var(--gold)}
  textarea{
    width:100%;min-height:88px;background:#0c0d10;border:1px solid #232429;border-radius:12px;color:#e9eaec;
    font-family:ui-monospace,Menlo,Consolas,monospace;padding:10px;resize:vertical
  }
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  audio{width:100%;background:#0b0c0e;border:1px solid #232429;border-radius:12px;margin-top:10px}
  .hint{color:#a7a9ad;font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <div class="card">
    <header>
      <div class="logo"></div>
      <div>
        <h1>Group Meet Tonight</h1>
        <div class="sub">One tap to connect your squad with another. Anonymous · Audio only · No accounts.</div>
      </div>
    </header>

    <div class="cta">
      <button id="meetBtn" class="primary">Meet Another Group Now</button>
      <button id="muteBtn" class="ghost" disabled>Mute</button>
      <button id="endBtn" class="danger" disabled>End</button>
    </div>

    <div id="status" class="status"><span class="dot red"></span>Not connected</div>

    <div id="codes" style="margin-top:10px;display:none">
      <label class="hint">If needed, you can manually copy your code here:</label>
      <textarea id="codeBox" readonly></textarea>
    </div>

    <audio id="remoteAudio" autoplay playsinline controls></audio>

    <div class="hint">
      Tip: If you’re the first group, your <b>Invite Code</b> is auto-copied. Share it via iMessage/DM.  
      If you received an invite, press the button and you’ll be prompted to paste it.  
      (This works without any server; WebRTC needs a tiny code exchange once.)
    </div>
  </div>

<script>
(async function(){
  const meetBtn = document.getElementById('meetBtn');
  const muteBtn = document.getElementById('muteBtn');
  const endBtn  = document.getElementById('endBtn');
  const statusEl= document.getElementById('status');
  const codeBox = document.getElementById('codeBox');
  const codesWrap = document.getElementById('codes');
  const remoteAudio = document.getElementById('remoteAudio');

  let pc=null, localStream=null, isMuted=false;

  function setStatus(text, color){
    statusEl.innerHTML = '<span class="dot '+color+'"></span>'+text;
  }

  function waitForIceComplete(pc, timeoutMs=5000){
    return new Promise(resolve=>{
      if (pc.iceGatheringState === 'complete') return resolve();
      const onChange=()=>{ if (pc.iceGatheringState==='complete'){ cleanup(); resolve(); } };
      const timer=setTimeout(()=>{ cleanup(); resolve(); }, timeoutMs);
      const cleanup=()=>{ pc.removeEventListener('icegatheringstatechange', onChange); clearTimeout(timer); };
      pc.addEventListener('icegatheringstatechange', onChange);
    });
  }

  async function enableMic(){
    if (localStream) return;
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ audio:true, video:false });
      muteBtn.disabled = false; endBtn.disabled = false;
    }catch(e){
      alert('Microphone permission needed to talk.');
      throw e;
    }
  }

  function newPeer(){
    if (pc){ try{pc.close()}catch{}; pc=null; }
    const rtc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
    if (localStream) rtc.addTrack(localStream.getAudioTracks()[0], localStream);
    rtc.ontrack = (ev)=>{ remoteAudio.srcObject = ev.streams[0]; remoteAudio.play().catch(()=>{}); };
    rtc.onconnectionstatechange = ()=>{
      const s = rtc.connectionState;
      if (s==='connected'){ setStatus('Connected','green'); }
      if (s==='disconnected' || s==='failed' || s==='closed'){ setStatus('Disconnected','red'); }
    };
    return (pc=rtc);
  }

  function b64(obj){ return btoa(JSON.stringify(obj)); }
  function unb64(txt){ return JSON.parse(atob(txt)); }

  async function maybeReadClipboard(){
    try{
      const txt = await navigator.clipboard.readText();
      if (!txt) return null;
      try{
        const o = unb64(txt);
        if (o && o.type === 'offer') return txt;
      }catch{}
    }catch{}
    return null;
  }

  async function copyToClipboard(text){
    try{ await navigator.clipboard.writeText(text); }catch{
      // show box if clipboard failed
      codesWrap.style.display = 'block';
      codeBox.value = text;
      codeBox.readOnly = false; // allow manual select if needed
      codeBox.select();
    }
  }

  async function meetNow(){
    meetBtn.disabled = true;
    await enableMic();
    const clipOffer = await maybeReadClipboard();
    if (clipOffer){
      // You already have an Offer in clipboard → act as answerer
      const theirOfferB64 = prompt("Paste the Invite Code you received:", clipOffer) || clipOffer;
      await answerFlow(theirOfferB64);
    } else {
      // You are the first group → create offer, copy to clipboard, then ask for return code
      await offerFlow();
    }
  }

  async function offerFlow(){
    const pc = newPeer();
    setStatus('Creating invite…','blue');
    const offer = await pc.createOffer({ offerToReceiveAudio:true, offerToReceiveVideo:false });
    await pc.setLocalDescription(offer);
    await waitForIceComplete(pc, 7000);
    const invite = b64(pc.localDescription);
    await copyToClipboard(invite);
    setStatus('Invite copied — send to other group. Then paste their return code.','blue');

    const theirAnsB64 = prompt("Paste the Return Code from the other group:");
    if (!theirAnsB64){ meetBtn.disabled=false; return; }
    try{
      const ans = unb64(theirAnsB64);
      await pc.setRemoteDescription(ans);
      setStatus('Connecting…','blue');
    }catch(e){
      alert('That Return Code looks invalid. Try again.');
      meetBtn.disabled=false;
    }
  }

  async function answerFlow(theirOfferB64){
    const pc = newPeer();
    let offerObj;
    try{ offerObj = unb64(theirOfferB64); }
    catch{ alert('Invite Code not recognized.'); meetBtn.disabled=false; return; }

    setStatus('Creating return code…','blue');
    await pc.setRemoteDescription(offerObj);
    const ans = await pc.createAnswer();
    await pc.setLocalDescription(ans);
    await waitForIceComplete(pc, 7000);
    const returnCode = b64(pc.localDescription);
    await copyToClipboard(returnCode);
    setStatus('Return Code copied — send back to connect.','blue');
  }

  function endCall(){
    try{ if(pc) pc.close(); }catch{}
    pc=null;
    if (localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; }
    setStatus('Not connected','red');
    meetBtn.disabled=false;
    muteBtn.disabled=true; endBtn.disabled=true;
  }

  function toggleMute(){
    if (!localStream) return;
    const t = localStream.getAudioTracks()[0];
    t.enabled = !t.enabled;
    isMuted = !t.enabled;
    muteBtn.textContent = isMuted ? 'Unmute' : 'Mute';
  }

  meetBtn.addEventListener('click', meetNow);
  endBtn.addEventListener('click', endCall);
  muteBtn.addEventListener('click', toggleMute);
})();
</script>
</body>
</html>
