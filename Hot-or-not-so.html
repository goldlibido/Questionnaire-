<!DOCTYPE html>
<html>
<head>
  <title>üî• Hot or Not AI üî•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 10px; background: #fff; }
    h1 { margin-bottom: 10px; font-size: 26px; }
    button, input[type=file] { margin: 10px; padding: 10px; font-size: 16px; border-radius: 6px; border: none; cursor: pointer; }
    button { background: #ff4d6d; color: white; }
    img, video { max-width: 95%; margin-top: 15px; border-radius: 10px; }
    #score { font-size: 16px; font-weight: bold; margin-top: 20px; }
    .loader { border: 6px solid #f3f3f3; border-top: 6px solid #ff4d6d; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
    #shareBtn, #downloadBtn, #leaderboardBtn { display:none; margin-top: 20px; }
    #leaderboard { margin-top: 30px; }
    table { width: 90%; margin: auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #ff4d6d; color: white; }
  </style>
</head>
<body>

<h1>üî• Hot or Not AI üî•</h1>
<p>Upload or take a photo. Get Face & Body scores plus your ‚ÄúAI vibe‚Äù!</p>
<input type="file" id="fileInput" accept="image/*" capture="environment">
<button id="cameraBtn">üì∏ Take Photo</button>
<video id="cameraStream" autoplay playsinline style="display:none;"></video>
<button id="snapBtn" style="display:none;">Snap</button>
<canvas id="snapshotCanvas" style="display:none;"></canvas>
<div class="loader" id="loader"></div>
<img id="preview" style="display:none;">
<div id="score"></div>
<button id="shareBtn">üîó Share</button>
<button id="downloadBtn">üíæ Download</button>
<button id="leaderboardBtn">üèÜ Post to Leaderboard</button>

<div id="leaderboard">
  <h2>üèÜ Leaderboard</h2>
  <table id="leaderboardTable">
    <tr><th>Name</th><th>Face</th><th>Body</th><th>Vibe</th></tr>
  </table>
</div>

<script>
let faceModel, bodyModel, detector, stream, latestImageData, latestScores = [], latestVibe = "";
const vibes = [
  "Confident Charmer üòé", "Playful Energy üòú", "Mysterious Allure üñ§",
  "Romantic Dreamer üíñ", "Adventurous Spirit üåç", "Life of the Party üéâ",
  "Chill & Cool üòå", "Bold & Fearless üí™", "Classy Elegance üëë"
];

async function loadModels() {
  document.getElementById("loader").style.display = "block";
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models');
  faceModel = await tf.loadLayersModel('https://huggingface.co/datasets/ayasy/face_beauty_tfjs/resolve/main/model.json');
  bodyModel = faceModel;
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose, { runtime: 'tfjs', modelType: 'full' });
  document.getElementById("loader").style.display = "none";
  loadLeaderboard();
}

async function detectPeople(img) {
  const faces = await faceapi.detectAllFaces(img);
  let detections = faces.map(f => ({ type: 'face', box: f.box }));
  const bodies = await detector.estimatePoses(img);
  bodies.forEach(b => {
    if (b.keypoints?.length) {
      const xs = b.keypoints.map(k => k.x), ys = b.keypoints.map(k => k.y);
      detections.push({ type: 'body', box: { x: Math.min(...xs), y: Math.min(...ys), width: Math.max(...xs)-Math.min(...xs), height: Math.max(...ys)-Math.min(...ys) } });
    }
  });
  return detections;
}

async function predictScore(canvas, model) {
  const t = tf.browser.fromPixels(canvas).resizeBilinear([224,224]).toFloat().div(tf.scalar(255)).expandDims(0);
  const p = model.predict(t), s = await p.data();
  t.dispose(); p.dispose();
  return Math.max(1, Math.min(10, s[0])).toFixed(1);
}

async function processImage(img) {
  document.getElementById("loader").style.display = "block";
  const detections = await detectPeople(img);
  if (!detections.length) { document.getElementById("loader").style.display = "none"; alert("No people found."); return; }

  const orig = document.createElement('canvas'); orig.width = img.width; orig.height = img.height; const ctxO = orig.getContext('2d'); ctxO.drawImage(img,0,0);
  let thumbs=[], labels=[]; latestScores = [];

  for (let i=0;i<detections.length;i++) {
    const { type, box } = detections[i], pad=0.2;
    const x=Math.max(0,box.x-box.width*pad), y=Math.max(0,box.y-box.height*pad), w=Math.min(img.width-x, box.width*(1+pad*2)), h=Math.min(img.height-y, box.height*(1+pad*2));
    const crop=document.createElement('canvas'); crop.width=400; crop.height=400; crop.getContext('2d').drawImage(img,x,y,w,h,0,0,400,400);
    const faceScore=type==='face'?await predictScore(crop,faceModel):'-', bodyScore=type==='body'?await predictScore(crop,bodyModel):'-';
    latestScores.push({ face: faceScore, body: bodyScore });
    labels.push(`#${i+1} Face:${faceScore} Body:${bodyScore}`);
    const ctxC = crop.getContext('2d'); ctxC.fillStyle='rgba(0,0,0,0.6)'; ctxC.fillRect(0,340,400,60); ctxC.fillStyle='white'; ctxC.font='bold 22px Arial'; ctxC.textAlign='center'; ctxC.fillText(`#${i+1} F:${faceScore} B:${bodyScore}`,200,375);
    ctxO.strokeStyle='red'; ctxO.lineWidth=3; ctxO.strokeRect(box.x,box.y,box.width,box.height); ctxO.fillStyle='red'; ctxO.font='20px Arial'; ctxO.fillText(`#${i+1}`,box.x,box.y-5);
    thumbs.push(crop);
  }

  latestVibe = vibes[Math.floor(Math.random()*vibes.length)];
  labels.push(`Vibe: ${latestVibe}`);

  const cols=Math.min(thumbs.length,3), rows=Math.ceil(thumbs.length/cols);
  const collage=document.createElement('canvas'); collage.width=cols*400; collage.height=rows*400; const ctxCol=collage.getContext('2d');
  thumbs.forEach((c,i)=>ctxCol.drawImage(c,(i%cols)*400,Math.floor(i/cols)*400));

  const final=document.createElement('canvas'); final.width=orig.width+collage.width; final.height=Math.max(orig.height,collage.height);
  final.getContext('2d').drawImage(orig,0,0); final.getContext('2d').drawImage(collage,orig.width,0);

  latestImageData=final.toDataURL('image/png');
  document.getElementById("preview").src=latestImageData; document.getElementById("preview").style.display='block';
  document.getElementById("score").innerHTML=labels.join('<br>'); document.getElementById("shareBtn").style.display='inline-block'; document.getElementById("downloadBtn").style.display='inline-block'; document.getElementById("leaderboardBtn").style.display='inline-block';
  document.getElementById("loader").style.display='none';
}

function loadLeaderboard() {
  const data = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  const table = document.getElementById("leaderboardTable");
  table.innerHTML = "<tr><th>Name</th><th>Face</th><th>Body</th><th>Vibe</th></tr>";
  data.sort((a,b) => b.face - a.face).forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${row.name}</td><td>${row.face}</td><td>${row.body}</td><td>${row.vibe}</td>`;
    table.appendChild(tr);
  });
}

function saveToLeaderboard(name, face, body, vibe) {
  const data = JSON.parse(localStorage.getItem("leaderboard") || "[]");
  data.push({ name, face, body, vibe });
  localStorage.setItem("leaderboard", JSON.stringify(data));
  loadLeaderboard();
}

document.getElementById('fileInput').addEventListener('change',async e=>{const f=e.target.files[0]; if(!f)return; const img=await faceapi.bufferToImage(f); processImage(img);});
document.getElementById('cameraBtn').addEventListener('click',async()=>{stream=await navigator.mediaDevices.getUserMedia({video:true}); document.getElementById('cameraStream').srcObject=stream; document.getElementById('cameraStream').style.display='block'; document.getElementById('snapBtn').style.display='inline-block';});
document.getElementById('snapBtn').addEventListener('click',()=>{const v=document.getElementById('cameraStream'); const c=document.getElementById('snapshotCanvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0); stream.getTracks().forEach(t=>t.stop()); v.style.display='none'; document.getElementById('snapBtn').style.display='none'; const img=new Image(); img.src=c.toDataURL(); img.onload=()=>processImage(img);});
document.getElementById('shareBtn').addEventListener('click',async()=>{if(navigator.canShare&&navigator.canShare({files:[]})){const blob=await(await fetch(latestImageData)).blob(); const file=new File([blob],'ai_score.png',{type:'image/png'}); await navigator.share({title:'Hot or Not AI',text:`Face:${latestScores[0].face} Body:${latestScores[0].body} | ${latestVibe}`,files:[file]});} else {prompt("Copy your result link:",window.location.href);}});
document.getElementById('downloadBtn').addEventListener('click',()=>{const a=document.createElement('a'); a.href=latestImageData; a.download='ai_result.png'; a.click();});
document.getElementById('leaderboardBtn').addEventListener('click',()=>{const name=prompt("Enter your name for the leaderboard:"); if(name){saveToLeaderboard(name, latestScores[0].face, latestScores[0].body, latestVibe); alert("Posted to leaderboard!");}});

loadModels();
</script>

</body>
</html>
