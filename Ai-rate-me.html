<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Attractiveness Rater</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
<style>
  body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; padding: 20px; }
  h1 { margin-bottom: 20px; }
  button, input[type=file] { font-size: 16px; padding: 10px; margin: 10px; }
  img, video { max-width: 90%; margin-top: 20px; border-radius: 10px; }
  #score { font-size: 28px; font-weight: bold; margin-top: 20px; }
  .loader { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
  @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
</style>
</head>
<body>

<h1>AI Attractiveness Rater</h1>

<input type="file" id="fileInput" accept="image/*" capture="environment">
<button id="cameraBtn">Take Photo</button>
<video id="cameraStream" autoplay playsinline style="display:none;"></video>
<button id="snapBtn" style="display:none;">Snap Photo</button>
<canvas id="snapshotCanvas" style="display:none;"></canvas>

<div class="loader" id="loader"></div>
<img id="preview" style="display:none;">
<div id="score"></div>

<script>
let model, stream;

async function loadModel() {
  document.getElementById("loader").style.display = "block";
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models');
  model = await tf.loadLayersModel('https://huggingface.co/datasets/ayasy/face_beauty_tfjs/resolve/main/model.json');
  document.getElementById("loader").style.display = "none";
}

async function processImage(img) {
  document.getElementById("loader").style.display = "block";
  document.getElementById("score").innerText = "";

  const detection = await faceapi.detectSingleFace(img);
  if (!detection) {
    document.getElementById("loader").style.display = "none";
    document.getElementById("score").innerText = "No face detected.";
    return;
  }

  const { x, y, width, height } = detection.box;
  const faceCanvas = document.createElement('canvas');
  faceCanvas.width = 224;
  faceCanvas.height = 224;
  const ctx = faceCanvas.getContext('2d');
  ctx.drawImage(img, x, y, width, height, 0, 0, 224, 224);

  const tensor = tf.browser.fromPixels(faceCanvas)
    .toFloat()
    .div(tf.scalar(255))
    .expandDims(0);

  const prediction = model.predict(tensor);
  const score = await prediction.data();
  const finalScore = score[0].toFixed(1);

  document.getElementById("loader").style.display = "none";
  document.getElementById("score").innerText = `Score: ${finalScore} / 10`;

  tensor.dispose();
  prediction.dispose();
}

document.getElementById('fileInput').addEventListener('change', async function(){
  const file = this.files[0];
  if (!file) return;
  const img = await faceapi.bufferToImage(file);
  document.getElementById('preview').src = URL.createObjectURL(file);
  document.getElementById('preview').style.display = 'block';
  processImage(img);
});

document.getElementById('cameraBtn').addEventListener('click', async () => {
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  const video = document.getElementById('cameraStream');
  video.srcObject = stream;
  video.style.display = 'block';
  document.getElementById('snapBtn').style.display = 'inline-block';
});

document.getElementById('snapBtn').addEventListener('click', () => {
  const video = document.getElementById('cameraStream');
  const canvas = document.getElementById('snapshotCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  stream.getTracks().forEach(track => track.stop());
  const img = new Image();
  img.src = canvas.toDataURL();
  img.onload = () => processImage(img);
  document.getElementById('preview').src = img.src;
  document.getElementById('preview').style.display = 'block';
  document.getElementById('cameraStream').style.display = 'none';
  document.getElementById('snapBtn').style.display = 'none';
});

loadModel();
</script>

</body>
</html>
