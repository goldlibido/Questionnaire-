<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>🔥 AI Hotness Rater 🔥</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: linear-gradient(180deg, #064D95 0%, #e1bf78 100%);
    overflow: hidden;
    font-family: Arial, sans-serif;
    color: #fff;
    height: 100%;
  }
  video, canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  #overlay { pointer-events: none; }
  .bottomPanel {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    background: rgba(0,0,0,0.55);
    padding: 15px 20px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 2px solid #e1bf78;
    opacity: 0;
    transition: opacity 1s ease;
    max-width: 90%;
  }
  .bottomPanel div { margin: 6px 0; }
  #vibeText { font-size: 1.2rem; color: #e1bf78; }
  #typeText { font-size: 1.1rem; color: #950606; }
  #badgeText { font-size: 1.2rem; font-weight: bold; color: #06954E; transform: rotate(-5deg); transition: transform 0.3s ease; }
  #badgeText.drop { transform: rotate(0deg); }
  .shareButtons button {
    margin: 5px;
    padding: 10px 15px;
    background: #e1bf78;
    border: none;
    border-radius: 8px;
    color: #000;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(225,191,120,0.8);
  }
  .shareButtons button:hover {
    box-shadow: 0 0 15px rgba(225,191,120,1);
  }
</style>
</head>
<body>

<video id="camera" autoplay muted playsinline></video>
<canvas id="overlay"></canvas>

<div class="bottomPanel" id="resultsPanel">
  <div id="vibeText"></div>
  <div id="typeText"></div>
  <div id="badgeText"></div>
  <div id="hotTake"></div>
  <div class="shareButtons" id="shareSection"></div>
</div>

<script>
let faceModel, bodyModel, detector, video, canvas, ctx;
let scorePhase = 0;
let faceScoreFinal = 0, bodyScoreFinal = 0, totalScoreFinal = 0;
let tickerScore = 0;
let faceBox = null;
let mediaRecorder, recordedChunks = [];

const vibes = ["Confident Charmer 😎","Playful Energy 😜","Mysterious Allure 🖤","Romantic Dreamer 💖","Adventurous Spirit 🌍","Life of the Party 🎉"];
const roastTypes = [
  "People who treat red flags as decorative lights 🚩",
  "Girls who would date a SoundCloud rapper *on purpose* 🎤",
  "Guys who think foreplay is playing Xbox before bed 🎮",
  "People who ghost but still watch your stories 👻",
  "Women who have 4 exes and they’re all DJs 🎧",
  "Men who post gym selfies with captions about 'the grind' 💪"
];
const badges = ["Certified Heartbreaker 💔","Main Character Energy 🎬","Dangerously Hot 🔥","Chaos in Human Form 🌪️","Too Hot to Handle 🚫🔥"];
const hotTakes = [
  "You peaked in 2019 📉",
  "Someone’s mom would love you ❤️",
  "A walking ick 🚷",
  "Hot enough to skip the line 🔥",
  "Could make a nun blush 😳",
  "Certified thirst trap 📸"
];

async function loadModels() {
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models');
  faceModel = await tf.loadLayersModel('https://huggingface.co/datasets/ayasy/face_beauty_tfjs/resolve/main/model.json');
  bodyModel = faceModel;
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose, { runtime: 'tfjs', modelType: 'full' });
}

async function initCamera() {
  video = document.getElementById('camera');
  const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  video.srcObject = stream;

  const combinedStream = new MediaStream();
  canvas = document.getElementById('overlay');
  ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  const videoTrack = canvas.captureStream(30).getVideoTracks()[0];
  combinedStream.addTrack(videoTrack);

  mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9' });
  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = uploadRecording;
}

async function detectFrame() {
  const detections = await faceapi.detectSingleFace(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (detections) {
    faceBox = detections.box;
    const tickerY = faceBox.y - 20;
    ctx.font = "bold 32px Arial";
    ctx.fillStyle = "#e1bf78";
    ctx.shadowColor = '#000';
    ctx.shadowBlur = 8;
    ctx.textAlign = "center";
    let label = "";
    if (scorePhase === 1) label = `Face: ${tickerScore.toFixed(1)}/10`;
    if (scorePhase === 2) label = `Body: ${tickerScore.toFixed(1)}/10`;
    if (scorePhase === 3) label = `Total: ${tickerScore.toFixed(1)}/10`;
    if (label) {
      ctx.save();
      ctx.translate(faceBox.x + faceBox.width/2, tickerY);
      ctx.scale(1 + Math.sin(Date.now()/150)*0.05, 1 + Math.sin(Date.now()/150)*0.05);
      ctx.fillText(label, 0, 0);
      ctx.restore();
    }
  }
  requestAnimationFrame(detectFrame);
}

async function scoreSequence() {
  mediaRecorder.start();

  const cropFace = document.createElement('canvas');
  cropFace.width = 400; cropFace.height = 400;
  if (faceBox) {
    cropFace.getContext('2d').drawImage(video, faceBox.x, faceBox.y, faceBox.width, faceBox.height, 0, 0, 400, 400);
    faceScoreFinal = await predictScore(cropFace, faceModel);
  }

  const poses = await detector.estimatePoses(video);
  if (poses.length) {
    const xs = poses[0].keypoints.map(k=>k.x), ys = poses[0].keypoints.map(k=>k.y);
    const box = { x: Math.min(...xs), y: Math.min(...ys), width: Math.max(...xs)-Math.min(...xs), height: Math.max(...ys)-Math.min(...ys) };
    const cropBody = document.createElement('canvas');
    cropBody.width = 400; cropBody.height = 400;
    cropBody.getContext('2d').drawImage(video, box.x, box.y, box.width, box.height, 0, 0, 400, 400);
    bodyScoreFinal = await predictScore(cropBody, bodyModel);
  }

  totalScoreFinal = ((parseFloat(faceScoreFinal) + parseFloat(bodyScoreFinal))/2).toFixed(1);

  scorePhase = 1; await animateTicker(faceScoreFinal);
  scorePhase = 2; await animateTicker(bodyScoreFinal);
  scorePhase = 3; await animateTicker(totalScoreFinal);

  document.getElementById("vibeText").innerText = `Vibe: ${vibes[Math.floor(Math.random()*vibes.length)]}`;
  document.getElementById("typeText").innerText = `Type: ${roastTypes[Math.floor(Math.random()*roastTypes.length)]}`;
  const badgeEl = document.getElementById("badgeText");
  badgeEl.innerText = `🏆 ${badges[Math.floor(Math.random()*badges.length)]}`;
  setTimeout(()=>badgeEl.classList.add('drop'),100);
  document.getElementById("hotTake").innerText = hotTakes[Math.floor(Math.random()*hotTakes.length)];
  document.getElementById("resultsPanel").style.opacity = 1;

  confetti({ colors: ['#e1bf78','#06954E','#950606'], particleCount: 150, spread: 80 });
  setTimeout(()=>mediaRecorder.stop(), 2500);
}

async function animateTicker(finalScore) {
  return new Promise(res=>{
    tickerScore = 0.0;
    let direction = 1;
    const step = finalScore / 40;
    const intv = setInterval(()=>{
      tickerScore += step * direction;
      if (Math.random() < 0.1) direction *= -1;
      if (tickerScore >= finalScore && direction > 0) {
        tickerScore = finalScore;
        clearInterval(intv);
        if (finalScore >= 7) flashBackground('#06954E');
        else if (finalScore <= 4) flashBackground('#950606');
        res();
      }
    },50);
  });
}

async function predictScore(canvas, model) {
  const t = tf.browser.fromPixels(canvas).resizeBilinear([224,224]).toFloat().div(tf.scalar(255)).expandDims(0);
  const p = model.predict(t), s = await p.data();
  t.dispose(); p.dispose();
  return Math.max(1, Math.min(10, s[0])).toFixed(1);
}

function flashBackground(color) {
  document.body.style.transition = 'background 0.3s ease';
  document.body.style.background = color;
  setTimeout(()=>{
    document.body.style.background = 'linear-gradient(180deg, #064D95 0%, #e1bf78 100%)';
  }, 400);
}

function uploadRecording() {
  const blob = new Blob(recordedChunks, { type: 'video/webm' });
  const formData = new FormData();
  formData.append("file", blob, "ai_rating.webm");

  fetch("https://file.io/?expires=1d", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      const link = data.link || "";
      showShareButtons(link);
    });
}

function showShareButtons(link) {
  const s = document.getElementById("shareSection");
  s.innerHTML = `
    <button onclick="window.open('https://www.tiktok.com/upload?url=${encodeURIComponent(link)}','_blank')">TikTok</button>
    <button onclick="window.open('https://twitter.com/intent/tweet?text=${encodeURIComponent('Bet you can’t beat my hotness score!')}%20${encodeURIComponent(link)}','_blank')">Twitter</button>
    <button onclick="window.open('https://api.whatsapp.com/send?text=${encodeURIComponent('Bet you can’t beat my hotness score! ' + link)}','_blank')">WhatsApp</button>
    <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}','_blank')">Facebook</button>
    <button onclick="navigator.clipboard.writeText('${link}')">Copy Link</button>
  `;
}

(async ()=>{
  await loadModels();
  await initCamera();
  detectFrame();
  setTimeout(scoreSequence, 2000);
})();
</script>

</body>
</html>