<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ðŸ”¥ AI Hotness Rater ðŸ”¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: black;
    overflow: hidden;
    font-family: Arial, sans-serif;
    color: white;
  }
  video, canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    object-fit: cover;
  }
  #overlay {
    pointer-events: none;
  }
  .bottomPanel {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
    background: rgba(0,0,0,0.6);
    padding: 15px 20px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    opacity: 0;
    transition: opacity 1s ease;
  }
  .shareButtons button {
    margin: 5px;
    padding: 10px 15px;
    background: #ff4d6d;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
  }
  @keyframes glowPulse {
    from { text-shadow: 0 0 5px #fff, 0 0 10px #ff4d6d; }
    to { text-shadow: 0 0 15px #fff, 0 0 25px #ff4d6d; }
  }
</style>
</head>
<body>

<video id="camera" autoplay muted playsinline></video>
<canvas id="overlay"></canvas>

<div class="bottomPanel" id="resultsPanel">
  <div id="vibeText"></div>
  <div id="typeText"></div>
  <div id="badgeText"></div>
  <div id="rankText"></div>
  <div class="shareButtons" id="shareSection"></div>
</div>

<script>
let faceModel, bodyModel, detector, video, canvas, ctx;
let scorePhase = 0;
let faceScoreFinal = 0, bodyScoreFinal = 0;
let tickerScore = 0;
let faceBox = null;
let mediaRecorder, recordedChunks = [];

const vibes = ["Confident Charmer ðŸ˜Ž","Playful Energy ðŸ˜œ","Mysterious Allure ðŸ–¤","Romantic Dreamer ðŸ’–","Adventurous Spirit ðŸŒ","Life of the Party ðŸŽ‰"];
const roastTypes = [
  "People who treat red flags as decorative lights ðŸš©",
  "Girls who would date a SoundCloud rapper *on purpose* ðŸŽ¤",
  "Guys who think foreplay is playing Xbox before bed ðŸŽ®",
  "People who ghost but still watch your stories ðŸ‘»",
  "Women who have 4 exes and theyâ€™re all DJs ðŸŽ§",
  "Men who post gym selfies with captions about 'the grind' ðŸ’ª"
];
const badges = ["Certified Heartbreaker ðŸ’”","Main Character Energy ðŸŽ¬","Dangerously Hot ðŸ”¥","Chaos in Human Form ðŸŒªï¸","Too Hot to Handle ðŸš«ðŸ”¥"];
function randomRank(){ return `Top ${Math.floor(Math.random()*50)+1}% of uploads today`; }

async function loadModels() {
  await faceapi.nets.ssdMobilenetv1.loadFromUri('https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js/models');
  faceModel = await tf.loadLayersModel('https://huggingface.co/datasets/ayasy/face_beauty_tfjs/resolve/main/model.json');
  bodyModel = faceModel;
  detector = await poseDetection.createDetector(poseDetection.SupportedModels.BlazePose, { runtime: 'tfjs', modelType: 'full' });
}

async function initCamera() {
  video = document.getElementById('camera');
  const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
  video.srcObject = stream;

  // Recording overlay + camera
  const combinedStream = new MediaStream();
  const videoTrack = canvas.captureStream(30).getVideoTracks()[0];
  combinedStream.addTrack(videoTrack);
  mediaRecorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm; codecs=vp9' });
  mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
  mediaRecorder.onstop = uploadRecording;
}

async function detectFrame() {
  const detections = await faceapi.detectSingleFace(video);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (detections) {
    faceBox = detections.box;
    ctx.strokeStyle = 'rgba(255,255,255,0.7)';
    ctx.lineWidth = 2;
    ctx.strokeRect(faceBox.x, faceBox.y, faceBox.width, faceBox.height);

    const tickerY = faceBox.y - 20;
    ctx.font = "28px Arial";
    ctx.fillStyle = "#ff4d6d";
    ctx.textAlign = "center";
    let label = "";
    if (scorePhase === 1) label = `Face: ${tickerScore.toFixed(1)}/10`;
    if (scorePhase === 2) label = `Body: ${tickerScore.toFixed(1)}/10`;
    if (label) ctx.fillText(label, faceBox.x + faceBox.width/2, tickerY);
  }
  requestAnimationFrame(detectFrame);
}

async function scoreSequence() {
  mediaRecorder.start();

  const cropFace = document.createElement('canvas');
  cropFace.width = 400; cropFace.height = 400;
  if (faceBox) {
    cropFace.getContext('2d').drawImage(video, faceBox.x, faceBox.y, faceBox.width, faceBox.height, 0, 0, 400, 400);
    faceScoreFinal = await predictScore(cropFace, faceModel);
  }

  const poses = await detector.estimatePoses(video);
  if (poses.length) {
    const xs = poses[0].keypoints.map(k=>k.x), ys = poses[0].keypoints.map(k=>k.y);
    const box = { x: Math.min(...xs), y: Math.min(...ys), width: Math.max(...xs)-Math.min(...xs), height: Math.max(...ys)-Math.min(...ys) };
    const cropBody = document.createElement('canvas');
    cropBody.width = 400; cropBody.height = 400;
    cropBody.getContext('2d').drawImage(video, box.x, box.y, box.width, box.height, 0, 0, 400, 400);
    bodyScoreFinal = await predictScore(cropBody, bodyModel);
  }

  scorePhase = 1; await animateTicker(faceScoreFinal);
  scorePhase = 2; await animateTicker(bodyScoreFinal);

  scorePhase = 3;
  document.getElementById("vibeText").innerText = `Vibe: ${vibes[Math.floor(Math.random()*vibes.length)]}`;
  document.getElementById("typeText").innerText = `Type: ${roastTypes[Math.floor(Math.random()*roastTypes.length)]}`;
  document.getElementById("badgeText").innerText = `ðŸ† ${badges[Math.floor(Math.random()*badges.length)]}`;
  document.getElementById("rankText").innerText = randomRank();
  document.getElementById("resultsPanel").style.opacity = 1;

  confetti();
  setTimeout(()=>mediaRecorder.stop(), 2500);
}

async function animateTicker(finalScore) {
  return new Promise(res=>{
    tickerScore = 0.0;
    let direction = 1;
    const step = finalScore / 40;
    const intv = setInterval(()=>{
      tickerScore += step * direction;
      if (Math.random() < 0.1) direction *= -1; // suspense fake-out
      if (tickerScore >= finalScore && direction > 0) {
        tickerScore = finalScore;
        clearInterval(intv);
        res();
      }
    },50);
  });
}

async function predictScore(canvas, model) {
  const t = tf.browser.fromPixels(canvas).resizeBilinear([224,224]).toFloat().div(tf.scalar(255)).expandDims(0);
  const p = model.predict(t), s = await p.data();
  t.dispose(); p.dispose();
  return Math.max(1, Math.min(10, s[0])).toFixed(1);
}

function uploadRecording() {
  const blob = new Blob(recordedChunks, { type: 'video/webm' });
  const formData = new FormData();
  formData.append("file", blob, "ai_rating.webm");

  fetch("https://file.io/?expires=1d", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      const link = data.link || "";
      showShareButtons(link);
    });
}

function showShareButtons(link) {
  const s = document.getElementById("shareSection");
  s.innerHTML = `
    <button onclick="window.open('https://www.tiktok.com/upload?url=${encodeURIComponent(link)}','_blank')">TikTok</button>
    <button onclick="window.open('https://twitter.com/intent/tweet?text=${encodeURIComponent('My AI hotness score is out!')}%20${encodeURIComponent(link)}','_blank')">Twitter</button>
    <button onclick="window.open('https://api.whatsapp.com/send?text=${encodeURIComponent('My AI hotness score is out! ' + link)}','_blank')">WhatsApp</button>
    <button onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(link)}','_blank')">Facebook</button>
    <button onclick="navigator.clipboard.writeText('${link}')">Copy Link</button>
  `;
}

(async ()=>{
  await loadModels();
  await initCamera();
  canvas = document.getElementById('overlay');
  ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  detectFrame();
  setTimeout(scoreSequence, 2000);
})();
</script>

</body>
</html>