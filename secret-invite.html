<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Le Libido – Secret Invite</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#e1bf78;
    --black:#000;
    --white:#fff;
    --blue:#064D95;
    --green:#06954E;
    --red:#950606;
    --modal-max:560px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--black);color:var(--white);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
  .page-wrap{min-height:100svh;padding:24px;border:2px solid var(--gold);position:relative}

  /* Header with centered logo + gear */
  .header{display:flex;align-items:center;justify-content:center;position:relative;margin-bottom:16px}
  .logo{display:block;margin:0 auto;max-width:120px;width:120px;height:auto}
  .gear{position:absolute;right:0;top:0;width:40px;height:40px;border:1px solid var(--gold);border-radius:10px;display:grid;place-items:center;background:transparent;color:var(--gold);cursor:pointer}
  .gear svg{width:22px;height:22px}
  .menu{position:absolute;right:0;top:48px;background:#0f0f0f;border:1px solid var(--gold);border-radius:12px;display:none;min-width:220px;overflow:hidden;z-index:20}
  .menu.show{display:block}
  .menu a,.menu button{display:flex;align-items:center;gap:8px;width:100%;padding:12px 14px;background:transparent;border:none;color:var(--white);text-decoration:none;cursor:pointer;font-size:14px}
  .menu a:hover,.menu button:hover{background:#171717}

  /* Area controls */
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;margin-bottom:10px}
  .areas{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--gold);padding:8px 10px;border-radius:10px;cursor:pointer;user-select:none;font-size:14px}
  .tag input{accent-color:var(--gold)}
  .save-areas{border:1px solid var(--gold);background:transparent;color:var(--gold);padding:8px 12px;border-radius:10px;cursor:pointer}

  /* Doors */
  .doors{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:24px;align-items:end;max-width:1080px;margin:20px auto 0}
  .door{display:flex;flex-direction:column;align-items:center;gap:10px}
  .door-caption{font-size:16px;font-weight:700;margin:2px 0 6px 0;letter-spacing:.2px}
  .caption-blue{color:var(--blue)}
  .caption-green{color:var(--green)}
  .caption-red{color:var(--red)}
  .door-btn{display:block;width:100%;max-width:300px;aspect-ratio:3/5;background:#111;border:1px solid #333;border-radius:14px;overflow:hidden;position:relative;cursor:pointer}
  .door-btn img{width:100%;height:100%;object-fit:contain;background:transparent}
  .door-label{font-size:14px;opacity:.85}
  .hint{font-size:13px;color:#bbb;text-align:center;margin-top:6px}

  /* Locked feedback */
  .shake{animation:shake .5s ease}
  @keyframes shake{
    10%,90%{transform:translateX(-1px)}
    20%,80%{transform:translateX(2px)}
    30%,50%,70%{transform:translateX(-4px)}
    40%,60%{transform:translateX(4px)}
  }

  /* Modal (universal) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal-backdrop.show{display:flex}
  .modal{width:100%;max-width:var(--modal-max);background:#0f0f0f;border:2px solid var(--gold);border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
  .modal-head{padding:14px 18px;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between}
  .modal-title{margin:0;font-size:18px;font-weight:700;letter-spacing:.2px}
  .modal-close{background:transparent;border:none;color:var(--white);font-size:22px;cursor:pointer;line-height:1}
  .modal-body{padding:18px}
  .pill{display:inline-block;border:1px solid var(--gold);color:var(--gold);padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
  .invite-card{border:1px solid var(--gold);border-radius:12px;padding:16px;margin-top:10px;background:#111}
  .invite-brand{font-size:14px;opacity:.85;margin-bottom:8px}
  .invite-h1{margin:0 0 10px 0;font-size:22px;font-weight:700;line-height:1.25}
  .meta{display:grid;grid-template-columns:1fr;gap:8px;margin:12px 0}
  .meta div{font-size:14px;opacity:.95}
  .buttons{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .btn{border:1px solid var(--gold);background:transparent;color:var(--gold);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600}
  .btn.primary{background:var(--gold);color:#111;border-color:var(--gold)}
  .btn:disabled{opacity:.4;cursor:not-allowed}
  .tiny{font-size:12px;opacity:.8;margin-top:6px}

  /* Dynamic color accents */
  .theme-red .modal-head{background:linear-gradient(0deg, rgba(149,6,6,.35), rgba(149,6,6,.35))}
  .theme-green .modal-head{background:linear-gradient(0deg, rgba(6,149,78,.35), rgba(6,149,78,.35))}
  .theme-blue .modal-head{background:linear-gradient(0deg, rgba(6,77,149,.35), rgba(6,77,149,.35))}
  .theme-red .invite-card{background:rgba(149,6,6,.12)}
  .theme-green .invite-card{background:rgba(6,149,78,.12)}
  .theme-blue .invite-card{background:rgba(6,77,149,.12)}

  /* Locked blur text */
  .blurred{filter:blur(6px);user-select:none}

  @media (max-width:900px){ .doors{grid-template-columns:1fr;max-width:520px} }
</style>
</head>
<body>
<div class="page-wrap">
  <!-- Header with centered logo + gear -->
  <header class="header">
    <img class="logo" src="golden-le-libido-logo.png" alt="Le Libido" loading="lazy">
    <button class="gear" id="gearBtn" aria-label="Open menu" title="Menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
           stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06A2 2 0 1 1 4.2 19.4l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09c-.65 0-1.24.39-1.51 1Z"/>
      </svg>
    </button>
    <nav class="menu" id="gearMenu" role="menu" aria-label="Settings">
      <button id="profileBtn" role="menuitem">Profile</button>
    </nav>
  </header>

  <!-- Area picker -->
  <div class="controls">
    <div class="areas" id="areas"></div>
    <button class="save-areas" id="saveAreasBtn">Save areas</button>
  </div>

  <!-- Doors -->
  <section class="doors">
    <!-- BLUE -->
    <div class="door" data-color="blue">
      <div class="door-caption caption-blue">for the romantic</div>
      <button class="door-btn" id="door-blue" aria-label="Blue room door">
        <img id="door-blue-img" alt="Blue door" src="" />
      </button>
      <div class="door-label">Blue Room</div>
      <div class="hint">Click the door</div>
    </div>

    <!-- GREEN -->
    <div class="door" data-color="green">
      <div class="door-caption caption-green">for the frisky</div>
      <button class="door-btn" id="door-green" aria-label="Green room door">
        <img id="door-green-img" alt="Green door" src="" />
      </button>
      <div class="door-label">Green Room</div>
      <div class="hint">Click the door</div>
    </div>

    <!-- RED -->
    <div class="door" data-color="red">
      <div class="door-caption caption-red">for the kinky</div>
      <button class="door-btn" id="door-red" aria-label="Red room door">
        <img id="door-red-img" alt="Red door" src="" />
      </button>
      <div class="door-label">Red Room</div>
      <div class="hint">Click the door</div>
    </div>
  </section>
</div>

<!-- Universal Modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modal">
    <div class="modal-head">
      <h2 class="modal-title" id="modalTitle">Invitation</h2>
      <button class="modal-close" id="modalClose" aria-label="Close">×</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
/* ===========================
   Profile Mode: infer if missing (NO redirect to signin)
   - If not set, default to "anonymous" and stay on this page.
=========================== */
(function ensureProfileMode(){
  let mode = (localStorage.getItem("profileMode") || "").toLowerCase();
  if(!mode){
    const vRaw = localStorage.getItem("profileVerifiedData");
    const aRaw = localStorage.getItem("profileAnonymousData");
    const hasVerified = !!vRaw;
    const hasAnon = !!aRaw;
    if(hasVerified && !hasAnon) mode = "verified";
    else if(hasAnon && !hasVerified) mode = "anonymous";
    else if(hasVerified && hasAnon){
      try{
        const v = JSON.parse(vRaw||"{}");
        const a = JSON.parse(aRaw||"{}");
        mode = (v.updatedAt||0) >= (a.updatedAt||0) ? "verified" : "anonymous";
      }catch(e){ mode = "anonymous"; }
    } else {
      mode = "anonymous"; // default if nothing saved
    }
    localStorage.setItem("profileMode", mode);
  }
})();

/* ===========================
   CONFIG & DATA
=========================== */
const AREAS = [
  { id:"central-nj", label:"Central New Jersey" },
  // add more areas later
];

const VENUES_BY_AREA = {
  "central-nj":[
    {
      name:"Metropolitan Cafe",
      address:"8 E Main St, Freehold, NJ 07728",
      time:"7:30 PM",
      maps:"https://www.google.com/maps/search/?api=1&query=Metropolitan+Cafe+8+E+Main+St,+Freehold,+NJ+07728"
    },
    {
      name:"Nonna’s Cucina",
      address:"448 US-9, Englishtown, NJ 07726",
      time:"7:30 PM",
      maps:"https://www.google.com/maps/search/?api=1&query=Nonna%E2%80%99s+Cucina+448+US-9,+Englishtown,+NJ+07726"
    }
  ],
};

const THEMES = [
  "Heaven vs. Hell: Angel or Devil",
  "Cats vs. Dogs",
  "Brain vs. Brawn",
  "Light vs. Dark",
  "Burlesque & Cabaret",
  "Fetish Fantasy",
  "Sexy Uniform",
  "Slumber Party Gone Wild",
  "Primal Instincts",
  "Neon Nights",
  "Mobster & Mob Wife",
  "Goth night",
  "After Dark at the Office",
  "Flasher",
  "Vampires and Velvet"
];

const COLOR_CLASS = { blue:"theme-blue", green:"theme-green", red:"theme-red" };
const PEAK_DOW = new Set([4,5,6]); // Thu, Fri, Sat

/* Door frames auto-generated from door/<color>-door-1..7.png */
const DOOR_FRAMES = {
  blue: Array.from({length:7},(_,i)=>`door/blue-door-${i+1}.png`),
  green: Array.from({length:7},(_,i)=>`door/green-door-${i+1}.png`),
  red: Array.from({length:7},(_,i)=>`door/red-door-${i+1}.png`)
};
const DOOR_CLOSED = {
  blue: DOOR_FRAMES.blue[0],
  green: DOOR_FRAMES.green[0],
  red: DOOR_FRAMES.red[0]
};

/* ===========================
   UTILITIES
=========================== */
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0 } return Math.abs(h) }
function todayStr(){ const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${day}` }
function weekNumber(date=new Date()){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d-yearStart)/86400000)+1)/7);
}
function themeOfDay(){ const h=hashCode(todayStr()); return THEMES[h % THEMES.length] }
function venueFor(areaId, color){
  const list = VENUES_BY_AREA[areaId]||[]; if(!list.length) return null;
  const dow = new Date().getDay(); const w=weekNumber(); const colorOffset={blue:0,green:1,red:2}[color]??0;
  const peakBias = PEAK_DOW.has(dow)?1:0;
  const idx = (w + dow + colorOffset + peakBias) % list.length;
  return list[idx];
}
const AREAS_KEY="lelibido:selectedAreas";
function getSelectedAreas(){ try{ const raw=localStorage.getItem(AREAS_KEY); if(raw){ const a=JSON.parse(raw); if(Array.isArray(a)) return a } }catch(e){} return ["central-nj"] }
function setSelectedAreas(arr){ localStorage.setItem(AREAS_KEY, JSON.stringify(arr)) }
function getArchetypeColor(){ const c=(localStorage.getItem("archetypeColor")||"").toLowerCase(); return ["red","green","blue"].includes(c)?c:null }

/* Guest list count (stub; wire to Firebase later) */
async function getGuestCount(color, areaId){
  if(window.fakeGuestCounts && typeof window.fakeGuestCounts[color]==="number"){ return window.fakeGuestCounts[color] }
  return 0;
}

/* Analytics hook */
function track(event,payload={}){ console.log("[analytics]",event,payload); window.dataLayer=window.dataLayer||[]; window.dataLayer.push({event,...payload}) }

/* Calendar .ics */
function addToCalendar({title,location,startDateTime,endDateTime,description=""}){
  const dtStamp=todayStr().replace(/-/g,"")+"T000000";
  const lines=[
    "BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//Le Libido//Pop-Up//EN","BEGIN:VEVENT",
    `UID:${crypto.randomUUID()}@lelibido.com`,`DTSTAMP:${dtStamp}`,
    `DTSTART:${startDateTime}`,`DTEND:${endDateTime}`,
    `SUMMARY:${title}`,`LOCATION:${location}`,`DESCRIPTION:${description.replace(/\n/g,"\\n")}`,
    "END:VEVENT","END:VCALENDAR"
  ];
  const blob=new Blob([lines.join("\r\n")],{type:"text/calendar;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download=`${title.replace(/\s+/g,"_")}.ics`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ===========================
   RENDER AREAS
=========================== */
const areasEl=document.getElementById("areas");
const saveAreasBtn=document.getElementById("saveAreasBtn");
function renderAreas(){
  const selected=new Set(getSelectedAreas());
  areasEl.innerHTML="";
  AREAS.forEach(a=>{
    const id=`area-${a.id}`;
    const tag=document.createElement("label");
    tag.className="tag";
    tag.innerHTML=`<input type="checkbox" id="${id}" ${selected.has(a.id)?"checked":""}> ${a.label}`;
    areasEl.appendChild(tag);
  });
}
renderAreas();

saveAreasBtn.addEventListener("click", ()=>{
  const chosen=[];
  areasEl.querySelectorAll("input[type=checkbox]").forEach(cb=>{
    if(cb.checked) chosen.push(cb.id.replace("area-",""));
  });
  if(!chosen.length) chosen.push("central-nj");
  setSelectedAreas(chosen);
  track("areas_saved",{areas:chosen});
});

/* ===========================
   DOORS: setup & animation
=========================== */
const doorImg={
  blue:document.getElementById("door-blue-img"),
  green:document.getElementById("door-green-img"),
  red:document.getElementById("door-red-img")
};
const doorBtn={
  blue:document.getElementById("door-blue"),
  green:document.getElementById("door-green"),
  red:document.getElementById("door-red")
};
doorImg.blue.src=DOOR_CLOSED.blue;
doorImg.green.src=DOOR_CLOSED.green;
doorImg.red.src=DOOR_CLOSED.red;

function preloadFrames(list){ list.forEach(src=>{ const i=new Image(); i.src=src; }); }
["blue","green","red"].forEach(c=>preloadFrames(DOOR_FRAMES[c]));

/** Frame-by-frame door animation */
function playDoorAnimation(color){
  const frames=DOOR_FRAMES[color]; const img=doorImg[color];
  if(!frames || !frames.length) return Promise.resolve();
  return new Promise(resolve=>{
    let i=0;
    const step=()=>{
      img.src=frames[i]; i++;
      if(i<frames.length){ requestAnimationFrame(step) } else { resolve() }
    };
    step();
  });
}

/* Locked feedback: shake + (if supported) device vibration) */
function lockedEffect(btnEl){
  btnEl.classList.remove("shake"); void btnEl.offsetWidth; btnEl.classList.add("shake");
  if(navigator.vibrate){ try{ navigator.vibrate(100) }catch(e){} }
}

/* ===========================
   MODAL (universal)
=========================== */
const modalBackdrop=document.getElementById("modalBackdrop");
const modal=document.getElementById("modal");
const modalBody=document.getElementById("modalBody");
const modalTitle=document.getElementById("modalTitle");
const modalClose=document.getElementById("modalClose");
function closeModal(){ modalBackdrop.classList.remove("show"); modal.classList.remove("theme-red","theme-green","theme-blue"); modalBody.innerHTML="" }
modalClose.addEventListener("click", closeModal);
modalBackdrop.addEventListener("click", e=>{ if(e.target===modalBackdrop) closeModal() });

async function showInvitation({color,venue,theme}){
  modal.classList.remove("theme-red","theme-green","theme-blue");
  modal.classList.add(COLOR_CLASS[color]||"");
  modalTitle.textContent="Invitation";

  const areas=getSelectedAreas();
  const guestCount=await getGuestCount(color, areas[0]);
  const showGuestList=guestCount>=30;

  const now=new Date();
  const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),19,30,0);
  const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),21,30,0);
  const fmt=d=>`${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}T${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}00`;

  modalBody.innerHTML=`
    <span class="pill">Come together with your people.</span>
    <div class="invite-card">
      <div class="invite-brand">${color[0].toUpperCase()+color.slice(1)} Room • ${theme}</div>
      <h3 class="invite-h1">${venue?.name ?? "TBA"}</h3>
      <div class="meta">
        <div><strong>Address:</strong> ${venue?.address ?? "TBA"}</div>
        <div><strong>Starts:</strong> ${venue?.time ?? "7:30 PM"}</div>
      </div>
      <div class="buttons">
        <button class="btn" id="seeGuestsBtn" ${showGuestList?"":"disabled"}>See guest list</button>
        <a class="btn" href="${venue?.maps ?? "#"}" target="_blank" rel="noopener">Directions to venue</a>
        <button class="btn primary" id="addToCalBtn">Add to calendar</button>
      </div>
      ${showGuestList?'<div class="tiny">Guest list unlocked: 30+ confirmed.</div>':'<div class="tiny">Guest list appears after 30 people.</div>'}
    </div>
  `;
  modalBackdrop.classList.add("show");

  modalBody.querySelector("#addToCalBtn").addEventListener("click", ()=>{
    addToCalendar({
      title:`Le Libido: ${venue?.name ?? "Pop-Up"}`,
      location:venue?.address ?? "",
      startDateTime:fmt(start),
      endDateTime:fmt(end),
      description:`${theme}\nRoom: ${color.toUpperCase()}\nCome together with your people.`
    });
    track("add_to_calendar",{color,venue:venue?.name});
  });
  if(showGuestList){
    modalBody.querySelector("#seeGuestsBtn").addEventListener("click", ()=>{
      track("see_guest_list",{color});
      window.location.href=`/guest-list.html?color=${encodeURIComponent(color)}&date=${todayStr()}`;
    });
  }
}

function showLocked({color,venue}){
  modal.classList.remove("theme-red","theme-green","theme-blue");
  modal.classList.add(COLOR_CLASS[color]||"");
  modalTitle.textContent="Want to come?";
  modalBody.innerHTML=`
    <div class="invite-card">
      <div class="invite-brand">${color[0].toUpperCase()+color.slice(1)} Room • Exclusive Access</div>
      <h3 class="invite-h1 blurred">${venue?.name ?? "Secret Venue"}</h3>
      <div class="meta">
        <div class="blurred"><strong>Address:</strong> ${venue?.address ?? "Hidden for now"}</div>
        <div><strong>Starts:</strong> ${venue?.time ?? "7:30 PM"}</div>
      </div>
      <p>Unlock this event now:</p>
      <div class="buttons">
        <button class="btn" id="buy2Btn">Buy a ticket for $2</button>
        <button class="btn primary" id="buy3Btn">Access all of today’s pop-ups for $3</button>
      </div>
    </div>
  `;
  modalBackdrop.classList.add("show");
  modalBody.querySelector("#buy2Btn").addEventListener("click", ()=>{ track("paywall_click",{tier:"single",color}); window.location.href="/checkout/single.html?color="+encodeURIComponent(color) });
  modalBody.querySelector("#buy3Btn").addEventListener("click", ()=>{ track("paywall_click",{tier:"all_today",color}); window.location.href="/checkout/all-today.html" });
}

/* ===========================
   Door click handling
=========================== */
async function onDoorClick(color){
  const btn=doorBtn[color];
  const userColor=getArchetypeColor();      // "red"|"green"|"blue"
  const areas=getSelectedAreas();
  const areaId = areas.find(a => (VENUES_BY_AREA[a]?.length>0)) || "central-nj";
  const theme=themeOfDay();
  const venue=venueFor(areaId,color);

  if(userColor && userColor===color){
    track("door_open_click",{color,area:areaId,date:todayStr()});
    await playDoorAnimation(color);
    showInvitation({color,venue,theme});
  }else{
    track("door_locked_click",{color,area:areaId,date:todayStr()});
    lockedEffect(btn);
    setTimeout(()=>showLocked({color,venue}),280);
  }
}
doorBtn.blue.addEventListener("click", ()=>onDoorClick("blue"));
doorBtn.green.addEventListener("click", ()=>onDoorClick("green"));
doorBtn.red.addEventListener("click", ()=>onDoorClick("red"));

/* ===========================
   Gear menu → Profile routing (NO signin fallback)
=========================== */
const gearBtn=document.getElementById("gearBtn");
const gearMenu=document.getElementById("gearMenu");
const profileBtn=document.getElementById("profileBtn");

gearBtn.addEventListener("click",(e)=>{ e.stopPropagation(); gearMenu.classList.toggle("show") });
document.addEventListener("click",()=>gearMenu.classList.remove("show"));

profileBtn.addEventListener("click", ()=>{
  const mode=(localStorage.getItem("profileMode")||"anonymous").toLowerCase();
  track("menu_profile_click",{mode});
  if(mode==="verified"){ window.location.href="Profile-verified.html" }
  else { window.location.href="Profile-anonymous.html" }
});

/* ===========================
   INIT
=========================== */
(function init(){
  track("page_view",{page:"secret-invite"});
})();
</script>
</body>
</html>
