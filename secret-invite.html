<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Le Libido – Secret Invite</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#e1bf78;
    --black:#000;
    --white:#fff;
    --blue:#67B2FF;
    --green:#06954E;
    --red:#950606;
    --modal-max:560px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--black);color:var(--white);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif}
  .page-wrap{min-height:100svh;padding:20px;border:2px solid var(--gold);position:relative}

  /* Logo with extra space beneath for hierarchy */
  .header{display:flex;align-items:center;justify-content:center;margin-bottom:28px}
  .logo{display:block;margin:0 auto;max-width:140px;width:140px;height:auto}

  /* Areas (multi-select tags) */
  .areas-wrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;margin:-6px 0 12px}
  .areas-title{font-size:14px;opacity:.9}
  .areas{display:flex;flex-wrap:wrap;gap:8px;justify-content:center}
  .tag{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid var(--gold);padding:8px 10px;border-radius:10px;
    cursor:pointer;user-select:none;
  }
  .tag input{accent-color:var(--gold)}

  /* Doors grid */
  .doors{
    display:grid;
    grid-template-columns:repeat(3,minmax(0,1fr));
    gap:18px;
    align-items:start;
    max-width:1100px;
    margin:10px auto 0;
  }
  .door{display:flex;flex-direction:column;align-items:center}

  /* Caption directly above door */
  .door-caption{
    font-size:15px;font-weight:700;letter-spacing:.2px;line-height:1.1;
    margin:0 0 4px 0;
  }
  .caption-blue{color:var(--blue)}
  .caption-green{color:var(--green)}
  .caption-red{color:var(--red)}

  /* Clickable door = only the image, no invisible box */
  .door-btn{
    display:block;border:none;background:transparent;padding:0;margin:0;cursor:pointer;
    width:100%;max-width:360px;
  }
  .door-btn img{
    display:block;width:100%;height:auto;object-fit:contain;background:transparent;
    user-select:none;-webkit-user-drag:none;pointer-events:none;
  }

  /* Single caption directly under each door (colored) */
  .enter-caption{
    margin-top:6px;
    font-size:14px;
    font-weight:700;
    line-height:1.2;
    letter-spacing:.2px;
  }
  .enter-blue{color:var(--blue)}
  .enter-green{color:var(--green)}
  .enter-red{color:var(--red)}

  /* Locked feedback */
  .shake{animation:shake .45s ease}
  @keyframes shake{
    10%,90%{transform:translateX(-1px)}
    20%,80%{transform:translateX(2px)}
    30%,50%,70%{transform:translateX(-4px)}
    40%,60%{transform:translateX(4px)}
  }

  /* Modal (universal) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
  .modal-backdrop.show{display:flex}
  .modal{width:100%;max-width:var(--modal-max);background:#0f0f0f;border:2px solid var(--gold);border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.6)}
  .modal-head{padding:14px 18px;border-bottom:1px solid #222;display:flex;align-items:center;justify-content:space-between}
  .modal-title{margin:0;font-size:20px;font-weight:800;letter-spacing:.2px;color:var(--gold)}
  .modal-close{background:transparent;border:none;color:var(--white);font-size:22px;cursor:pointer;line-height:1}
  .modal-body{padding:18px}
  .pill{display:inline-block;border:1px solid var(--gold);color:var(--gold);padding:6px 10px;border-radius:999px;font-size:12px;margin-bottom:10px}
  .invite-card{border:1px solid var(--gold);border-radius:12px;padding:16px;margin-top:10px;background:#111}
  .invite-brand{font-size:14px;opacity:.85;margin-bottom:8px}
  .invite-h1{margin:0 0 10px 0;font-size:22px;font-weight:700;line-height:1.25}
  .meta{display:grid;grid-template-columns:1fr;gap:8px;margin:12px 0}
  .meta div{font-size:14px;opacity:.95}
  .buttons{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .btn{border:1px solid var(--gold);background:transparent;color:var(--gold);padding:12px;border-radius:10px;cursor:pointer;font-weight:700;text-align:center;text-decoration:none}
  .btn.primary{background:var(--gold);color:#111;border-color:var(--gold)}
  .btn:disabled{opacity:.4;cursor:not-allowed}
  .tiny{font-size:12px;opacity:.8;margin-top:6px}

  /* Dynamic color accents */
  .theme-red .modal-head{background:linear-gradient(0deg, rgba(149,6,6,.25), rgba(149,6,6,.25))}
  .theme-green .modal-head{background:linear-gradient(0deg, rgba(6,149,78,.25), rgba(6,149,78,.25))}
  .theme-blue .modal-head{background:linear-gradient(0deg, rgba(6,77,149,.25), rgba(6,77,149,.25))}
  .theme-red .invite-card{background:rgba(149,6,6,.1)}
  .theme-green .invite-card{background:rgba(6,149,78,.1)}
  .theme-blue .invite-card{background:rgba(6,77,149,.1)}

  /* Blur utility */
  .blurred{filter:blur(6px);user-select:none}

  @media (max-width:1000px){ .doors{grid-template-columns:1fr;max-width:520px} }
</style>
</head>
<body>
<div class="page-wrap">
  <!-- Logo -->
  <header class="header">
    <img class="logo" src="golden-le-libido-logo.png" alt="Le Libido" loading="lazy">
  </header>

  <!-- Areas (multi-select) -->
  <div class="areas-wrap">
    <span class="areas-title">Your area(s):</span>
    <div class="areas" id="areas"></div>
  </div>

  <!-- Doors -->
  <section class="doors">
    <!-- BLUE -->
    <div class="door" data-color="blue">
      <div class="door-caption caption-blue">For the Romantic</div>
      <button class="door-btn" id="door-blue" aria-label="Blue room door">
        <img id="door-blue-img" alt="Blue door" src="" />
      </button>
      <div class="enter-caption enter-blue">Click door to enter the blue room</div>
    </div>

    <!-- GREEN -->
    <div class="door" data-color="green">
      <div class="door-caption caption-green">For the Frisky</div>
      <button class="door-btn" id="door-green" aria-label="Green room door">
        <img id="door-green-img" alt="Green door" src="" />
      </button>
      <div class="enter-caption enter-green">Click door to enter the green room</div>
    </div>

    <!-- RED -->
    <div class="door" data-color="red">
      <div class="door-caption caption-red">For the Kinky</div>
      <button class="door-btn" id="door-red" aria-label="Red room door">
        <img id="door-red-img" alt="Red door" src="" />
      </button>
      <div class="enter-caption enter-red">Click door to enter the red room</div>
    </div>
  </section>
</div>

<!-- Universal Modal -->
<div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
  <div class="modal" id="modal">
    <div class="modal-head">
      <h2 class="modal-title" id="modalTitle">Want to Come?</h2>
      <button class="modal-close" id="modalClose" aria-label="Close">×</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
/* ===========================
   Archetype → color (from localStorage)
=========================== */
const slugToTitle = {
  'devoted_darling':'Devoted Darling','mood_multiplier':'Mood Multiplier','tender_protector':'Tender Protector','heatwave':'Heatwave',
  'promiscuous_plaything':'Promiscuous Plaything','generous_giver':'Generous Giver','bedroom_adventurer':'Bedroom Adventurer','charmer_in_charge':'Charmer in Charge',
  'punish_me':'Punish Me','provoker':'Provoker','dungeon_master':'Dungeon Master','claimed_and_trained':'Claimed & Trained'
};
const roomMap = {
  'Tender Protector':'blue','Devoted Darling':'blue','Mood Multiplier':'blue','Heatwave':'blue',
  'Promiscuous Plaything':'green','Generous Giver':'green','Bedroom Adventurer':'green','Charmer in Charge':'green',
  'Dungeon Master':'red','Provoker':'red','Punish Me':'red','Claimed & Trained':'red'
};
function getArchetypeColor(){
  const c=(localStorage.getItem("archetypeColor")||"").toLowerCase();
  if(['blue','green','red'].includes(c)) return c;
  const raw=localStorage.getItem('archetype')||'Mood Multiplier';
  const title=slugToTitle[raw]||raw;
  return (roomMap[title]||'blue');
}

/* ===========================
   Areas + venues
=========================== */
const AREAS = [
  { id:"central-nj", label:"Central New Jersey" }
];

const VENUES_BY_AREA = {
  "central-nj":[
    { name:"Metropolitan Cafe", address:"8 E Main St, Freehold, NJ 07728", time:"7:30 PM", maps:"https://www.google.com/maps/search/?api=1&query=Metropolitan+Cafe+8+E+Main+St,+Freehold,+NJ+07728" },
    { name:"Nonna’s Cucina", address:"448 US-9, Englishtown, NJ 07726", time:"7:30 PM", maps:"https://www.google.com/maps/search/?api=1&query=Nonna%E2%80%99s+Cucina+448+US-9,+Englishtown,+NJ+07726" }
  ],
};

/* =========
   Themes
=========== */
const THEMES_BASE = [
  "Heaven vs. Hell: dress up as an Angel or Devil",
  "Cats vs. Dogs: wear playful ears, whiskers, or puppy vibes.",
  "Brain vs. Brawn: dress up as a nerd or jock",
  "Light vs. Dark: wear either all white or an all black",
  "Burlesque & Cabaret: wear either corsets, fishnets, feathers, garters, silk gloves, or an outfit with swagger",
  "Fetish Fantasy: dress up in leather, lace, or latex",
  "Sexy Uniform: dress up as a nurse, cop, teacher, construction worker, etc.",
  "Slumber Party Gone Wild: wear either lingerie, pajamas, silk robes, messy bed hair.",
  "Primal Instincts: wear either leopard, snake, panther, or other primal animal",
  "Neon Nights: dress up in UV paint, mesh, sheer, bright colors, glow-in-the-dark.",
  "Mobster & Mob Wife: dress up in either fur coats, cigars, pinstripes, suits",
  "Goth night: wear black outfit, heavy makeup, straightened hair, etc.",
  "After Dark at the Office: dress up in a power suit, secretary outfit, or as a boss",
  "Flasher: wear a trench coat, white t-shirt, short skirt, completely unbuttoned collared shirt",
  "Vampires and Velvet: dress up in dark velvet, draw on bite marks, blood-red lipstick, or just mysterious vibes",
  "Magic: dress up as a witch or wizard"
];
function dayOfYear(d=new Date()){
  const start=new Date(d.getFullYear(),0,1);
  const diff=d - start;
  return Math.floor(diff/86400000);
}
function themeForColor(color){
  const colorOffset = {blue:0, green:1, red:2}[color] ?? 0;
  const idx = (dayOfYear() + colorOffset) % THEMES_BASE.length;
  return THEMES_BASE[idx];
}
const COLOR_CLASS = { blue:"theme-blue", green:"theme-green", red:"theme-red" };

/* ===========================
   Area persistence helpers (multi-select)
=========================== */
const AREAS_KEY="lelibido:selectedAreas";
function getSelectedAreas(){
  try{
    const raw=localStorage.getItem(AREAS_KEY);
    if(raw){
      const a=JSON.parse(raw);
      if(Array.isArray(a) && a.length) return a;
    }
  }catch(e){}
  return ["central-nj"];
}
function setSelectedAreas(arr){ localStorage.setItem(AREAS_KEY, JSON.stringify(arr)) }

/* Render area checkboxes (multi-select) */
const areasEl=document.getElementById("areas");
function renderAreas(){
  const selected=new Set(getSelectedAreas());
  areasEl.innerHTML="";
  AREAS.forEach(a=>{
    const id=`area-${a.id}`;
    const tag=document.createElement("label");
    tag.className="tag";
    tag.htmlFor=id;
    tag.innerHTML=`<input type="checkbox" id="${id}" ${selected.has(a.id)?"checked":""}> ${a.label}`;
    areasEl.appendChild(tag);
  });
}
renderAreas();

// Auto-save when an area checkbox is toggled (keeps at least one selected)
areasEl.addEventListener("change", (e)=>{
  if(e.target && e.target.matches('input[type="checkbox"]')){
    const chosen=[];
    areasEl.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      if(cb.checked) chosen.push(cb.id.replace("area-",""));
    });
    if(!chosen.length){
      const fallbackId = "central-nj";
      const fallbackCb = areasEl.querySelector(`#area-${fallbackId}`);
      if(fallbackCb){
        fallbackCb.checked = true;
      }
      chosen.push(fallbackId);
    }
    setSelectedAreas(chosen);
  }
});

/* Utilities */
function selectedAreasWithVenues(){
  const saved=getSelectedAreas();
  const hasVenues=saved.filter(a=>(VENUES_BY_AREA[a]||[]).length>0);
  return hasVenues.length?hasVenues:["central-nj"];
}
function weekNumber(date=new Date()){
  const d=new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-dayNum);
  const yearStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
  return Math.ceil((((d-yearStart)/86400000)+1)/7);
}
function pickAreaForColor(color){
  const areas=selectedAreasWithVenues();
  if(areas.length===1) return areas[0];
  const colorOffset={blue:0,green:1,red:2}[color]??0;
  const idx=(weekNumber()+colorOffset) % areas.length;
  return areas[idx];
}
function venueFor(areaId, color){
  const list = VENUES_BY_AREA[areaId]||[];
  if(!list.length) return null;
  const colorOffset={blue:0,green:1,red:2}[color]??0;
  const idx = (weekNumber()+colorOffset) % list.length;
  return list[idx];
}
function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` }
function formatLongDateTime(dateObj, timeLabel){
  const dateStr = dateObj.toLocaleDateString(undefined,{weekday:'long', year:'numeric', month:'long', day:'numeric'});
  return `${dateStr} at ${timeLabel}`;
}
function parseTimeOnDate(dateObj, timeLabel){
  const m = timeLabel.match(/^\s*(\d{1,2}):(\d{2})\s*([AP]M)\s*$/i);
  let h=19, min=30;
  if(m){
    h = parseInt(m[1],10);
    min = parseInt(m[2],10);
    const ampm = m[3].toUpperCase();
    if(ampm==="PM" && h<12) h+=12;
    if(ampm==="AM" && h===12) h=0;
  }
  const d = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate(), h, min, 0, 0);
  return d;
}

/* ===========================
   Door frames
=========================== */
const DOOR_FRAMES = {
  blue: Array.from({length:7},(_,i)=>`door/blue-door-${i+1}.png`),
  green: Array.from({length:7},(_,i)=>`door/green-door-${i+1}.png`),
  red: Array.from({length:7},(_,i)=>`door/red-door-${i+1}.png`)
};
const DOOR_CLOSED = { blue: DOOR_FRAMES.blue[0], green: DOOR_FRAMES.green[0], red: DOOR_FRAMES.red[0] };

const doorImg={
  blue:document.getElementById("door-blue-img"),
  green:document.getElementById("door-green-img"),
  red:document.getElementById("door-red-img")
};
const doorBtn={
  blue:document.getElementById("door-blue"),
  green:document.getElementById("door-green"),
  red:document.getElementById("door-red")
};
doorImg.blue.src=DOOR_CLOSED.blue;
doorImg.green.src=DOOR_CLOSED.green;
doorImg.red.src=DOOR_CLOSED.red;
["blue","green","red"].forEach(c=>DOOR_FRAMES[c].forEach(src=>{const i=new Image();i.src=src;}));

/* Faster animation */
function playDoorAnimation(color){
  const frames=DOOR_FRAMES[color]; const img=doorImg[color];
  return new Promise(resolve=>{
    let i=0;
    const step=()=>{ img.src=frames[i]; i++; if(i<frames.length){ setTimeout(step,120) } else { resolve() } };
    step();
  });
}

/* ===========================
   Entitlements
=========================== */
const ACCESS_KEY="lelibido:entitlements";
function readAccess(){ try{ return JSON.parse(localStorage.getItem(ACCESS_KEY)||"{}") }catch(e){ return {} } }
function writeAccess(obj){ localStorage.setItem(ACCESS_KEY, JSON.stringify(obj)) }
function grantAccess({date, tier, color}){
  const data=readAccess(); data[date]=data[date]||{all:false,colors:{}};
  if(tier==="all") data[date].all=true; else if(color){ data[date].colors[color]=true; }
  writeAccess(data);
}
function hasAccess({date, color}){ const d=readAccess()[date]; return !!(d && (d.all || (d.colors && d.colors[color]))) }

/* ===========================
   Stripe Checkout
=========================== */
async function startCheckout(tier, color, areaId) {
  const date = todayStr();
  const successBase = location.origin + location.pathname;

  const resp = await fetch('/.netlify/functions/checkout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ tier, color, area: areaId, date, successBase })
  });

  if (!resp.ok) {
    alert('Could not start checkout. Please try again.');
    return;
  }
  const { url } = await resp.json();
  if (url) {
    location.href = url;
  } else {
    alert('Checkout session failed.');
  }
}
(function handleReturnFromStripe(){
  const params=new URLSearchParams(location.search);
  const paid=params.get("paid");
  const date=params.get("date");
  const color=params.get("color");
  const area =params.get("area") || pickAreaForColor(color||"blue");
  if(paid && date){
    grantAccess({date, tier: paid==="all"?"all":"single", color});
    const theme=themeForColor(color||"blue");
    const venue=venueFor(area, color||"blue");
    history.replaceState({}, "", location.pathname);
    playDoorAnimation(color||"blue").then(()=> showInvitation({color:color||"blue", venue, theme}));
  }
})();

/* ===========================
   Modal / Calendar helpers
=========================== */
function roomLabel(color){ return `${color[0].toUpperCase()+color.slice(1)} Room` }
function makeICS({title, description, locationText, startLocal, durationMinutes=120}){
  const TZID = "America/New_York";
  const pad = (n)=> String(n).padStart(2,"0");
  const fmtLocal = (d)=>{
    const y = d.getFullYear();
    const m = pad(d.getMonth()+1);
    const day = pad(d.getDate());
    const hh = pad(d.getHours());
    const mm = pad(d.getMinutes());
    const ss = "00";
    return `${y}${m}${day}T${hh}${mm}${ss}`;
  };

  const dtStartLocal = fmtLocal(startLocal);
  const dtEndLocal = fmtLocal(new Date(startLocal.getTime() + durationMinutes*60000));
  const uid = `lelibido-${Math.random().toString(36).slice(2)}@lelibido.com`;

  const ics = [
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//Le Libido//Secret Invite//EN",
    "CALSCALE:GREGORIAN",
    "METHOD:PUBLISH",
    "BEGIN:VEVENT",
    `UID:${uid}`,
    `DTSTAMP:${fmtLocal(new Date())}`,
    `DTSTART;TZID=${TZID}:${dtStartLocal}`,
    `DTEND;TZID=${TZID}:${dtEndLocal}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${description.replace(/\n/g,'\\n')}`,
    `LOCATION:${locationText}`,
    "END:VEVENT",
    "END:VCALENDAR"
  ].join("\r\n");

  return new Blob([ics], {type:"text/calendar"});
}

const modalBackdrop=document.getElementById("modalBackdrop");
const modal=document.getElementById("modal");
const modalBody=document.getElementById("modalBody");
const modalTitle=document.getElementById("modalTitle");
const modalClose=document.getElementById("modalClose");
modalClose.addEventListener("click", ()=>{ modalBackdrop.classList.remove("show"); modal.className="modal" });

function showInvitation({color,venue,theme}){
  modal.className="modal "+(COLOR_CLASS[color]||"");
  modalTitle.textContent="Meet Your Type Tonight";
  const today = new Date();
  const startLabel = venue?.time ?? "7:30 PM";
  const startsText = formatLongDateTime(today, startLabel);
  const themeLine = theme;
  const room = roomLabel(color);

  // Content
  modalBody.innerHTML=`
    <div class="invite-card">
      <div class="invite-brand">${room}</div>
      <h3 class="invite-h1">${venue?.name ?? "TBA"}</h3>
      <div class="meta">
        <div><strong>Address:</strong> ${venue?.address ?? "TBA"}</div>
        <div><strong>Starts:</strong> ${startsText}</div>
        <div><strong>Theme:</strong> ${themeLine}</div>
      </div>
      <div class="buttons">
        <a class="btn" href="${venue?.maps ?? "#"}" target="_blank" rel="noopener">Directions to venue</a>
        <a class="btn primary" id="addToCalendarBtn">Add to calendar</a>
      </div>
    </div>
  `;
  modalBackdrop.classList.add("show");

  // Calendar routing
  const startLocal = parseTimeOnDate(today, startLabel);
  const title = `${room} • ${theme.split(':')[0]}`;
  const description = themeLine;
  const locationText = `${venue?.name ?? ""} — ${venue?.address ?? ""}`;
  const addBtn = document.getElementById("addToCalendarBtn");

  // Robust iOS browser detection (treat Chrome/Brave/Firefox/Edge/DuckDuckGo as non-Safari)
  const ua = navigator.userAgent;
  const isIOS = /iPad|iPhone|iPod/.test(ua);
  const isCriOS = /\bCriOS\b/i.test(ua);        // Chrome on iOS
  const isFxiOS = /\bFxiOS\b/i.test(ua);        // Firefox on iOS
  const isEdgiOS = /\bEdgiOS\b/i.test(ua);      // Edge on iOS
  const isBrave = /\bBrave\b/i.test(ua);        // Brave on iOS
  const isDuckDuckGo = /\bDuckDuckGo\b/i.test(ua); // DuckDuckGo on iOS
  const isSafari =
    isIOS &&
    /\bSafari\b/i.test(ua) &&
    !(isCriOS || isFxiOS || isEdgiOS || isBrave || isDuckDuckGo);

  // Google Calendar URL helper
  function two(n){ return String(n).padStart(2,'0'); }
  function gcalDate(d){ return `${d.getFullYear()}${two(d.getMonth()+1)}${two(d.getDate())}T${two(d.getHours())}${two(d.getMinutes())}00`; }
  const endLocal = new Date(startLocal.getTime() + 120*60000);
  const datesParam = `${gcalDate(startLocal)}/${gcalDate(endLocal)}`;
  const gcalUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&details=${encodeURIComponent(description)}&location=${encodeURIComponent(locationText)}&dates=${datesParam}&ctz=America/New_York`;

  if (isIOS && !isSafari) {
    // iOS non-Safari (Chrome/Brave/Firefox/Edge/DuckDuckGo) → Google Calendar (app or web)
    addBtn.setAttribute("href", gcalUrl);
    addBtn.setAttribute("target", "_blank");
    addBtn.removeAttribute("download");

    const note = document.createElement('div');
    note.className = 'tiny';
    note.textContent = 'Using Apple Calendar? Open this page in Safari.';
    addBtn.parentElement.appendChild(note);
  } else {
    // Safari (iOS/macOS) + all desktop → ICS Blob flow
    const icsBlob = makeICS({ title, description, locationText, startLocal });
    const url = URL.createObjectURL(icsBlob);
    addBtn.setAttribute("href", url);
    addBtn.setAttribute("download", `${room.toLowerCase().replace(/\s+/g,'-')}-${todayStr()}.ics`);

    // Desktop convenience: also offer Google Calendar link
    if (!isIOS) {
      const alt = document.createElement('a');
      alt.className = 'tiny';
      alt.href = gcalUrl;
      alt.target = '_blank';
      alt.rel = 'noopener';
      alt.style.display = 'inline-block';
      alt.style.marginTop = '6px';
      alt.textContent = 'Prefer Google Calendar? Click here.';
      addBtn.parentElement.appendChild(alt);
    }
  }
}

function showLockedPaywall({color,venue,theme,areaId}){
  modal.className="modal "+(COLOR_CLASS[color]||"");
  modalTitle.textContent="Want to Come?";
  const startLabel = venue?.time ?? "7:30 PM";
  const startsText = formatLongDateTime(new Date(), startLabel);
  modalBody.innerHTML=`
    <div class="invite-card">
      <div class="invite-brand">${roomLabel(color)} • Exclusive Access</div>
      <h3 class="invite-h1 blurred">${venue?.name ?? "Secret Venue"}</h3>
      <div class="meta">
        <div class="blurred"><strong>Address:</strong> ${venue?.address ?? "Hidden for now"}</div>
        <div><strong>Starts:</strong> ${startsText}</div>
        <div><strong>Theme:</strong> <span class="blurred">${theme}</span></div>
      </div>
      <div class="buttons">
        <a class="btn primary" id="paySingleBtn" href="#">Gain access to the ${color} room tonight for only $2</a>
        <a class="btn" id="payAllBtn" href="#">Gain access to every room tonight for only $3</a>
      </div>
    </div>
  `;
  modalBackdrop.classList.add("show");

  const singleBtn = document.getElementById("paySingleBtn");
  const allBtn    = document.getElementById("payAllBtn");

  singleBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    startCheckout('single', color, areaId);
  });
  allBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    startCheckout('all', color, areaId);
  });
}

/* ===========================
   Locked feedback
=========================== */
function lockedEffect(el){ el.classList.remove("shake"); void el.offsetWidth; el.classList.add("shake"); if(navigator.vibrate){ try{ navigator.vibrate(80) }catch(e){} } }

/* ===========================
   Door click handling
=========================== */
async function onDoorClick(color){
  const myColor = getArchetypeColor();
  const theme   = themeForColor(color);
  const areaId  = pickAreaForColor(color);
  const venue   = venueFor(areaId, color);
  const today   = todayStr();

  if (color === myColor || hasAccess({date: today, color})) {
    await playDoorAnimation(color);
    showInvitation({color, venue, theme});
  } else {
    lockedEffect(doorBtn[color]);
    setTimeout(()=>showLockedPaywall({color, venue, theme, areaId}), 220);
  }
}
doorBtn.blue.addEventListener("click", ()=>onDoorClick("blue"));
doorBtn.green.addEventListener("click", ()=>onDoorClick("green"));
doorBtn.red  .addEventListener("click", ()=>onDoorClick("red"));

/* ===========================
   Init
=========================== */
(function init(){
  // Closed frames already assigned; everything else is event-driven
})();
</script>
</body>
</html>