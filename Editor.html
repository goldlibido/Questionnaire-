<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Blindfold Audio Mixer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
<style>
  body{margin:0;font-family:Montserrat;background:#0d0d0d;color:#fff;display:flex;flex-direction:column;align-items:center;height:100vh;overflow:hidden}
  h1{font-size:18px;color:#e1bf78;margin:10px}
  #timeline{flex:1;width:100%;border-top:2px solid #e1bf78;border-bottom:2px solid #e1bf78;position:relative;overflow-x:auto;white-space:nowrap}
  .clip{display:inline-block;background:#064D95;color:#fff;padding:6px 12px;border-radius:6px;cursor:move;position:absolute;top:10px}
  #controls{margin:6px}
  button{background:#e1bf78;color:#000;border:none;padding:8px 16px;margin:2px;border-radius:8px;cursor:pointer;font-weight:700}
  #library{width:100%;overflow-x:auto;white-space:nowrap;background:#111;padding:6px;display:flex}
  .sound{background:#06954E;color:#fff;padding:8px 12px;margin-right:6px;border-radius:6px;cursor:grab;flex-shrink:0}
</style>
</head>
<body>
  <h1>üé∂ Blindfold Audio Mixer</h1>
  <div id="controls">
    <button id="play">‚ñ∂Ô∏é Play</button>
    <button id="stop">‚èπ Stop</button>
    <button id="export">‚¨á Export</button>
    <input type="file" id="fileInput" accept="audio/*" style="display:none" />
  </div>
  <div id="timeline"></div>
  <div id="library"></div>

<script>
const ctx = new (window.AudioContext||window.webkitAudioContext)();
let clips=[]; let sources=[]; const timeline=document.getElementById("timeline");

function addClip(buffer,name,x=0){
  const el=document.createElement("div");
  el.className="clip"; el.textContent=name; el.style.left=x+"px";
  timeline.appendChild(el);
  clips.push({el,buffer,start:x/50});
  el.draggable=true;
  el.ondragend=e=>{
    let left=Math.max(0,e.pageX - timeline.offsetLeft-50 + timeline.scrollLeft);
    el.style.left=left+"px";
    clips.find(c=>c.el===el).start=left/50;
  };
}

// Upload from Voice Memos
document.getElementById("timeline").onclick=()=>document.getElementById("fileInput").click();
document.getElementById("fileInput").onchange=async e=>{
  const file=e.target.files[0]; if(!file) return;
  const arr=await file.arrayBuffer(); const buf=await ctx.decodeAudioData(arr);
  addClip(buf,file.name);
};

// Play/Stop
document.getElementById("play").onclick=()=>{
  if(ctx.state==="suspended") ctx.resume();
  sources=[]; const now=ctx.currentTime+0.1;
  clips.forEach(c=>{
    let s=ctx.createBufferSource(); s.buffer=c.buffer;
    s.connect(ctx.destination); s.start(now+c.start);
    sources.push(s);
  });
};
document.getElementById("stop").onclick=()=>{sources.forEach(s=>{try{s.stop();}catch{}});sources=[];};

// Export
document.getElementById("export").onclick=async()=>{
  const length=Math.max(...clips.map(c=>c.start+c.buffer.duration));
  const offCtx=new OfflineAudioContext(1,44100*length,44100);
  clips.forEach(c=>{
    const src=offCtx.createBufferSource(); src.buffer=c.buffer;
    src.connect(offCtx.destination); src.start(c.start);
  });
  const rendered=await offCtx.startRendering();
  const wav=bufferToWav(rendered);
  const blob=new Blob([new DataView(wav)],{type:"audio/wav"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="mix.wav"; a.click();
};

// Preloaded library
const sounds=[
  {name:"Chime",url:"https://actions.google.com/sounds/v1/alarms/beep_short.ogg"},
  {name:"River",url:"https://actions.google.com/sounds/v1/water/stream.ogg"},
  {name:"Drum",url:"https://actions.google.com/sounds/v1/alarms/beep_short.ogg"}
];
const lib=document.getElementById("library");
sounds.forEach(s=>{
  const div=document.createElement("div"); div.className="sound"; div.textContent=s.name;
  div.draggable=true; lib.appendChild(div);
  div.ondragstart=async e=>{
    if(!s.buffer){ const r=await fetch(s.url); const a=await r.arrayBuffer(); s.buffer=await ctx.decodeAudioData(a); }
    e.dataTransfer.setData("soundName",s.name);
    window.dragBuffer=s.buffer;
  };
});
timeline.ondragover=e=>e.preventDefault();
timeline.ondrop=e=>{
  e.preventDefault();
  const buf=window.dragBuffer; if(!buf) return;
  const name=e.dataTransfer.getData("soundName");
  const left=e.pageX - timeline.offsetLeft + timeline.scrollLeft;
  addClip(buf,name,left);
};

// util: AudioBuffer ‚Üí WAV
function bufferToWav(buffer){
  let numOfChan=buffer.numberOfChannels, length=buffer.length*numOfChan*2+44;
  let b=new ArrayBuffer(length), v=new DataView(b), ch=[], i, sample, pos=0;
  setUint32(0x46464952); setUint32(length-8); setUint32(0x45564157);
  setUint32(0x20746d66); setUint32(16); setUint16(1);
  setUint16(numOfChan); setUint32(buffer.sampleRate);
  setUint32(buffer.sampleRate*2*numOfChan); setUint16(numOfChan*2); setUint16(16);
  setUint32(0x61746164); setUint32(length-44);
  for(i=0;i<buffer.numberOfChannels;i++) ch.push(buffer.getChannelData(i));
  let offset=0;
  while(pos<length){
    for(i=0;i<numOfChan;i++){
      sample=Math.max(-1,Math.min(1,ch[i][offset]));
      v.setInt16(pos+44, sample<0?sample*0x8000:sample*0x7FFF, true);
      pos+=2;
    }
    offset++;
  }
  return b;
  function setUint16(d){v.setUint16(pos,d,true);pos+=2;}
  function setUint32(d){v.setUint32(pos,d,true);pos+=4;}
}
</script>
</body>
</html>