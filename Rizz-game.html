<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Le Libido ‚Äî Blind Pickup Lines</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --gold:#e1bf78; --blue:#064D95; --green:#06954E; --red:#950606;
    --bg:#0d0d0d; --card:#151515; --muted:#b9b9b9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#fff}
  .border-wrap{min-height:100vh;padding:2px;background:linear-gradient(100deg,var(--red),var(--blue),var(--green))}
  .app{min-height:calc(100vh - 4px);background:var(--bg);display:flex;flex-direction:column;align-items:center}
  header{width:100%;padding:22px 16px 8px;text-align:center}
  header img{width:120px;height:auto;display:block;margin:0 auto 10px;filter:drop-shadow(0 0 10px rgba(225,191,120,.25))}
  .title{font-weight:800;letter-spacing:.5px;font-size:clamp(20px,3vw,28px);text-shadow:0 0 8px rgba(225,191,120,.25)}
  .steps{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:6px 16px 14px;width:100%}
  .step-pill{padding:8px 12px;border:1px solid rgba(225,191,120,.3);border-radius:999px;color:#fff;font-weight:600;font-size:12px;opacity:.6;user-select:none}
  .step-pill.active{opacity:1;border-color:var(--gold);box-shadow:0 0 14px rgba(225,191,120,.2) inset}
  .panel{width:min(1100px,94vw);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;margin:10px auto 28px;box-shadow:0 25px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02)}
  .panel h2{margin:6px 8px 14px;font-size:18px;font-weight:800;letter-spacing:.3px}
  .grid{display:grid;gap:14px}
  .grid.cols-2{grid-template-columns:1fr 1fr}
  @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 18px;background:linear-gradient(180deg,#1e1e1e,#121212);color:#fff;font-weight:700;letter-spacing:.3px;cursor:pointer;border:1px solid rgba(255,255,255,.08);transition:.2s transform,.2s box-shadow,.2s background}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .btn.gold{background:linear-gradient(180deg,#f4d796,#c9a760);color:#111;border:1px solid #d7b56f;text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .hidden{display:none !important}
  label{font-size:12px;color:#e5e5e5;margin-bottom:6px;display:block}
  input[type="text"],select{width:100%;padding:12px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#111;color:#fff;outline:none;font-size:14px;touch-action:manipulation}
  .rec-wrap{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px dashed rgba(255,255,255,.15);border-radius:14px;padding:16px}
  .record-btn{width:160px;height:160px;border-radius:999px;border:1px solid rgba(255,255,255,.15);cursor:pointer;background:radial-gradient(closest-side, rgba(225,191,120,.25) 0%, rgba(225,191,120,0) 78%),linear-gradient(180deg,#272727,#161616);color:#fff;font-weight:800;font-size:15px;letter-spacing:.5px;box-shadow:0 20px 60px rgba(0,0,0,.45),0 0 0 6px rgba(225,191,120,.08) inset}
  .rec-indicator{width:10px;height:10px;background:#f34a4a;border-radius:50%;box-shadow:0 0 12px rgba(243,74,74,.9);display:inline-block;margin-right:8px;vertical-align:middle;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.65}100%{transform:scale(1);opacity:1}}
  .player{display:flex;align-items:center;gap:12px;margin-top:14px}
  .play-toggle{width:46px;height:46px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:#151515;color:#fff;font-weight:800;cursor:pointer}
  .bar{flex:1;height:10px;background:#0f0f0f;border-radius:999px;position:relative;border:1px solid rgba(255,255,255,.1);overflow:hidden;cursor:pointer}
  .bar .fill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,var(--red),var(--blue),var(--green));border-right:2px solid rgba(255,255,255,.5)}
  .time{font-size:12px;color:var(--muted);width:74px;text-align:right}
  .photo-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .photo{position:relative;padding-top:100%;background:#0f0f0f;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden}
  .photo input{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:2}
  .photo .hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:12px;z-index:1}
  .photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
  .photo .overlay{position:absolute;left:8px;bottom:8px;display:flex;gap:6px;z-index:3}
  .pill{padding:6px 9px;border-radius:999px;font-size:11px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(3px);cursor:pointer}
  .pill:hover{background:rgba(0,0,0,.75)}
  .deck{position:relative;height:420px;border-radius:16px;overflow:hidden;background:#0f0f10;border:1px solid rgba(255,255,255,.08)}
  .card{position:absolute;inset:0;padding:18px;display:flex;flex-direction:column;justify-content:flex-end;background:radial-gradient(1200px 500px at 100% -10%, rgba(255,255,255,.06), transparent 70%),linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01))}
  .swipe-actions{display:flex;gap:10px}
  .pass,.like{flex:1;padding:12px 14px;border-radius:10px;font-weight:800;border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .pass{background:#151515;color:#ddd}
  .like{background:linear-gradient(180deg,#f4d796,#bf9a55);color:#111}
  .match-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
  .match-box{width:min(520px,92vw);background:#121212;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;text-align:center}
  .chat{height:420px;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1);background:#0f0f10}
  .chat-log{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.35}
  .me{align-self:flex-end;background:#172015;border:1px solid rgba(225,191,120,.25)}
  .them{align-self:flex-start;background:#141414;border:1px solid rgba(255,255,255,.12)}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.08);background:#101010}
  .composer input[type="text"]{flex:1;background:#0f0f0f;border:1px solid rgba(255,255,255,.12)}
  .small{font-size:12px;color:var(--muted)}
  .tip{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="border-wrap">
  <div class="app">
    <header>
      <img src="golden-le-libido-logo.png" alt="Le Libido" onerror="this.style.opacity=.0">
      <div class="title">Blind Pickup Lines</div>
      <div class="small">One line. Pure chemistry. Profiles unlock only on a match.</div>
    </header>

    <div class="steps" id="stepper">
      <div class="step-pill active">1 ‚Ä¢ Record</div>
      <div class="step-pill">2 ‚Ä¢ Profile</div>
      <div class="step-pill">3 ‚Ä¢ Swipe</div>
      <div class="step-pill">4 ‚Ä¢ Chat</div>
    </div>

    <!-- STEP 1: RECORD -->
    <section class="panel" id="step1">
      <h2>Step 1 ‚Äî Your pickup line</h2>
      <div class="grid cols-2">
        <div class="rec-wrap">
          <div class="row" style="align-items:center; justify-content:center; gap:18px; margin-bottom:12px">
            <button class="record-btn" id="recordBtn"><span id="recLabel">Start Recording</span></button>
            <div>
              <div class="small">Tap once to start, tap again to stop. Keep it under 10s for best vibes.</div>
              <div class="tip">iOS/Safari supported. Works over HTTPS and requires microphone permission.</div>
            </div>
          </div>
          <div id="playerBlock" class="hidden">
            <div class="player">
              <button class="play-toggle" id="playToggle">‚ñ∂</button>
              <div class="bar" id="seekBar"><div class="fill" id="fill"></div></div>
              <div class="time" id="time">0:00</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="retakeBtn">Retake</button>
              <button class="btn gold" id="toProfileBtn">Looks good ‚Üí</button>
            </div>
            <audio id="audio" preload="metadata" class="hidden"></audio>
          </div>
        </div>
        <div class="rec-wrap">
          <strong>Great pickup lines are:</strong>
          <ul style="margin-top:8px; color:#ddd; line-height:1.5">
            <li>Short, playful, unexpected</li>
            <li>Flirty without being cringey</li>
            <li>Specific (reference the moment or setting)</li>
          </ul>
          <div class="tip">Example: ‚ÄúIf we matched, I‚Äôll bring the coffee. You bring the story of how we met.‚Äù</div>
        </div>
      </div>
    </section>

    <!-- STEP 2: PROFILE -->
    <section class="panel hidden" id="step2">
      <h2>Step 2 ‚Äî Build your profile</h2>
      <div class="grid cols-2">
        <div>
          <label>Photos (2√ó2 grid)</label>
          <div class="photo-grid" id="photoGrid">
            <!-- 4 clickable slots -->
            <div class="photo" data-idx="0">
              <input type="file" accept="image/*" />
              <div class="hint">Tap to add</div>
              <div class="overlay hidden">
                <div class="pill change">Change</div>
                <div class="pill remove">‚úï</div>
              </div>
            </div>
            <div class="photo" data-idx="1">
              <input type="file" accept="image/*" />
              <div class="hint">Tap to add</div>
              <div class="overlay hidden">
                <div class="pill change">Change</div>
                <div class="pill remove">‚úï</div>
              </div>
            </div>
            <div class="photo" data-idx="2">
              <input type="file" accept="image/*" />
              <div class="hint">Tap to add</div>
              <div class="overlay hidden">
                <div class="pill change">Change</div>
                <div class="pill remove">‚úï</div>
              </div>
            </div>
            <div class="photo" data-idx="3">
              <input type="file" accept="image/*" />
              <div class="hint">Tap to add</div>
              <div class="overlay hidden">
                <div class="pill change">Change</div>
                <div class="pill remove">‚úï</div>
              </div>
            </div>
          </div>
          <div class="tip">Previews appear instantly. You can change or remove any photo.</div>
        </div>
        <div>
          <div class="grid cols-2">
            <div>
              <label>Name</label>
              <input type="text" id="name" placeholder="Enter your first name" autocomplete="name">
            </div>
            <div>
              <label>Age</label>
              <select id="age"></select>
            </div>
            <div>
              <label>Height</label>
              <select id="height"></select>
            </div>
            <div>
              <label>Gender</label>
              <select id="gender">
                <option value="" selected disabled>Choose</option>
                <option>Man</option><option>Woman</option><option>Other</option>
              </select>
            </div>
            <div>
              <label>I‚Äôm into</label>
              <select id="into">
                <option value="" selected disabled>Choose</option>
                <option>Men</option><option>Women</option><option>Both</option>
              </select>
            </div>
            <div>
              <label>Turn-on vocabulary</label>
              <select id="vocab">
                <option>Prefer not to say</option><option>Babe</option><option>Baby</option><option>Sexy</option>
                <option>Fucker</option><option>Brat</option><option>Good girl</option><option>Good boy</option>
                <option>Slave</option><option>Goddess</option><option>Master</option>
              </select>
            </div>
            <div>
              <label>My type (looks)</label>
              <select id="looks">
                <option>Prefer not to say</option><option>Tall</option><option>Short</option><option>Thin</option><option>Curvy</option>
                <option>Muscular</option><option>Tan</option><option>Pale</option><option>Blonde</option><option>Brunette</option>
                <option>Redhead</option><option>Latin</option><option>Asian</option><option>Black</option><option>Jewish</option>
                <option>Arab</option><option>Indian</option>
              </select>
            </div>
            <div>
              <label>My type (personality)</label>
              <select id="personality">
                <option>Prefer not to say</option><option>Funny</option><option>Smart</option><option>Playful</option>
                <option>Bold</option><option>Chill</option><option>Talkative</option><option>Shy</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:14px">
            <button class="btn ghost" id="backToRecorder">‚Üê Back</button>
            <button class="btn gold" id="saveProfile">Save & Start Swiping ‚Üí</button>
          </div>
          <div class="tip">Your full profile is hidden. People only hear your pickup line unless you both match.</div>
        </div>
      </div>
    </section>

    <!-- STEP 3: SWIPE (demo deck kept) -->
    <section class="panel hidden" id="step3">
      <h2>Step 3 ‚Äî Swipe pickup lines</h2>
      <div class="deck" id="deck"></div>
      <div class="tip">Only the voice line shows here. Profiles unlock after a mutual like.</div>
    </section>

    <!-- STEP 4: CHAT (local demo) -->
    <section class="panel hidden" id="step4">
      <h2>Private Chat</h2>
      <div class="chat" id="chat">
        <div class="chat-log" id="chatLog"></div>
        <div class="composer">
          <input type="text" id="chatInput" placeholder="Type a message‚Ä¶" />
          <input type="file" id="chatPhoto" accept="image/*" class="hidden">
          <button class="btn" id="chatPhotoBtn">üì∑</button>
          <button class="btn" id="chatVoiceBtn">üéôÔ∏è</button>
          <button class="btn gold" id="chatSendBtn">Send</button>
        </div>
        <div class="tip">You can exchange pictures and voice memos here.</div>
      </div>
    </section>

    <!-- MATCH MODAL -->
    <div class="match-modal" id="matchModal" role="dialog" aria-modal="true">
      <div class="match-box">
        <h3>It‚Äôs a Match!</h3>
        <p>You both liked each other‚Äôs pickup line. Full profile unlocked.</p>
        <div id="matchProfile" class="small" style="text-align:left; background:#0f0f0f; border:1px solid rgba(255,255,255,.1); padding:12px; border-radius:10px; margin-bottom:12px"></div>
        <div class="row" style="justify-content:center">
          <button class="btn ghost" id="closeMatch">Keep Swiping</button>
          <button class="btn gold" id="openChat">Open Chat</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
  /***** FIREBASE IMPORTS *****/
  import { app, db } from './firebase-config.js'; // <- keep your file as provided
  import {
    getAuth, signInAnonymously, onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import {
    getStorage, ref as sRef, uploadBytes, getDownloadURL
  } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js';
  import {
    ref as rRef, set, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';

  const auth = getAuth(app);
  const storage = getStorage(app);

  // Auto sign-in (required by your Storage/DB rules)
  let currentUser = null;
  try{ await signInAnonymously(auth); }catch(e){ console.error('Anon sign-in failed', e); }
  onAuthStateChanged(auth, u => { currentUser = u || null; });

  /***** UTIL + NAV *****/
  const $ = sel => document.querySelector(sel);
  const stepper = $('#stepper').children;
  function go(idx){
    ['#step1','#step2','#step3','#step4'].forEach((id,i)=>{
      const el = document.querySelector(id);
      if(i===idx){ el.classList.remove('hidden'); stepper[i].classList.add('active'); }
      else { el.classList.add('hidden'); stepper[i].classList.remove('active'); }
    });
    window.scrollTo({top:0,behavior:'smooth'});
  }
  Array.from(stepper).forEach((pill, idx)=>{
    pill.style.cursor='pointer';
    pill.addEventListener('click', ()=>{
      if(idx===1 && !window.__recBlob){ alert('Record your pickup line first.'); return; }
      if(idx===2 && !localStorage.getItem('ll_user_profile')){ /* allowed ‚Äì user might go to swipe without save */ }
      if(idx===3 && !localStorage.getItem('ll_user_profile')){ alert('Open a match from the swipe deck.'); return; }
      go(idx);
      if(idx===2 && !window.__deckInit){ initDeck(); }
    });
  });

  /***** RECORDING *****/
  const recordBtn = $('#recordBtn'), recLabel = $('#recLabel');
  const audioEl = $('#audio'), playerBlock = $('#playerBlock');
  const playToggle = $('#playToggle'), seekBar = $('#seekBar'), fill = $('#fill'), time = $('#time');
  const toProfileBtn = $('#toProfileBtn'), retakeBtn = $('#retakeBtn');

  function supportedMime(){
    const c = ['audio/webm;codecs=opus','audio/mp4;codecs=aac','audio/webm','audio/ogg;codecs=opus','audio/mp4','audio/aac'];
    for(const t of c){ if(window.MediaRecorder?.isTypeSupported?.(t)) return t; }
    return '';
  }

  let mediaRecorder, recChunks=[], recStream=null, recMime='', recording=false;
  window.__recBlob = null; // pickup line blob

  async function startRecording(){
    try{
      recMime = supportedMime();
      recStream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(recStream, recMime?{mimeType:recMime}:undefined);
      recChunks = [];
      mediaRecorder.ondataavailable = e => { if(e.data?.size) recChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        window.__recBlob = new Blob(recChunks, { type: recMime || 'audio/webm' });
        const url = URL.createObjectURL(window.__recBlob);
        audioEl.src = url;
        playerBlock.classList.remove('hidden');
        updateTime(0, audioEl.duration || 0);
      };
      mediaRecorder.start();
      recording=true;
      recLabel.innerHTML='<span class="rec-indicator"></span> Recording‚Ä¶';
    }catch(err){
      alert('Microphone access failed. Please allow mic permission and use HTTPS.');
      console.error(err);
    }
  }
  function stopRecording(){
    if(mediaRecorder && recording){
      mediaRecorder.stop();
      recStream && recStream.getTracks().forEach(t=>t.stop());
      recording=false; recLabel.textContent='Start Recording';
    }
  }
  recordBtn.addEventListener('click', ()=> recording ? stopRecording() : startRecording());

  function fmt(s){ s=Math.floor(s); const m=Math.floor(s/60), r=s%60; return `${m}:${r.toString().padStart(2,'0')}`; }
  function updateTime(c,d){ time.textContent=`${fmt(c)} / ${d?fmt(d):'0:00'}`; }
  playToggle.addEventListener('click', ()=>{ if(audioEl.paused){ audioEl.play(); playToggle.textContent='‚è∏'; } else { audioEl.pause(); playToggle.textContent='‚ñ∂'; }});
  audioEl.addEventListener('pause', ()=> playToggle.textContent='‚ñ∂');
  audioEl.addEventListener('play', ()=> playToggle.textContent='‚è∏');
  audioEl.addEventListener('timeupdate', ()=>{
    const d=audioEl.duration||0, c=audioEl.currentTime||0, pct=d?(c/d)*100:0;
    fill.style.inset=`0 ${100-pct}% 0 0`;
    updateTime(c,d);
  });
  seekBar.addEventListener('click',(e)=>{ const r=seekBar.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; if(audioEl.duration) audioEl.currentTime=x*audioEl.duration; });
  retakeBtn.addEventListener('click', ()=>{ if(!audioEl.paused) audioEl.pause(); playerBlock.classList.add('hidden'); window.__recBlob=null; audioEl.removeAttribute('src'); });

  toProfileBtn.addEventListener('click', ()=>{ if(!window.__recBlob){ alert('Record your pickup line first.'); return; } go(1); });

  /***** PROFILE BUILDER *****/
  const ageSel = $('#age'), heightSel = $('#height');
  (function buildAge(){
    const frag=document.createDocumentFragment(); const ph=document.createElement('option');
    ph.value=''; ph.textContent='Choose'; ph.disabled=true; ph.selected=true; frag.appendChild(ph);
    for(let a=18;a<=99;a++){ const o=document.createElement('option'); o.textContent=a; frag.appendChild(o); }
    ageSel.appendChild(frag);
  })();
  (function buildHeight(){
    const frag=document.createDocumentFragment();
    const u=document.createElement('option'); u.textContent='Under 5 feet'; frag.appendChild(u);
    for(let f=5; f<=7; f++){ for(let i=0;i<12;i++){ const o=document.createElement('option'); o.textContent=`${f}‚Äô${i}‚Äù`; frag.appendChild(o); } }
    const o7=document.createElement('option'); o7.textContent='Over 7 feet'; frag.appendChild(o7);
    heightSel.appendChild(frag);
  })();

  // iOS first-tap picker fix
  const selectIds = ['#age','#height','#gender','#into','#vocab','#looks','#personality'];
  selectIds.forEach(id=>{
    const el = document.querySelector(id);
    el.addEventListener('pointerdown', (e)=>{
      if(typeof el.showPicker === 'function'){ el.showPicker(); e.preventDefault(); }
    }, {passive:false});
  });

  $('#backToRecorder').addEventListener('click', ()=> go(0));

  // Photo grid state
  const photoGrid = $('#photoGrid');
  const photoFiles = [null,null,null,null]; // File objects per slot

  // Make whole tile reliably clickable on iOS (no double-tap)
  photoGrid.querySelectorAll('.photo').forEach(tile=>{
    const input = tile.querySelector('input[type="file"]');
    const overlay = tile.querySelector('.overlay');
    const idx = +tile.dataset.idx;

    // click tile to open picker
    tile.addEventListener('click', (e)=>{
      // if clicking overlay buttons, ignore
      if(e.target.classList.contains('change') || e.target.classList.contains('remove')) return;
      if(input){ input.click(); }
    });

    // also open picker on first touch
    tile.addEventListener('pointerdown', (e)=>{
      if(e.pointerType==='touch' && e.target===tile && input){ input.click(); e.preventDefault(); }
    }, {passive:false});

    // change handler ‚Üí preview & controls
    input.addEventListener('change', ()=>{
      const file = input.files?.[0];
      if(!file) return;
      photoFiles[idx] = file;
      const img = tile.querySelector('img') || document.createElement('img');
      tile.querySelector('.hint')?.remove();
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; tile.appendChild(img); overlay.classList.remove('hidden'); };
      reader.readAsDataURL(file);
    });

    // overlay controls
    overlay.querySelector('.change').addEventListener('click', (e)=>{ e.stopPropagation(); input.click(); });
    overlay.querySelector('.remove').addEventListener('click', (e)=>{
      e.stopPropagation();
      photoFiles[idx] = null;
      input.value = '';
      tile.querySelector('img')?.remove();
      overlay.classList.add('hidden');
      if(!tile.querySelector('.hint')){
        const h=document.createElement('div'); h.className='hint'; h.textContent='Tap to add'; tile.appendChild(h);
      }
    });
  });

  // Save profile ‚Üí upload audio+photos ‚Üí DB
  const profile = {};
  $('#saveProfile').addEventListener('click', async ()=>{
    if(!currentUser){ alert('Please wait, connecting‚Ä¶'); return; }
    if(!window.__recBlob){ alert('Record your pickup line first.'); return; }

    const required = {
      name: $('#name').value.trim(), age: $('#age').value, gender: $('#gender').value, into: $('#into').value
    };
    if(!required.name || !required.age || !required.gender || !required.into){
      alert('Please complete Name, Age, Gender, and I‚Äôm into.');
      return;
    }

    // minimal optimistic UI
    const btn = $('#saveProfile'); const old = btn.textContent; btn.disabled=true; btn.textContent='Saving‚Ä¶';

    try{
      // 1) Upload pickup line
      const ts = Date.now();
      const audioPath = `lines/${currentUser.uid}/${ts}.webm`;
      const audioRef = sRef(storage, audioPath);
      await uploadBytes(audioRef, window.__recBlob, {contentType: window.__recBlob.type || 'audio/webm'});
      const audioURL = await getDownloadURL(audioRef);

      // 2) Upload photos (only selected)
      const photoURLs = [];
      for(let i=0;i<photoFiles.length;i++){
        const f = photoFiles[i];
        if(!f) { photoURLs.push(null); continue; }
        const ext = (f.type && f.type.split('/')[1]) || 'jpg';
        const imgRef = sRef(storage, `profiles/${currentUser.uid}/photo${i}.${ext}`);
        await uploadBytes(imgRef, f, {contentType:f.type || 'image/jpeg'});
        const url = await getDownloadURL(imgRef);
        photoURLs.push(url);
      }

      // 3) Write profile to RTDB
      const data = {
        uid: currentUser.uid,
        name: required.name,
        age: required.age,
        height: $('#height').value || '',
        gender: required.gender,
        into: required.into,
        vocab: $('#vocab').value || 'Prefer not to say',
        looks: $('#looks').value || 'Prefer not to say',
        personality: $('#personality').value || 'Prefer not to say',
        photos: photoURLs,
        lineURL: audioURL,
        ts: serverTimestamp()
      };
      await set(rRef(db, `profiles/${currentUser.uid}`), data);

      localStorage.setItem('ll_user_profile', JSON.stringify(data));
      // proceed to swipe
      go(2);
      initDeck();
    }catch(err){
      console.error(err);
      alert('Save failed. Check internet / Firebase config and try again.');
    }finally{
      btn.disabled=false; btn.textContent=old;
    }
  });

  /***** SWIPE DEMO (same as before) *****/
  const demoPeople = [
    { id:'p1', name:'Ari', age:27, gender:'Woman', into:'Men', looks:'Brunette', personality:'Playful', line:'If we match, I call dibs on the first story.' },
    { id:'p2', name:'Jules', age:31, gender:'Man', into:'Women', looks:'Tall', personality:'Bold', line:'Are you my algorithm? Because you just solved something.' },
    { id:'p3', name:'Rowan', age:24, gender:'Other', into:'Both', looks:'Curvy', personality:'Smart', line:'Tell me your hot take. I‚Äôll bring the popcorn.' },
    { id:'p4', name:'Kai', age:29, gender:'Man', into:'Both', looks:'Muscular', personality:'Chill', line:'Two truths and a drink? I‚Äôll start.' },
    { id:'p5', name:'Sage', age:26, gender:'Woman', into:'Men', looks:'Blonde', personality:'Funny', line:'I‚Äôm collecting meet-cute stories. Want to be chapter one?' },
  ];
  async function makeBeepWav(seconds=1, freq=660){
    const rate=44100, frames=rate*seconds, amp=0.2;
    const buffer=new Float32Array(frames);
    for(let i=0;i<frames;i++) buffer[i]=Math.sin(2*Math.PI*freq*(i/rate))*amp;
    return pcm16ToWav(buffer, rate);
  }
  function pcm16ToWav(float32, sampleRate){
    const bytesPerSample=2, blockAlign=bytesPerSample*1;
    const buf=new ArrayBuffer(44 + float32.length*2); const v=new DataView(buf);
    let o=0; const wstr=s=>{ for(let i=0;i<s.length;i++) v.setUint8(o++, s.charCodeAt(i)); };
    const wint16=x=>{ v.setInt16(o,x,true); o+=2; };
    const wuint16=x=>{ v.setUint16(o,x,true); o+=2; };
    const wuint32=x=>{ v.setUint32(o,x,true); o+=4; };
    wstr('RIFF'); wuint32(36+float32.length*2); wstr('WAVE'); wstr('fmt '); wuint32(16); wuint16(1); wuint16(1);
    wuint32(sampleRate); wuint32(sampleRate*blockAlign); wuint16(blockAlign); wuint16(16); wstr('data'); wuint32(float32.length*2);
    for(let i=0;i<float32.length;i++){ let s=Math.max(-1,Math.min(1,float32[i])); wint16(s<0 ? s*0x8000 : s*0x7FFF); }
    return new Blob([buf], {type:'audio/wav'});
  }

  let deck=[], deckIdx=0; window.__deckInit=false;
  async function initDeck(){
    window.__deckInit=true;
    deck = await Promise.all(demoPeople.map(async p => {
      const b = await makeBeepWav(.9, 520 + Math.floor(Math.random()*260));
      return {...p, audioUrl: URL.createObjectURL(b)};
    }));
    renderCard();
  }
  function renderCard(){
    const container = $('#deck'); container.innerHTML='';
    if(deckIdx>=deck.length){
      const empty = document.createElement('div');
      empty.className='card';
      empty.innerHTML = `<h3>That‚Äôs all for now</h3><div class="small">New pickup lines appear as more people join.</div>
        <div class="row"><button class="btn gold" onclick="deckIdx=0; renderCard()">Replay demo</button></div>`;
      container.appendChild(empty); return;
    }
    const p = deck[deckIdx];
    const card = document.createElement('div'); card.className='card';
    card.innerHTML = `
      <div class="small">üéß Voice only. Profiles unlock on a match.</div>
      <div class="rec-wrap">
        <div class="player">
          <button class="play-toggle">‚ñ∂</button>
          <div class="bar"><div class="fill"></div></div>
          <div class="time">0:00</div>
        </div>
        <div class="tip" style="margin-top:8px">Transcript: ‚Äú${p.line}‚Äù</div>
        <audio preload="metadata" class="hidden"></audio>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="pass">Pass</button>
        <button class="like">Like</button>
      </div>
    `;
    container.appendChild(card);
    const audio = card.querySelector('audio'); audio.src=p.audioUrl;
    const playBtn = card.querySelector('.play-toggle');
    const bar = card.querySelector('.bar'), fill = card.querySelector('.fill'), tm = card.querySelector('.time');

    const fmt = s=>{ s=Math.floor(s); const m=Math.floor(s/60), r=s%60; return `${m}:${r.toString().padStart(2,'0')}`; };
    playBtn.addEventListener('click', ()=>{ if(audio.paused){ audio.play(); playBtn.textContent='‚è∏'; } else { audio.pause(); playBtn.textContent='‚ñ∂'; }});
    audio.addEventListener('pause', ()=> playBtn.textContent='‚ñ∂');
    audio.addEventListener('play', ()=> playBtn.textContent='‚è∏');
    audio.addEventListener('timeupdate', ()=>{
      const d=audio.duration||0, c=audio.currentTime||0, pct=d?(c/d)*100:0;
      fill.style.inset=`0 ${100-pct}% 0 0`; tm.textContent=`${fmt(c)} / ${d?fmt(d):'0:00'}`;
    });
    bar.addEventListener('click',(e)=>{ const r=bar.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; if(audio.duration) audio.currentTime=x*audio.duration; });

    card.querySelector('.pass').addEventListener('click', ()=>{ audio.pause(); deckIdx++; renderCard(); });
    card.querySelector('.like').addEventListener('click', ()=>{
      audio.pause();
      if(Math.random()<0.5){ showMatch(p); } else { deckIdx++; renderCard(); }
    });
  }
  function showMatch(person){
    const m = document.getElementById('matchModal'); const box = document.getElementById('matchProfile');
    const details = [
      ['Name', person.name],['Age', person.age],['Gender', person.gender],['I‚Äôm into', person.into],
      ['Looks', person.looks],['Personality', person.personality]
    ].map(([k,v])=>`<div><strong>${k}:</strong> ${v}</div>`).join('');
    box.innerHTML = details; m.style.display='flex';
    document.getElementById('closeMatch').onclick = ()=>{ m.style.display='none'; deckIdx++; renderCard(); };
    document.getElementById('openChat').onclick = ()=>{ m.style.display='none'; go(3); pushBubble('them', `Loved your line. Now that we matched, hi‚ÄîI‚Äôm ${person.name}.`); };
  }

  /***** CHAT DEMO *****/
  const chatLog = document.getElementById('chatLog');
  function pushBubble(who, content, type='text'){
    const b=document.createElement('div'); b.className=`bubble ${who}`;
    if(type==='text') b.textContent=content;
    if(type==='image'){ const img=document.createElement('img'); img.src=content; b.appendChild(img); }
    if(type==='audio'){ const a=document.createElement('audio'); a.controls=true; a.src=content; b.appendChild(a); }
    chatLog.appendChild(b); chatLog.scrollTop=chatLog.scrollHeight;
  }
  document.getElementById('chatSendBtn').addEventListener('click', ()=>{
    const input=document.getElementById('chatInput'); const val=input.value.trim(); if(!val) return;
    pushBubble('me', val, 'text'); input.value='';
    setTimeout(()=> pushBubble('them','Your voice has main-character energy.'), 1200);
  });
  document.getElementById('chatPhotoBtn').addEventListener('click', ()=> document.getElementById('chatPhoto').click());
  document.getElementById('chatPhoto').addEventListener('change', ()=>{
    const f = document.getElementById('chatPhoto').files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=e=> pushBubble('me', e.target.result, 'image'); r.readAsDataURL(f);
  });

  // Simple voice memo in chat
  let chatRec=null, chatChunks=[], chatStream=null, chatMime='';
  document.getElementById('chatVoiceBtn').addEventListener('click', async (e)=>{
    const btn = e.currentTarget;
    if(!chatRec){
      try{
        chatMime = supportedMime();
        chatStream = await navigator.mediaDevices.getUserMedia({audio:true});
        chatRec = new MediaRecorder(chatStream, chatMime?{mimeType:chatMime}:undefined);
        chatChunks = [];
        chatRec.ondataavailable = ev => { if(ev.data?.size) chatChunks.push(ev.data); };
        chatRec.onstop = ()=>{
          const blob=new Blob(chatChunks,{type:chatMime||'audio/webm'});
          const url=URL.createObjectURL(blob);
          pushBubble('me', url, 'audio');
        };
        chatRec.start(); btn.textContent='‚èπÔ∏è';
      }catch(err){ alert('Mic access needed.'); console.error(err); chatRec=null; chatStream?.getTracks().forEach(t=>t.stop()); }
    }else{
      chatRec.stop(); chatStream?.getTracks().forEach(t=>t.stop()); chatRec=null; btn.textContent='üéôÔ∏è';
    }
  });

  // Start on step 1
  go(0);
</script>
</body>
</html>