<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Le Libido ‚Äî Blind Pickup Lines</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{ --gold:#e1bf78; --blue:#064D95; --green:#06954E; --red:#950606; --bg:#0d0d0d; --card:#151515; --muted:#b9b9b9; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:#fff}
  .border-wrap{min-height:100vh;padding:2px;background:linear-gradient(100deg,var(--red),var(--blue),var(--green))}
  .app{min-height:calc(100vh - 4px);background:var(--bg);display:flex;flex-direction:column;align-items:center}
  header{width:100%;padding:22px 16px 8px;text-align:center}
  header img{width:120px;height:auto;display:block;margin:0 auto 10px;filter:drop-shadow(0 0 10px rgba(225,191,120,.25))}
  .title{font-weight:800;letter-spacing:.5px;font-size:clamp(20px,3vw,28px);text-shadow:0 0 8px rgba(225,191,120,.25)}
  .steps{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:6px 16px 14px;width:100%}
  .step-pill{padding:8px 12px;border:1px solid rgba(225,191,120,.3);border-radius:999px;color:#fff;font-weight:600;font-size:12px;opacity:.6;user-select:none}
  .step-pill.active{opacity:1;border-color:var(--gold);box-shadow:0 0 14px rgba(225,191,120,.2) inset}
  .panel{width:min(1100px,94vw);background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:18px;margin:10px auto 28px;box-shadow:0 25px 60px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.02)}
  .panel h2{margin:6px 8px 14px;font-size:18px;font-weight:800;letter-spacing:.3px}
  .grid{display:grid;gap:14px} .grid.cols-2{grid-template-columns:1fr 1fr} @media (max-width:800px){.grid.cols-2{grid-template-columns:1fr}}
  .btn{appearance:none;border:0;border-radius:12px;padding:14px 18px;background:linear-gradient(180deg,#1e1e1e,#121212);color:#fff;font-weight:700;letter-spacing:.3px;cursor:pointer;border:1px solid rgba(255,255,255,.08);transition:.2s transform,.2s box-shadow,.2s background}
  .btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .btn.gold{background:linear-gradient(180deg,#f4d796,#c9a760);color:#111;border:1px solid #d7b56f;text-shadow:0 1px 0 rgba(255,255,255,.35)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.18)}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center} .hidden{display:none !important}
  label{font-size:12px;color:#e5e5e5;margin-bottom:6px;display:block}
  input[type="text"],select,input[list]{width:100%;padding:12px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#111;color:#fff;outline:none;font-size:14px}
  .rec-wrap{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px dashed rgba(255,255,255,.15);border-radius:14px;padding:16px}
  .record-btn{width:160px;height:160px;border-radius:999px;border:1px solid rgba(255,255,255,.15);cursor:pointer;background:radial-gradient(closest-side, rgba(225,191,120,.25) 0%, rgba(225,191,120,0) 78%),linear-gradient(180deg,#272727,#161616);color:#fff;font-weight:800;font-size:15px;letter-spacing:.5px;box-shadow:0 20px 60px rgba(0,0,0,.45),0 0 0 6px rgba(225,191,120,.08) inset}
  .rec-indicator{width:10px;height:10px;background:#f34a4a;border-radius:50%;box-shadow:0 0 12px rgba(243,74,74,.9);display:inline-block;margin-right:8px;vertical-align:middle;animation:pulse 1s infinite}
  @keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(1.3);opacity:.65}100%{transform:scale(1);opacity:1}}
  .player{display:flex;align-items:center;gap:12px;margin-top:14px}
  .play-toggle{width:46px;height:46px;border-radius:50%;border:1px solid rgba(255,255,255,.15);background:#151515;color:#fff;font-weight:800;cursor:pointer}
  .bar{flex:1;height:10px;background:#0f0f0f;border-radius:999px;position:relative;border:1px solid rgba(255,255,255,.1);overflow:hidden;cursor:pointer}
  .bar .fill{position:absolute;inset:0 100% 0 0;background:linear-gradient(90deg,var(--red),var(--blue),var(--green));border-right:2px solid rgba(255,255,255,.5)}
  .time{font-size:12px;color:var(--muted);width:74px;text-align:right}
  .photo-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .photo{position:relative;padding-top:100%;background:#0f0f0f;border:1px solid rgba(255,255,255,.1);border-radius:12px;overflow:hidden}
  .photo input{position:absolute;inset:0;opacity:0;cursor:pointer;z-index:2}
  .photo .hint{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:12px;z-index:1}
  .photo img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
  .photo .overlay{position:absolute;left:8px;bottom:8px;display:flex;gap:6px;z-index:3}
  .pill{padding:6px 9px;border-radius:999px;font-size:11px;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.25);backdrop-filter:blur(3px);cursor:pointer}
  .pill:hover{background:rgba(0,0,0,.75)}
  .deck{position:relative;height:420px;border-radius:16px;overflow:hidden;background:#0f0f10;border:1px solid rgba(255,255,255,.08)}
  .card{position:absolute;inset:0;padding:18px;display:flex;flex-direction:column;justify-content:flex-end;background:radial-gradient(1200px 500px at 100% -10%, rgba(255,255,255,.06), transparent 70%),linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01))}
  .swipe-actions{display:flex;gap:10px}
  .pass,.like{flex:1;padding:12px 14px;border-radius:10px;font-weight:800;border:1px solid rgba(255,255,255,.12);cursor:pointer}
  .pass{background:#151515;color:#ddd}
  .like{background:linear-gradient(180deg,#f4d796,#bf9a55);color:#111}
  .match-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
  .match-box{width:min(520px,92vw);background:#121212;border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:18px;text-align:center}
  .chat{height:420px;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.1);background:#0f0f10}
  .chat-log{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
  .bubble{max-width:78%;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.35}
  .me{align-self:flex-end;background:#172015;border:1px solid rgba(225,191,120,.25)}
  .them{align-self:flex-start;background:#141414;border:1px solid rgba(255,255,255,.12)}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,.08);background:#101010}
  .composer input[type="text"]{flex:1;background:#0f0f0f;border:1px solid rgba(255,255,255,.12)}
  .small{font-size:12px;color:var(--muted)} .tip{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
<div class="border-wrap">
  <div class="app">
    <header>
      <img src="golden-le-libido-logo.png" alt="Le Libido" onerror="this.style.opacity=.0">
      <div class="title">Blind Pickup Lines</div>
      <div class="small">One line. Pure chemistry. Profiles unlock only on a match.</div>
    </header>

    <div class="steps" id="stepper">
      <div class="step-pill active">1 ‚Ä¢ Record</div>
      <div class="step-pill">2 ‚Ä¢ Profile</div>
      <div class="step-pill">3 ‚Ä¢ Swipe</div>
      <div class="step-pill">4 ‚Ä¢ Chat</div>
    </div>

    <!-- STEP 1 -->
    <section class="panel" id="step1">
      <h2>Step 1 ‚Äî Your pickup line</h2>
      <div class="grid cols-2">
        <div class="rec-wrap">
          <div class="row" style="align-items:center; justify-content:center; gap:18px; margin-bottom:12px">
            <button class="record-btn" id="recordBtn"><span id="recLabel">Start Recording</span></button>
            <div>
              <div class="small">Tap once to start, tap again to stop. Keep it under 10s for best vibes.</div>
              <div class="tip">Use HTTPS and allow mic permission.</div>
            </div>
          </div>
          <div id="playerBlock" class="hidden">
            <div class="player">
              <button class="play-toggle" id="playToggle">‚ñ∂</button>
              <div class="bar" id="seekBar"><div class="fill" id="fill"></div></div>
              <div class="time" id="time">0:00</div>
            </div>
            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="retakeBtn">Retake</button>
              <button class="btn gold" id="toProfileBtn">Looks good ‚Üí</button>
            </div>
            <audio id="audio" preload="metadata" class="hidden"></audio>
          </div>
        </div>
        <div class="rec-wrap">
          <strong>Great pickup lines are:</strong>
          <ul style="margin-top:8px; color:#ddd; line-height:1.5">
            <li>Short, playful, unexpected</li>
            <li>Flirty without being cringey</li>
            <li>Specific to the moment</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="panel hidden" id="step2">
      <h2>Step 2 ‚Äî Build your profile</h2>
      <div class="grid cols-2">
        <div>
          <label>Photos (2√ó2 grid)</label>
          <div class="photo-grid" id="photoGrid">
            <div class="photo" data-idx="0">
              <input type="file" accept="image/*"><div class="hint">Tap to add</div>
              <div class="overlay hidden"><div class="pill change">Change</div><div class="pill remove">‚úï</div></div>
            </div>
            <div class="photo" data-idx="1">
              <input type="file" accept="image/*"><div class="hint">Tap to add</div>
              <div class="overlay hidden"><div class="pill change">Change</div><div class="pill remove">‚úï</div></div>
            </div>
            <div class="photo" data-idx="2">
              <input type="file" accept="image/*"><div class="hint">Tap to add</div>
              <div class="overlay hidden"><div class="pill change">Change</div><div class="pill remove">‚úï</div></div>
            </div>
            <div class="photo" data-idx="3">
              <input type="file" accept="image/*"><div class="hint">Tap to add</div>
              <div class="overlay hidden"><div class="pill change">Change</div><div class="pill remove">‚úï</div></div>
            </div>
          </div>
          <div class="tip">Previews appear instantly. You can change or remove any photo.</div>
        </div>
        <div>
          <div class="grid cols-2">
            <div><label>Name</label><input type="text" id="name" placeholder="First name" autocomplete="name"></div>
            <div><label>Age</label><select id="age"></select></div>
            <div><label>Height</label><select id="height"></select></div>
            <div><label>Gender</label><select id="gender"><option value="" selected disabled>Choose</option><option>Man</option><option>Woman</option><option>Other</option></select></div>
            <div><label>I‚Äôm into</label><select id="into"><option value="" selected disabled>Choose</option><option>Men</option><option>Women</option><option>Both</option></select></div>

            <!-- changed to typeahead inputs with datalist -->
            <div>
              <label>Turn-on vocabulary</label>
              <input list="vocabOptions" id="vocabInput" placeholder="Type or pick‚Ä¶"/>
              <datalist id="vocabOptions">
                <option value="Prefer not to say"></option>
                <option value="Babe"></option><option value="Baby"></option><option value="Sexy"></option>
                <option value="Fucker"></option><option value="Brat"></option><option value="Good girl"></option><option value="Good boy"></option>
                <option value="Slave"></option><option value="Goddess"></option><option value="Master"></option>
              </datalist>
            </div>
            <div>
              <label>My type (looks)</label>
              <input list="looksOptions" id="looksInput" placeholder="Type or pick‚Ä¶"/>
              <datalist id="looksOptions">
                <option value="Prefer not to say"></option>
                <option value="Tall"></option><option value="Short"></option><option value="Thin"></option><option value="Curvy"></option><option value="Muscular"></option>
                <option value="Tan"></option><option value="Pale"></option>
                <option value="Blonde"></option><option value="Brunette"></option><option value="Redhead"></option>
                <option value="Latin"></option><option value="Asian"></option><option value="Black"></option>
                <option value="Jewish"></option><option value="Arab"></option><option value="Indian"></option>
              </datalist>
            </div>
            <div>
              <label>My type (personality)</label>
              <input list="personalityOptions" id="personalityInput" placeholder="Type or pick‚Ä¶"/>
              <datalist id="personalityOptions">
                <option value="Prefer not to say"></option>
                <option value="Funny"></option><option value="Smart"></option><option value="Playful"></option>
                <option value="Bold"></option><option value="Chill"></option><option value="Talkative"></option><option value="Shy"></option>
              </datalist>
            </div>
          </div>
          <div class="row" style="margin-top:14px">
            <button class="btn ghost" id="backToRecorder">‚Üê Back</button>
            <button class="btn gold" id="saveProfile">Save & Start Swiping ‚Üí</button>
          </div>
          <div class="tip">Your full profile stays hidden. Only your line is public until a mutual match.</div>
        </div>
      </div>
    </section>

    <!-- STEP 3 -->
    <section class="panel hidden" id="step3">
      <h2>Step 3 ‚Äî Swipe pickup lines</h2>
      <div class="deck" id="deck"></div>
      <div class="tip">Only the voice line shows here. Profiles unlock after a mutual like.</div>
    </section>

    <!-- STEP 4 -->
    <section class="panel hidden" id="step4">
      <h2>Private Chat</h2>
      <div class="chat" id="chat">
        <div class="chat-log" id="chatLog"></div>
        <div class="composer">
          <input type="text" id="chatInput" placeholder="Type a message‚Ä¶" />
          <input type="file" id="chatPhoto" accept="image/*" class="hidden">
          <button class="btn" id="chatPhotoBtn">üì∑</button>
          <button class="btn" id="chatVoiceBtn">üéôÔ∏è</button>
          <button class="btn gold" id="chatSendBtn">Send</button>
        </div>
        <div class="tip">Share pics and voice memos. Messages save to your match room.</div>
      </div>
    </section>

    <!-- MATCH MODAL -->
    <div class="match-modal" id="matchModal" role="dialog" aria-modal="true">
      <div class="match-box">
        <h3>It‚Äôs a Match!</h3>
        <p>You both liked each other‚Äôs pickup line. Full profile unlocked.</p>
        <div id="matchProfile" class="small" style="text-align:left; background:#0f0f0f; border:1px solid rgba(255,255,255,.1); padding:12px; border-radius:10px; margin-bottom:12px"></div>
        <div class="row" style="justify-content:center">
          <button class="btn ghost" id="closeMatch">Keep Swiping</button>
          <button class="btn gold" id="openChat">Open Chat</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase + App logic -->
<script type="module">
  /***** FIREBASE IMPORTS *****/
  import { app, db } from './firebase-config.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js';
  import { ref as rRef, set, update, get, onValue, push, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';

  const auth = getAuth(app);
  const storage = getStorage(app);
  let currentUser = null;
  try{ await signInAnonymously(auth); }catch(e){ console.error('Anon sign-in failed', e); }
  onAuthStateChanged(auth, u => { currentUser = u || null; });

  /***** NAV / STEPS *****/
  const $ = s => document.querySelector(s);
  const stepper = $('#stepper').children;
  function go(i){
    ['#step1','#step2','#step3','#step4'].forEach((id,idx)=>{
      const el = $(id);
      if(idx===i){ el.classList.remove('hidden'); stepper[idx].classList.add('active'); }
      else { el.classList.add('hidden'); stepper[idx].classList.remove('active'); }
    });
    window.scrollTo({top:0,behavior:'smooth'});
  }
  Array.from(stepper).forEach((pill, idx)=>{
    pill.style.cursor='pointer';
    pill.addEventListener('click', ()=>{
      if(idx===1 && !window.__recBlob){ alert('Record your pickup line first.'); return; }
      if(idx===3 && !window.__activeRoom){ alert('Open a match from the deck to chat.'); return; }
      go(idx);
      if(idx===2 && !window.__deckInit) initDeck();
    });
  });

  /***** RECORDING *****/
  const recordBtn = $('#recordBtn'), recLabel = $('#recLabel');
  const audioEl = $('#audio'), playerBlock = $('#playerBlock');
  const playToggle = $('#playToggle'), seekBar = $('#seekBar'), fill = $('#fill'), time = $('#time');
  const toProfileBtn = $('#toProfileBtn'), retakeBtn = $('#retakeBtn');
  let mediaRecorder, recChunks=[], recStream=null, recMime='', recording=false;
  window.__recBlob = null;

  function supportedMime(){ const c=['audio/webm;codecs=opus','audio/mp4;codecs=aac','audio/webm','audio/ogg;codecs=opus','audio/mp4','audio/aac']; for(const t of c){ if(window.MediaRecorder?.isTypeSupported?.(t)) return t; } return ''; }
  async function startRecording(){
    try{
      recMime = supportedMime();
      recStream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(recStream, recMime?{mimeType:recMime}:undefined);
      recChunks = [];
      mediaRecorder.ondataavailable = e => { if(e.data?.size) recChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        window.__recBlob = new Blob(recChunks, { type: recMime || 'audio/webm' });
        const url = URL.createObjectURL(window.__recBlob);
        audioEl.src = url; playerBlock.classList.remove('hidden'); updateTime(0, audioEl.duration || 0);
      };
      mediaRecorder.start(); recording=true; recLabel.innerHTML='<span class="rec-indicator"></span> Recording‚Ä¶';
    }catch(err){ alert('Mic permission needed. Use HTTPS.'); console.error(err); }
  }
  function stopRecording(){ if(mediaRecorder && recording){ mediaRecorder.stop(); recStream?.getTracks().forEach(t=>t.stop()); recording=false; recLabel.textContent='Start Recording'; } }
  recordBtn.addEventListener('click', ()=> recording?stopRecording():startRecording());
  const fmt=s=>{ s=Math.floor(s); const m=Math.floor(s/60), r=s%60; return `${m}:${r.toString().padStart(2,'0')}`; };
  function updateTime(c,d){ time.textContent=`${fmt(c)} / ${d?fmt(d):'0:00'}`; }
  playToggle.addEventListener('click', ()=>{ if(audioEl.paused){ audioEl.play(); playToggle.textContent='‚è∏'; } else { audioEl.pause(); playToggle.textContent='‚ñ∂'; }});
  audioEl.addEventListener('pause', ()=> playToggle.textContent='‚ñ∂');
  audioEl.addEventListener('play', ()=> playToggle.textContent='‚è∏');
  audioEl.addEventListener('timeupdate', ()=>{ const d=audioEl.duration||0, c=audioEl.currentTime||0, pct=d?(c/d)*100:0; fill.style.inset=`0 ${100-pct}% 0 0`; updateTime(c,d); });
  seekBar.addEventListener('click', (e)=>{ const r=seekBar.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; if(audioEl.duration) audioEl.currentTime=x*audioEl.duration; });
  retakeBtn.addEventListener('click', ()=>{ if(!audioEl.paused) audioEl.pause(); playerBlock.classList.add('hidden'); window.__recBlob=null; audioEl.removeAttribute('src'); });
  toProfileBtn.addEventListener('click', ()=>{ if(!window.__recBlob){ alert('Record your pickup line first.'); return; } go(1); });

  /***** PROFILE BUILDER *****/
  const ageSel = $('#age'), heightSel = $('#height');
  (function buildAge(){ const frag=document.createDocumentFragment(); const ph=document.createElement('option'); ph.value=''; ph.textContent='Choose'; ph.disabled=true; ph.selected=true; frag.appendChild(ph); for(let a=18;a<=99;a++){ const o=document.createElement('option'); o.textContent=a; frag.appendChild(o);} ageSel.appendChild(frag);})();
  (function buildHeight(){ const frag=document.createDocumentFragment(); const u=document.createElement('option'); u.textContent='Under 5 feet'; frag.appendChild(u); for(let f=5;f<=7;f++){ for(let i=0;i<12;i++){ const o=document.createElement('option'); o.textContent=`${f}‚Äô${i}‚Äù`; frag.appendChild(o);} } const o7=document.createElement('option'); o7.textContent='Over 7 feet'; frag.appendChild(o7); heightSel.appendChild(frag);})();
  $('#backToRecorder').addEventListener('click', ()=> go(0));

  // ===== PHOTO GRID (reliable previews with object URLs) =====
  const photoGrid = document.getElementById('photoGrid');
  const photoFiles = [null,null,null,null];
  const photoURLs  = [null,null,null,null]; // object URLs for previews (revoke on change/remove)

  photoGrid.querySelectorAll('.photo').forEach(tile=>{
    const input   = tile.querySelector('input[type="file"]');
    const overlay = tile.querySelector('.overlay');
    const idx     = +tile.dataset.idx;

    tile.addEventListener('click', (e)=>{
      if (e.target.classList.contains('change') || e.target.classList.contains('remove')) return;
      input?.click();
    });

    const onPick = ()=>{
      const file = input.files && input.files[0];
      if (!file) return;
      photoFiles[idx] = file;

      if (photoURLs[idx]) { URL.revokeObjectURL(photoURLs[idx]); photoURLs[idx] = null; }
      const url = URL.createObjectURL(file);
      photoURLs[idx] = url;

      let img = tile.querySelector('img');
      if (!img) { img = document.createElement('img'); tile.appendChild(img); }
      img.src = url;

      tile.querySelector('.hint')?.remove();
      overlay.classList.remove('hidden');
    };
    input.addEventListener('change', onPick);
    input.addEventListener('input',  onPick); // extra safety for some mobile browsers

    overlay.querySelector('.change').addEventListener('click', (e)=>{ e.stopPropagation(); input.click(); });
    overlay.querySelector('.remove').addEventListener('click', (e)=>{
      e.stopPropagation();
      photoFiles[idx] = null;
      input.value = '';
      if (photoURLs[idx]) { URL.revokeObjectURL(photoURLs[idx]); photoURLs[idx] = null; }
      tile.querySelector('img')?.remove();
      overlay.classList.add('hidden');
      if (!tile.querySelector('.hint')) {
        const h = document.createElement('div'); h.className='hint'; h.textContent='Tap to add'; tile.appendChild(h);
      }
    });
  });

  /***** SAVE PROFILE ‚Üí Storage + DB *****/
  const storagePaths = {
    line: uid => `lines/${uid}/${Date.now()}.webm`,
    photo: (uid,i,ext) => `profiles/${uid}/photo${i}.${ext}`
  };

  $('#saveProfile').addEventListener('click', async ()=>{
    if(!currentUser){ alert('Connecting‚Ä¶'); return; }
    if(!window.__recBlob){ alert('Record your pickup line first.'); return; }

    const required = { name: $('#name').value.trim(), age: $('#age').value, gender: $('#gender').value, into: $('#into').value };
    if(!required.name || !required.age || !required.gender || !required.into){
      alert('Please complete Name, Age, Gender, and I‚Äôm into.'); return;
    }
    const btn = $('#saveProfile'); const old = btn.textContent; btn.disabled=true; btn.textContent='Saving‚Ä¶';

    try{
      // Upload pickup line
      const lineRef = sRef(storage, storagePaths.line(currentUser.uid));
      await uploadBytes(lineRef, window.__recBlob, {contentType: window.__recBlob.type || 'audio/webm'});
      const lineURL = await getDownloadURL(lineRef);

      // Upload selected photos
      const uploadedPhotoURLs=[];
      for(let i=0;i<photoFiles.length;i++){
        const f=photoFiles[i];
        if(!f){ uploadedPhotoURLs.push(null); continue; }
        const ext=(f.type && f.type.split('/')[1]) || 'jpg';
        const imgRef = sRef(storage, storagePaths.photo(currentUser.uid, i, ext));
        await uploadBytes(imgRef, f, {contentType:f.type || 'image/jpeg'});
        uploadedPhotoURLs.push(await getDownloadURL(imgRef));
      }

      // Gather text inputs (typeahead fields)
      const vocab = document.getElementById('vocabInput').value || 'Prefer not to say';
      const looks = document.getElementById('looksInput').value || 'Prefer not to say';
      const personality = document.getElementById('personalityInput').value || 'Prefer not to say';

      const data = {
        uid: currentUser.uid,
        name: required.name,
        age: required.age,
        height: document.getElementById('height').value || '',
        gender: required.gender,
        into: required.into,
        vocab, looks, personality,
        photos: uploadedPhotoURLs,
        lineURL,
        ts: serverTimestamp()
      };
      await set(rRef(db, `profiles/${currentUser.uid}`), data);
      localStorage.setItem('ll_user_profile', JSON.stringify(data));

      go(2); initDeck();
    }catch(err){ console.error(err); alert('Save failed. Check Firebase config/rules.'); }
    finally{ btn.disabled=false; btn.textContent=old; }
  });

  /***** SWIPE: REAL PROFILES *****/
  const deckEl = $('#deck'); let deck=[], deckIdx=0; window.__deckInit=false;

  function listenProfiles(){
    const pRef = rRef(db, 'profiles');
    onValue(pRef, snap=>{
      const all = snap.val() || {};
      deck = Object.values(all).filter(p => p.uid !== currentUser?.uid && p.lineURL);
      deckIdx = 0; renderCard();
    });
  }
  function initDeck(){ if(window.__deckInit) return; window.__deckInit=true; listenProfiles(); }

  async function renderCard(){
    deckEl.innerHTML='';
    if(!deck.length || deckIdx>=deck.length){
      const empty=document.createElement('div');
      empty.className='card';
      empty.innerHTML=`<h3>${deck.length? 'That‚Äôs all for now' : 'No lines yet'}</h3>
        <div class="small">${deck.length? 'New pickup lines appear as more people join.' : 'Be the first‚Äîshare your link and come back soon.'}</div>`;
      deckEl.appendChild(empty); return;
    }
    const p = deck[deckIdx];
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="small">üéß Voice only. Profiles unlock on a match.</div>
      <div class="rec-wrap">
        <div class="player">
          <button class="play-toggle">‚ñ∂</button>
          <div class="bar"><div class="fill"></div></div>
          <div class="time">0:00</div>
        </div>
        <audio preload="metadata" class="hidden"></audio>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="pass">Pass</button>
        <button class="like">Like</button>
      </div>`;
    deckEl.appendChild(card);

    const audio=card.querySelector('audio'); audio.src=p.lineURL;
    const playBtn=card.querySelector('play-toggle'.replace('play-','.') ); // play-toggle
    const bar=card.querySelector('.bar'); const fill=card.querySelector('.fill'); const tm=card.querySelector('.time');
    const fmt=s=>{ s=Math.floor(s); const m=Math.floor(s/60), r=s%60; return `${m}:${r.toString().padStart(2,'0')}`; };

    card.querySelector('.play-toggle').addEventListener('click', ()=>{ if(audio.paused){ audio.play(); card.querySelector('.play-toggle').textContent='‚è∏'; } else { audio.pause(); card.querySelector('.play-toggle').textContent='‚ñ∂'; }});
    audio.addEventListener('pause', ()=> card.querySelector('.play-toggle').textContent='‚ñ∂');
    audio.addEventListener('play',  ()=> card.querySelector('.play-toggle').textContent='‚è∏');
    audio.addEventListener('timeupdate', ()=>{ const d=audio.duration||0, c=audio.currentTime||0, pct=d?(c/d)*100:0; fill.style.inset=`0 ${100-pct}% 0 0`; tm.textContent=`${fmt(c)} / ${d?fmt(d):'0:00'}`; });
    bar.addEventListener('click',(e)=>{ const r=bar.getBoundingClientRect(); const x=(e.clientX-r.left)/r.width; if(audio.duration) audio.currentTime=x*audio.duration; });

    card.querySelector('.pass').addEventListener('click', ()=>{ audio.pause(); deckIdx++; renderCard(); });
    card.querySelector('.like').addEventListener('click', ()=>{ audio.pause(); handleLike(p.uid); });
  }

  /***** MATCHING *****/
  function pairIdFor(a,b){ return [a,b].sort().join('_'); }

  async function handleLike(themUid){
    const me = currentUser.uid;
    const myLikeRef = rRef(db, `likes/${me}/${themUid}`);
    const theirLikeRef = rRef(db, `likes/${themUid}/${me}`);

    await set(myLikeRef, true);

    const theirLikeSnap = await get(theirLikeRef);
    const matched = !!theirLikeSnap.val();

    if(!matched){ deckIdx++; renderCard(); return; }

    const pid = pairIdFor(me, themUid);
    const pairRef = rRef(db, `pairs/${pid}`);
    const pairSnap = await get(pairRef);

    if(!pairSnap.exists()){
      await set(pairRef, { id: pid, a: me, b: themUid, roomId: pid, ts: serverTimestamp() });
      await set(rRef(db, `rooms/${pid}`), { id: pid, a: me, b: themUid, created: serverTimestamp() });
    }

    const themSnap = await get(rRef(db, `profiles/${themUid}`));
    const them = themSnap.val() || {};
    showMatch(them, pid);
  }

  function showMatch(person, roomId){
    const m = $('#matchModal'); const box = $('#matchProfile');
    const rows = [
      ['Name', person.name], ['Age', person.age], ['Gender', person.gender], ['I‚Äôm into', person.into],
      ['Height', person.height], ['Looks', person.looks], ['Personality', person.personality]
    ].map(([k,v])=>`<div><strong>${k}:</strong> ${v ?? ''}</div>`).join('');
    box.innerHTML = rows;
    m.style.display='flex';
    $('#closeMatch').onclick = ()=>{ m.style.display='none'; deckIdx++; renderCard(); };
    $('#openChat').onclick = ()=>{ m.style.display='none'; openChat(roomId, person); };
  }

  /***** CHAT *****/
  let activeRoom = null; window.__activeRoom = null; let messagesUnsub = null;

  function pushBubble(who, content, type='text'){
    const log = $('#chatLog'); const b=document.createElement('div'); b.className=`bubble ${who}`;
    if(type==='text'){ b.textContent = content; }
    if(type==='image'){ const img=document.createElement('img'); img.src=content; b.appendChild(img); }
    if(type==='audio'){ const a=document.createElement('audio'); a.controls=true; a.src=content; b.appendChild(a); }
    log.appendChild(b); log.scrollTop = log.scrollHeight;
  }

  function openChat(roomId, otherProfile){
    activeRoom = roomId; window.__activeRoom = roomId;
    $('#chatLog').innerHTML='';
    go(3);

    const msgsRef = rRef(db, `rooms/${roomId}/messages`);
    if(messagesUnsub) messagesUnsub();
    messagesUnsub = onValue(msgsRef, snap=>{
      $('#chatLog').innerHTML='';
      const msgs = snap.val() || {};
      Object.entries(msgs).forEach(([,m])=>{
        const who = m.from === currentUser.uid ? 'me' : 'them';
        if(m.type==='text') pushBubble(who, m.text, 'text');
        if(m.type==='image') pushBubble(who, m.url, 'image');
        if(m.type==='audio') pushBubble(who, m.url, 'audio');
      });
      $('#chatLog').scrollTop = $('#chatLog').scrollHeight;
    });

    if(otherProfile?.name) setTimeout(()=> pushBubble('them', `Loved your line. Now that we matched, hi‚ÄîI‚Äôm ${otherProfile.name}.`), 600);
  }

  $('#chatSendBtn').addEventListener('click', async ()=>{
    const roomId = activeRoom; if(!roomId) return;
    const input=$('#chatInput'); const text=input.value.trim(); if(!text) return;
    input.value='';
    const msgRef = push(rRef(db, `rooms/${roomId}/messages`));
    await set(msgRef, { from: currentUser.uid, type:'text', text, ts: serverTimestamp() });
  });

  $('#chatPhotoBtn').addEventListener('click', ()=> $('#chatPhoto').click());
  $('#chatPhoto').addEventListener('change', async ()=>{
    const roomId = activeRoom; if(!roomId) return;
    const f = $('#chatPhoto').files?.[0]; if(!f) return;
    const ext=(f.type && f.type.split('/')[1]) || 'jpg';
    const ref = sRef(storage, `chats/${roomId}/images/${Date.now()}.${ext}`);
    await uploadBytes(ref, f, {contentType:f.type || 'image/jpeg'});
    const url = await getDownloadURL(ref);
    const msgRef = push(rRef(db, `rooms/${roomId}/messages`));
    await set(msgRef, { from: currentUser.uid, type:'image', url, ts: serverTimestamp() });
  });

  let chatRec=null, chatChunks=[], chatStream=null, chatMime='';
  $('#chatVoiceBtn').addEventListener('click', async (e)=>{
    const btn = e.currentTarget; const roomId = activeRoom; if(!roomId) return;
    if(!chatRec){
      try{
        chatMime = supportedMime();
        chatStream = await navigator.mediaDevices.getUserMedia({audio:true});
        chatRec = new MediaRecorder(chatStream, chatMime?{mimeType:chatMime}:undefined);
        chatChunks = [];
        chatRec.ondataavailable = ev => { if(ev.data?.size) chatChunks.push(ev.data); };
        chatRec.onstop = async ()=>{
          const blob=new Blob(chatChunks,{type:chatMime||'audio/webm'});
          const ref = sRef(storage, `chats/${roomId}/voice/${Date.now()}.webm`);
          await uploadBytes(ref, blob, {contentType: blob.type || 'audio/webm'});
          const url = await getDownloadURL(ref);
          const msgRef = push(rRef(db, `rooms/${roomId}/messages`));
          await set(msgRef, { from: currentUser.uid, type:'audio', url, ts: serverTimestamp() });
        };
        chatRec.start(); btn.textContent='‚èπÔ∏è';
      }catch(err){ alert('Mic access needed.'); console.error(err); chatRec=null; chatStream?.getTracks().forEach(t=>t.stop()); }
    }else{
      chatRec.stop(); chatStream?.getTracks().forEach(t=>t.stop()); chatRec=null; btn.textContent='üéôÔ∏è';
    }
  });

  /***** START *****/
  go(0);
</script>
</body>
</html>