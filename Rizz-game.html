<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rizzler ‚Äî Audio Dating</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--blue:#064D95;--green:#06954E;--red:#c40018}
  *{box-sizing:border-box}
  body{margin:0;background:#000;color:#fff;font-family:'Montserrat',sans-serif}
  .wrap{max-width:820px;margin:0 auto;padding:16px}

  /* Top logo */
  .logo{display:block;margin:10px auto 16px auto; width:160px; height:auto}

  /* Section cards (no borders) */
  .section{background:#0f0f0f;border-radius:14px;padding:16px;margin:14px 0; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:6px 0 10px; font-size:1.6rem; text-align:center}
  h2{margin:.4rem 0 10px; font-size:1.15rem}

  /* Vertical field stack */
  .field{margin:10px 0}
  .field label{display:block;margin:0 0 6px 2px; font-weight:600}
  input[type="text"], select{
    width:100%; padding:14px 12px; border-radius:12px; border:1px solid #2a2a2a;
    background:#151515; color:#fff; font-size:16px;
    -webkit-appearance:none; appearance:none; touch-action:manipulation;
  }

  /* Buttons */
  button{padding:14px 16px;border:none;border-radius:26px;color:#fff;background:#333;cursor:pointer;margin:8px 8px 0 0;font-size:16px;transition:transform .12s}
  button:hover{transform:scale(1.03)}
  .btn-green{background:var(--green)} .btn-blue{background:var(--blue)} .btn-red{background:var(--red)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .muted{opacity:.85}

  /* Audio */
  audio{width:100%;margin:10px 0;background:#000}

  /* Photos: four square slots with live preview */
  .photos{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:540px){ .photos{grid-template-columns:repeat(2,1fr)} }
  .slot{position:relative;aspect-ratio:1;border:1px dashed #444;border-radius:10px;background:#1a1a1a;
        display:flex;align-items:center;justify-content:center;color:#aaa;cursor:pointer;overflow:hidden}
  .slot input{position:absolute; inset:0; width:100%; height:100%; opacity:0}
  .slot img{width:100%;height:100%;object-fit:cover}
  .slot .rm{position:absolute;top:8px;right:8px;width:26px;height:26px;border-radius:50%;background:rgba(0,0,0,.65);
            display:flex;align-items:center;justify-content:center;font-weight:700}

  /* Browse / matches / chat */
  #tabs{display:flex;gap:8px;justify-content:center;margin:8px 0}
  #tabs button.active{outline:2px solid #777}
  #matches-list{max-height:260px;overflow:auto;border-radius:10px;padding:8px;background:#0e0e0e}
  .match-item{padding:10px;border-radius:10px;background:#171717;margin:6px 0;cursor:pointer}

  #chat{max-height:360px;overflow:auto;border-radius:10px;background:#0e0e0e;padding:10px}
  .bubble{display:inline-block;max-width:78%;padding:9px 11px;margin:6px 0;border-radius:12px;animation:fade .2s ease-out}
  .me{background:var(--green);margin-left:auto} .them{background:var(--blue);margin-right:auto}
  .bubble img{max-width:220px;border-radius:10px;display:block}
  @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

  #status{min-height:1.3em;margin:8px 2px 4px}
  #status.ok{color:#9bffa6} #status.err{color:#ff7b86}
  #feed-none{display:none;text-align:center;margin-top:10px;opacity:.85}
</style>
</head>
<body>
<div class="wrap">

  <!-- Logo -->
  <img class="logo" src="./golden-le-libido-logo.png" alt="Le Libido">

  <h1>Rizzler ‚Äî Audio Dating</h1>

  <!-- Step 1: record line -->
  <div class="section" id="step-record">
    <h2>1) Record your pick-up line</h2>
    <div class="row">
      <button id="rec-toggle" class="btn-green">üéôÔ∏è Start recording</button>
      <button id="upload-line" class="btn-blue" disabled>Upload line</button>
      <span id="rec-hint" class="muted">Tap to start; tap again to stop.</span>
    </div>
    <audio id="line-preview" controls hidden></audio>
  </div>

  <!-- Step 2: profile (single column) -->
  <div class="section" id="step-profile">
    <h2>2) Build your profile</h2>

    <div class="field"><label>Name</label><input id="p_name" type="text" placeholder="Your display name"></div>
    <div class="field"><label>Age</label><select id="p_age"></select></div>
    <div class="field"><label>Height</label><select id="p_height"></select></div>
    <div class="field">
      <label>Gender</label>
      <select id="p_gender">
        <option value="" disabled selected>Select</option>
        <option>Man</option><option>Woman</option><option>Non-binary</option><option>Other</option>
      </select>
    </div>
    <div class="field">
      <label>Sexual Orientation (who you want to hear)</label>
      <select id="p_orientation">
        <option value="" disabled selected>Select</option>
        <option value="Women">Women</option><option value="Men">Men</option><option value="Both">Both</option>
      </select>
    </div>
    <div class="field">
      <label>Turn-on Vocabulary</label>
      <select id="p_vocab">
        <option value="" disabled selected>Select</option>
        <option>Prefer not to say</option><option>babe</option><option>baby</option><option>sexy</option>
        <option>fucker</option><option>brat</option><option>good boy</option><option>good girl</option>
        <option>Goddess</option><option>master</option>
      </select>
    </div>
    <div class="field">
      <label>My Type (Looks)</label>
      <select id="p_looks">
        <option value="" disabled selected>Select</option>
        <option>Prefer not to say</option>
        <option>Tall</option><option>Short</option><option>Thin & lean</option><option>Curvy & voluptuous</option>
        <option>Muscular</option><option>Tan</option><option>Pale</option><option>Brunette</option><option>Blonde</option>
        <option>Latin</option><option>Asian</option><option>Black</option><option>Jewish</option><option>Indian</option><option>Middle Eastern</option>
      </select>
    </div>
    <div class="field">
      <label>My Type (Personality)</label>
      <select id="p_personality">
        <option value="" disabled selected>Select</option>
        <option>Prefer not to say</option>
        <option>Confident & powerful</option><option>Funny & witty</option><option>Smart & sophisticated</option>
        <option>Flirty & provocative</option><option>Extroverted & friendly</option><option>Introverted & thoughtful</option>
        <option>Athletic & sporty</option><option>Organized & orderly</option><option>Silly & goofy</option>
      </select>
    </div>
    <div class="field">
      <label>Fantasies</label>
      <select id="p_fantasies">
        <option value="" disabled selected>Select</option>
        <option>Prefer not to say</option>
        <option>Sex on the beach</option><option>Candlelit bath</option><option>Erotic massage</option>
        <option>Mile High Club</option><option>Skinny dipping</option><option>Role-play</option>
        <option>Light bondage</option><option>Sensory play</option><option>Impact play</option><option>Erotic hypnosis</option>
      </select>
    </div>

    <!-- photos -->
    <div class="field"><label>Photos (4)</label>
      <div class="photos" id="photoGrid">
        <label class="slot"><span>+ Photo</span><input type="file" accept="image/*"></label>
        <label class="slot"><span>+ Photo</span><input type="file" accept="image/*"></label>
        <label class="slot"><span>+ Photo</span><input type="file" accept="image/*"></label>
        <label class="slot"><span>+ Photo</span><input type="file" accept="image/*"></label>
      </div>
    </div>

    <div class="row">
      <button id="save-profile" class="btn-green">Save Profile</button>
      <span class="muted">Upload line first, then save.</span>
    </div>
  </div>

  <!-- Step 3: Browse / Matches / Chat -->
  <div class="section" id="step-browse" hidden>
    <div id="tabs">
      <button id="tab-browse" class="btn-blue active">Browse</button>
      <button id="tab-matches" class="btn-blue">Matches</button>
    </div>

    <!-- Browse -->
    <div id="browse-pane">
      <audio id="card-audio" controls></audio>
      <div id="card-meta" class="muted"></div>
      <div class="row" style="justify-content:center">
        <button id="pass" class="btn-red">Pass</button>
        <button id="like" class="btn-green">Like</button>
        <button id="next" class="btn-blue">Next</button>
      </div>
      <div id="feed-none">No more lines for now.</div>
    </div>

    <!-- Matches -->
    <div id="matches-pane" hidden>
      <div id="matches-list"></div>
    </div>

    <!-- Chat -->
    <div id="chat-pane" hidden>
      <h2 id="chat-title">Chat</h2>
      <div id="chat"></div>
      <div class="row">
        <input id="msg" type="text" placeholder="Type a message‚Ä¶" style="flex:1;min-width:180px">
        <button id="send" class="btn-green">Send</button>
        <input id="photo" type="file" accept="image/*" hidden>
        <button id="send-photo" class="btn-blue">üì∑ Photo</button>
        <button id="send-voice" class="btn-blue">üéôÔ∏è Voice</button>
      </div>
      <div class="row"><button id="back-to-matches" class="btn-blue">‚Üê Back to Matches</button></div>
    </div>
  </div>

  <div id="status" class="muted">Initializing‚Ä¶</div>
</div>

<script type="module">
/* ========= Imports ========= */
import { app, db } from './firebase-config.js';
import {
  getAuth, signInAnonymously, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import {
  ref, set, update, get, push, onValue, onChildAdded, serverTimestamp,
  query, orderByChild, limitToLast
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

/* ========= Setup ========= */
const auth = getAuth(app);
const storage = getStorage(app);
const $ = s => document.querySelector(s);
const setStatus = (t,cls='')=>{ const el=$('#status'); el.textContent=t||''; el.className=cls; };

/* ========= State ========= */
let my = { uid:null, name:'' };
let lineRec=null, lineChunks=[], lineStream=null, lineMime='audio/webm';
let myLineUrl=null, myLineUploaded=false;

let photoFiles = [null,null,null,null];
let photoUrls  = [null,null,null,null];

let feed=[], feedPos=-1, currentCard=null;
let myProfile=null;
let currentMatchId=null, chatUnsub=null;

/* ========= Auth (anonymous) ========= */
onAuthStateChanged(auth, (user)=>{
  if (user){ my.uid=user.uid; setStatus('Signed in (anonymous).','ok'); initUI(); }
  else { signInAnonymously(auth).catch(console.error); }
});

/* ========= UI init ========= */
function initUI(){
  // Age 18..80
  const ageSel=$('#p_age'); for(let i=18;i<=80;i++){ const o=document.createElement('option'); o.value=i; o.textContent=i; ageSel.appendChild(o); }
  // Height 4'0" .. 7'0"
  const hSel=$('#p_height'); for(let ft=4;ft<=7;ft++){ for(let inch=0;inch<12;inch++){ if(ft===7&&inch>0) break; const lab=`${ft}'${inch}"`; const o=document.createElement('option'); o.value=lab; o.textContent=lab; hSel.appendChild(o); } }

  // Photo handlers
  [...document.querySelectorAll('#photoGrid .slot')].forEach((slot,idx)=>{
    const input=slot.querySelector('input[type=file]');
    // Tap anywhere opens immediately (no double-tap)
    slot.addEventListener('click', (e)=>{ if (e.target.classList.contains('rm')) return; input.click(); }, {passive:true});
    input.addEventListener('click', e=>e.stopPropagation()); // ensure first tap focuses file dialog
    input.addEventListener('change', ()=>{
      const f=input.files?.[0]; if(!f) return;
      photoFiles[idx]=f;
      slot.innerHTML='';
      const img=document.createElement('img'); img.src=URL.createObjectURL(f);
      const rm=document.createElement('div'); rm.textContent='√ó'; rm.className='rm';
      rm.addEventListener('click', ev=>{ ev.stopPropagation(); photoFiles[idx]=null; photoUrls[idx]=null; slot.innerHTML='<span>+ Photo</span>'; slot.appendChild(input); });
      slot.appendChild(img); slot.appendChild(rm); slot.appendChild(input);
    });
  });

  // Recorder buttons
  $('#rec-toggle').addEventListener('click', toggleRecord, {passive:true});
  $('#upload-line').addEventListener('click', uploadLine);
  // Save profile
  $('#save-profile').addEventListener('click', saveProfile);
  // Tabs
  $('#tab-browse').addEventListener('click', ()=>showTab('browse'));
  $('#tab-matches').addEventListener('click', ()=>showTab('matches'));
  // Browse controls
  $('#next').addEventListener('click', nextCard);
  $('#pass').addEventListener('click', async ()=>{
    if (!currentCard) return; await set(ref(db, `passes/${my.uid}/${currentCard.uid}`), true); nextCard();
  });
  $('#like').addEventListener('click', likeCurrent);
  // Chat controls
  $('#send').addEventListener('click', sendText);
  $('#send-photo').addEventListener('click', ()=>$('#photo').click());
  $('#photo').addEventListener('change', sendPhoto);
  $('#send-voice').addEventListener('click', sendVoiceMemo);
  $('#back-to-matches').addEventListener('click', ()=>showTab('matches'));

  setStatus('Ready. Record your line to begin.','ok');
}

/* ========= Recording ========= */
function pickMime(){
  const t=['audio/mp4','audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus'];
  for (const x of t) if (window.MediaRecorder?.isTypeSupported?.(x)) return x;
  return '';
}
async function toggleRecord(){
  if (!lineRec || lineRec.state==='inactive'){
    try{
      const s = await navigator.mediaDevices.getUserMedia({audio:true});
      lineStream=s; lineChunks=[]; const mt=pickMime(); lineMime=mt||'audio/webm';
      lineRec = new MediaRecorder(s, mt?{mimeType:mt}:{});
      lineRec.ondataavailable=e=>{ if (e.data && e.data.size) lineChunks.push(e.data); };
      lineRec.onstop=()=>{
        lineStream.getTracks().forEach(t=>t.stop());
        const blob=new Blob(lineChunks,{type:lineRec.mimeType||lineMime});
        $('#line-preview').hidden=false; $('#line-preview').src=URL.createObjectURL(blob);
        $('#upload-line').disabled=false;
        setStatus('Ready to upload your line.','ok');
      };
      lineRec.start(100);
      $('#rec-toggle').textContent='‚èπÔ∏è Stop';
      setStatus('Recording‚Ä¶');
    }catch(e){ setStatus('Microphone blocked ‚Äî enable permissions.', 'err'); }
  }else{
    lineRec.stop(); $('#rec-toggle').textContent='üéôÔ∏è Start recording';
  }
}

/* ========= Upload line (with ensured auth) ========= */
async function uploadLine(){
  if (!lineChunks.length){ setStatus('Record first.','err'); return; }
  try{
    if (!auth.currentUser) { await signInAnonymously(auth); }  // ensure signed-in
    setStatus('Uploading line‚Ä¶');
    const blob = new Blob(lineChunks, { type: lineMime });
    const key  = `${(my.uid||auth.currentUser.uid)}-${Date.now()}.webm`;
    const r    = sRef(storage, `lines/${(my.uid||auth.currentUser.uid)}/${key}`);

    await uploadBytes(r, blob, { contentType: lineMime });
    const url = await getDownloadURL(r);

    myLineUrl = url;
    await set(ref(db, `lines/${(my.uid||auth.currentUser.uid)}`), {
      uid: (my.uid||auth.currentUser.uid),
      name: ($('#p_name').value || 'Rizzler'),
      url,
      mime: lineMime,
      ts: serverTimestamp()
    });

    myLineUploaded = true;
    setStatus('Line uploaded. Now finish profile.','ok');
  }catch(err){
    console.error(err);
    const msg = (err && err.code) ? ` (${err.code})` : '';
    setStatus('Upload failed. Check Storage rules & bucket name'+msg+'.','err');
  }
}

/* ========= Save Profile ========= */
async function saveProfile(){
  const name = ($('#p_name').value||'').trim();
  const